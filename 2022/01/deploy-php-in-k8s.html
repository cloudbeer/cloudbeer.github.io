<!DOCTYPE html>
<html lang=" en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>phpåº”ç”¨å®¹å™¨åŒ–éƒ¨ç½²å®è·µ | YouBug</title>
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="phpåº”ç”¨å®¹å™¨åŒ–éƒ¨ç½²å®è·µ" />
<meta name="author" content="å•¤é…’äº‘" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="ç›®å‰å¸‚åœºä¸Š php ä»æœ‰ä¸€å¸­ä¹‹åœ°ã€‚æœ¬æ–‡æ¢è®¨å¦‚ä½•å°† php åº”ç”¨å®¹å™¨åŒ–å¹¶è¿ç§»éƒ¨ç½²åˆ° K8Sã€‚" />
<meta property="og:description" content="ç›®å‰å¸‚åœºä¸Š php ä»æœ‰ä¸€å¸­ä¹‹åœ°ã€‚æœ¬æ–‡æ¢è®¨å¦‚ä½•å°† php åº”ç”¨å®¹å™¨åŒ–å¹¶è¿ç§»éƒ¨ç½²åˆ° K8Sã€‚" />
<link rel="canonical" href="https://youbug.cn/2022/01/deploy-php-in-k8s.html" />
<meta property="og:url" content="https://youbug.cn/2022/01/deploy-php-in-k8s.html" />
<meta property="og:site_name" content="YouBug" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-21T02:56:53+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="phpåº”ç”¨å®¹å™¨åŒ–éƒ¨ç½²å®è·µ" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"å•¤é…’äº‘"},"dateModified":"2022-01-21T02:56:53+00:00","datePublished":"2022-01-21T02:56:53+00:00","description":"ç›®å‰å¸‚åœºä¸Š php ä»æœ‰ä¸€å¸­ä¹‹åœ°ã€‚æœ¬æ–‡æ¢è®¨å¦‚ä½•å°† php åº”ç”¨å®¹å™¨åŒ–å¹¶è¿ç§»éƒ¨ç½²åˆ° K8Sã€‚","headline":"phpåº”ç”¨å®¹å™¨åŒ–éƒ¨ç½²å®è·µ","mainEntityOfPage":{"@type":"WebPage","@id":"https://youbug.cn/2022/01/deploy-php-in-k8s.html"},"url":"https://youbug.cn/2022/01/deploy-php-in-k8s.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://youbug.cn/feed.xml" title="YouBug" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-B4DC7SCVXM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-B4DC7SCVXM');
</script><script>
  console.log("You means 'have', YouBug means 'There is a bug'."); 
</script>
<link rel="icon"
  href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ</text></svg>"></head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">â˜ğŸ YouBug </a><nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path
              d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>

      <div class="trigger">

        <a class="page-link" href="/aiml/">AI/ML</a>
        <a class="page-link" href="/container/">å®¹å™¨</a>
        <a class="page-link" href="/devops/">DevOps</a>
        <a class="page-link" href="/observability/">å¯è§‚æµ‹</a>
        <a class="page-link" href="/iac/">IaC</a>
        <a class="page-link" href="/aws/">AWS</a>
        <a class="page-link" href="/data/">æ•°æ®</a>
        <a class="page-link" href="/tucao/">åæ§½</a>

      </div>
    </nav></div>
</header><main class="page-content" aria-label="Content">
    <div class="wrapper">
      <style>
  pre.highlight {
    position: relative;
    padding-top: 20px;
    padding-bottom: 20px
  }

  pre.highlight>button {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    opacity: 0;
  }

  pre.highlight:hover>button {
    opacity: 1;
  }

  pre.highlight:hover>button:hover {
    border: solid 1px #666;
    background-color: #111;
    color: #00ff00;
  }

  pre.highlight>button:active,
  pre.highlight>button:focus {
    opacity: 1;
  }
</style>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">phpåº”ç”¨å®¹å™¨åŒ–éƒ¨ç½²å®è·µ</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2022-01-21T02:56:53+00:00" itemprop="datePublished">2022-01-21
      </time>â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card"
          itemprop="name">å•¤é…’äº‘</span></span></p></header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>ç›®å‰å¸‚åœºä¸Š php ä»æœ‰ä¸€å¸­ä¹‹åœ°ã€‚æœ¬æ–‡æ¢è®¨å¦‚ä½•å°† php åº”ç”¨å®¹å™¨åŒ–å¹¶è¿ç§»éƒ¨ç½²åˆ° K8Sã€‚</p>

<h2 id="php-åº”ç”¨é•œåƒå‡†å¤‡">php åº”ç”¨é•œåƒå‡†å¤‡</h2>

<p>é•œåƒçš„å±‚æ¬¡ï¼šåŸºç¡€ä¾èµ–é•œåƒ-&gt;è¿è¡Œæ¡†æ¶-&gt;åº”ç”¨/ä»£ç é•œåƒ</p>

<p>åŸºäºå®¹å™¨çš„å•è¿›ç¨‹è¿è¡Œç†å¿µï¼Œä¸‹é¢çš„éƒ¨ç½²è¿‡ç¨‹å¹¶æœªä½¿ç”¨å•ä½“çš„ nginx+php-fpm ä¸€ä½“çš„å®¹å™¨è¿è¡Œæ–¹å¼ï¼Œè€Œæ˜¯å°† php-fpm å’Œ nginx æ‹†æ•£ã€‚</p>

<h3 id="åŸºç¡€é•œåƒ">åŸºç¡€é•œåƒ</h3>

<p>å®‰è£…åŸºç¡€ç³»ç»Ÿä¾èµ–åŒ…å’Œå…¬å¸ php åº”ç”¨ä¸­å„ä¸ªå¼€å‘å°ç»„éƒ½ä¼šç”¨åˆ°çš„æ‰©å±•åŒ…ã€‚</p>

<p>ä¸‹é¢çš„ç¤ºä¾‹åŸºäºå®˜æ–¹ fpmï¼Œå®‰è£…äº†é€šç”¨ç³»ç»Ÿçº§çš„ä¾èµ–å’Œ php åŒ…ç®¡ç†å™¨ã€‚</p>

<p>å¦‚æœå¯ä»¥ï¼Œå»ºè®®ä½¿ç”¨æ›´åŸºç¡€çš„é•œåƒä» php æºç è¿›è¡Œç¼–è¯‘ã€‚</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># runtime.Dockerfile</span>
<span class="k">FROM</span><span class="s"> php:8.0.3-fpm</span>

<span class="c"># è‡ªå®šä¹‰ç±»åº“ç¤ºä¾‹</span>
<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get <span class="nb">install</span> <span class="nt">-y</span> git zlib1g-dev libpng-dev libicu-dev
<span class="k">RUN </span>docker-php-ext-install <span class="se">\
</span>    gd <span class="se">\
</span>    intl
<span class="k">RUN </span>docker-php-ext-configure intl


<span class="c"># å®‰è£… composer</span>
<span class="k">RUN </span>curl <span class="nt">-sS</span> https://getcomposer.org/installer | php <span class="nt">--</span> <span class="se">\
</span>    <span class="nt">--install-dir</span><span class="o">=</span>/usr/local/bin <span class="nt">--filename</span><span class="o">=</span>composer <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chmod</span> +x /usr/local/bin/composer 
</code></pre></div></div>

<p>å°†ä¸Šè¿°æ–‡ä»¶ç¼–è¯‘æˆé•œåƒï¼Œå¹¶ push åˆ°ä»“åº“ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> cloudbeer/php-runtime:1.0 <span class="nt">-f</span> runtime.Dockerfile <span class="nb">.</span>
docker push cloudbeer/php-runtime:1.0
</code></pre></div></div>

<h3 id="åº”ç”¨å±‚æ¡†æ¶é•œåƒ">åº”ç”¨å±‚æ¡†æ¶é•œåƒ</h3>

<p>å¦‚æœå¼€å‘æ¡†æ¶æ¯”è¾ƒç¨³å®šï¼Œå»ºè®®ç›´æ¥æŠŠæ¡†æ¶æ‰“åŒ…æˆåŸºç¡€é•œåƒä»¥é¿å…åç»­éƒ¨ç½²è¿‡ç¨‹ä¸­é¢‘ç¹å®‰è£…ä¾èµ–åŒ…ï¼ŒåŠ é€Ÿå‘å¸ƒæ‰“åŒ…å‘å¸ƒè¿‡ç¨‹ï¼Œå¦‚ä¸šåŠ¡å¼€å‘Aç»„ä½¿ç”¨äº† lumen æ¡†æ¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸“é—¨ä¸º lumen æ‰“ä¸€ä¸ªé•œåƒã€‚</p>

<p>å¦‚ä¸‹é•œåƒï¼Œå®‰è£…äº† lumen web æ¡†æ¶ã€‚</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># lumen.Dockerfile</span>
<span class="k">FROM</span><span class="s"> cloudbeer/php-runtime:1.0</span>

<span class="k">RUN </span><span class="nb">mkdir</span> /app
<span class="k">WORKDIR</span><span class="s"> /app</span>

<span class="k">RUN </span><span class="nb">echo</span> <span class="s1">'{</span><span class="se">\
</span><span class="s1">    "require": {</span><span class="se">\
</span><span class="s1">    "php": "^7.3|^8.0",</span><span class="se">\
</span><span class="s1">    "laravel/lumen-framework": "^8.0"</span><span class="se">\
</span><span class="s1">    }</span><span class="se">\
</span><span class="s1"> }'</span> <span class="o">&gt;</span> composer.json

<span class="k">RUN </span>composer i
</code></pre></div></div>

<p>ä¸Šè¿°é•œåƒæ‰“åŒ…ä¸ºï¼šcloudbeer/my-lumen:1.0</p>

<h3 id="åº”ç”¨å±‚é•œåƒ">åº”ç”¨å±‚é•œåƒ</h3>

<p>ç”±äºæˆ‘ä»¬åœ¨åº”ç”¨å±‚æ¡†æ¶é‡Œå·²ç»æŠŠ lumen è¿è¡Œæ—¶éƒ½å®‰è£…å¥½äº†ï¼Œæ‰€ä»¥è¿™ä¸ªé•œåƒé‡Œï¼Œåªéœ€æ‹·è´çº¯æºç å³å¯ã€‚è®°å¾—åˆ›å»º .gitignore æˆ–è€… .dockerignore æ–‡ä»¶ï¼Œæ’é™¤ venderï¼Œtest ç­‰ç›®å½•ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># .dockerignore</span>
/vendor
/tests
/.idea
/.git
.gitignore
Dockerfile
Homestead.json
Homestead.yaml
.env
.ent.example
.phpunit.result.cache
</code></pre></div></div>

<p>åº”ç”¨é•œåƒé‡Œåªéœ€è¦æ‹·è´è„šæœ¬æ–‡ä»¶å³å¯ã€‚è¿™ä¸ªé•œåƒåŒ…å«äº†å®Œæ•´çš„ php è¿è¡Œæ—¶å’Œä¸šåŠ¡ä»£ç ï¼Œå¯åŠ¨åå¯ä»¥ç›´æ¥æ¥æ”¶ fastcgi è°ƒç”¨ã€‚</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> cloudbeer/my-lumen:1.0</span>
<span class="k">COPY</span><span class="s"> ./ /app/</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„é•œåƒæ‰“åŒ…ä¸ºï¼š cloudbeer/php-caculate:1.0</p>

<p>å¦ä¸€ç§æ‰“åŒ…ä»£ç æ–¹å¼ï¼Œæˆ‘ä»¬ä½¿ç”¨çº¯çš„å®¹å™¨å°†æºä»£ç æ‰“åŒ…ï¼Œåé¢ä¼šåœ¨ K8S ä¸­éƒ¨ç½²æ—¶å°†æ–‡ä»¶æ‹·è´åˆ°æ¡†æ¶è¿è¡Œæ—¶å®¹å™¨ä¸­è¿è¡Œã€‚</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> debian:buster-slim</span>
<span class="k">RUN </span><span class="nb">mkdir</span> /app
<span class="k">COPY</span><span class="s"> ./ /app/</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„é•œåƒæ‰“åŒ…ä¸ºï¼š cloudbeer/php-caculate-purecode:1.0</p>

<p>ä»£ç å±‚åœ¨è¿˜å¯ä»¥æœ‰æ›´å¤šçš„æ‰“åŒ…æ–¹å¼ï¼Œå¦‚ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨é‡Œï¼Œæˆ–è€…ä½¿ç”¨ NFS å­˜å‚¨ï¼ŒåæœŸç»‘å®šåˆ°å®¹å™¨è¿è¡Œæ—¶è¿è¡Œã€‚</p>

<h3 id="æœ¬åœ°æµ‹è¯•">æœ¬åœ°æµ‹è¯•</h3>

<p>å¯åŠ¨é•œåƒ cloudbeer/php-caculate:1.0</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-it</span> cloudbeer/php-caculate:1.0 sh

<span class="c"># å®¹å™¨å†…è¿è¡Œ</span>
<span class="c"># å¯åŠ¨ php æµ‹è¯•</span>
php <span class="nt">-S</span> localhost:8000 <span class="nt">-t</span> public &amp;
<span class="c"># æŸ¥çœ‹ç»“æœ</span>
curl http://localhost:8000/cpu
</code></pre></div></div>

<p>å®Œç¾è¿è¡Œã€‚</p>

<p>ç›®å‰å·²ç»å®Œæˆäº†åº”ç”¨é•œåƒæ‰“åŒ…ã€‚å…¶ä¸­å‰ä¸¤å±‚é•œåƒå¯ä»¥å¤ç”¨ï¼ŒçœŸæ­£çš„ä¸šåŠ¡åº”ç”¨åªéœ€æ‹·è´ä»£ç ã€‚</p>

<p>ä¸Šè¿°ä»£ç ä¸­çš„é•œåƒï¼Œæˆ‘å‡å·²æ‰“åŒ…ä¸Šä¼ åˆ° docker hub å®˜ç½‘ï¼Œå¯ä»¥å¿½ç•¥ build å’Œ push è¿‡ç¨‹ï¼Œç›´æ¥è¿›è¡Œæµ‹è¯•ã€‚</p>

<h2 id="éƒ¨ç½²åˆ°-k8s">éƒ¨ç½²åˆ° K8S</h2>

<p>php åº”ç”¨éƒ¨ç½²åˆ°å®¹å™¨ç¯å¢ƒï¼Œæœ€è‡ªç„¶çš„ä¸€ç§æ–¹å¼æ˜¯ï¼šç›´æ¥å°† php çš„è¿è¡Œç¯å¢ƒå’Œ web server ä»¥åŠä¸šåŠ¡æºä»£ç æ‰“åŒ…æ”¾åœ¨ä¸€ä¸ªå®¹å™¨ä¸­è¿è¡Œã€‚è¿™ä¸ªæ–¹å¼æ˜¯æœ€ç®€å•çš„æ–¹å¼ï¼Œphp å®˜æ–¹ä¹Ÿæä¾›äº† php:nginx è¿™ç§é•œåƒåº•åŒ…ã€‚</p>

<p>ä½† php è¿è¡Œæ—¶å’Œ web server æ˜¯åœ¨ä¸¤ä¸ªè¿›ç¨‹ä¸­è¿è¡Œï¼Œè¿™ä¸ªä¸ç¬¦åˆå®¹å™¨çš„æœ€ä½³å®è·µã€‚ä¸€èˆ¬å»ºè®®å°†è¿™ä¸¤ä¸ªè¿›ç¨‹åˆ†åˆ«è¿è¡Œåœ¨ä¸åŒçš„å®¹å™¨ä¸­ã€‚</p>

<h3 id="nginx-ä½œä¸º-sidecar-è¿è¡Œ">nginx ä½œä¸º sidecar è¿è¡Œ</h3>

<p>K8S åœ¨åŒä¸€ä¸ª pod ä¸­ï¼Œå¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ã€‚æˆ‘ä»¬å°† php-fpm çš„ä¸šåŠ¡ä»£ç éƒ¨ç½²åœ¨ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œä¸ä¹‹ç›¸ä¼´ç”Ÿçš„æœ‰ä¸€ä¸ª nginx å®¹å™¨ï¼Œnginx ä½œä¸ºfastcgiçš„è°ƒç”¨æ–¹ï¼Œå¹¶å¯ä»¥ä»£ç†ä¸€äº›é™æ€èµ„æºï¼Œè¿™ä¸ªæ¨¡å¼ç±»ä¼¼ mesh çš„sidecar æ¨¡å¼ã€‚æ¶æ„å›¾å¦‚ä¸‹ï¼š</p>

<p><img src="https://github.com/cloudbeer/php-best-practice/blob/main/readme-img/sidecar.jpg?raw=true" alt="nginx ä½œä¸º sidecar éƒ¨ç½²" /></p>

<h4 id="nginx-é…ç½®">nginx é…ç½®</h4>

<p>ç”±äº nginx å’Œ php-fpm åœ¨ä¸€ä¸ª pod ä¸­ï¼Œæ‰€ä»¥åªéœ€å‘èµ· localhost è°ƒç”¨å³å¯ã€‚ nginx çš„é…ç½®å¦‚ä¸‹ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªé…ç½®å†™åˆ° cm ä¸­ï¼Œåé¢é€šè¿‡ volume ç»‘å®šåˆ°å®¹å™¨ä¸­ã€‚è¿™ä¸ªé…ç½®æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„çš„ï¼š</p>

<ul>
  <li>åº”ç”¨ä½¿ç”¨äº† lumen çš„ route ä½“ç³»ï¼Œæ‰€ä»¥éœ€è¦å°†è·¯ç”±é€šè¿‡ try_files å…¨éƒ¨æŒ‡å‘ ./public/index.php æ–‡ä»¶ã€‚</li>
  <li>fastcgi_param  SCRIPT_FILENAME  /app/public/index.php è¿™é‡Œä¹Ÿå°†æ‰€æœ‰è„šæœ¬æŒ‡å‘è¿™ä¸ªæ–‡ä»¶ã€‚</li>
</ul>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># nginx config</span>
<span class="k">apiVersion:</span> <span class="s">v1</span>
<span class="s">kind:</span> <span class="s">ConfigMap</span>
<span class="s">metadata:</span>
    <span class="s">name:</span> <span class="s">caculate-sidecar-config</span>
    <span class="s">namespace:</span> <span class="s">php-test</span>
<span class="s">data:</span>
    <span class="s">config:</span> <span class="s">|-</span>
      <span class="s">server</span> <span class="p">{</span>
          <span class="kn">listen</span>       <span class="mi">8081</span><span class="p">;</span>
          <span class="kn">root</span>   <span class="n">/app/public</span><span class="p">;</span>
          <span class="kn">index</span> <span class="s">index.php</span>
          <span class="s">charset</span> <span class="s">utf-8</span><span class="p">;</span>

          <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
            <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri</span><span class="n">/</span> <span class="n">/index.php?</span><span class="nv">$args</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php$</span>  <span class="p">{</span>
            <span class="kn">fastcgi_pass</span>   <span class="nf">127.0.0.1</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
            <span class="kn">fastcgi_index</span>  <span class="s">index.php</span><span class="p">;</span>
            <span class="kn">fastcgi_param</span>  <span class="s">SCRIPT_FILENAME</span>  <span class="n">/app/public/index.php</span><span class="p">;</span>
            <span class="kn">include</span>        <span class="s">fastcgi_params</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
</code></pre></div></div>

<h4 id="åº”ç”¨éƒ¨ç½²è„šæœ¬">åº”ç”¨éƒ¨ç½²è„šæœ¬</h4>

<p>åœ¨ä¸‹é¢çš„éƒ¨ç½²è„šæœ¬ä¸­ï¼Œæœ‰å‡ ç‚¹å€¼å¾—å…³æ³¨ä¸€ä¸‹ï¼š</p>

<ul>
  <li>ä½¿ç”¨äº† emptyDir:{} ä½œä¸ºå®¹å™¨çš„æºä»£ç å­˜å‚¨ä»‹è´¨ï¼Œè¿™æ ·å¯ä»¥å°†åº”ç”¨è¯»å–åˆ°ä¸´æ—¶ç›®å½•ä¸­ï¼ŒåŠ é€Ÿè¿è¡Œæ—¶ php æºç çš„åŠ è½½ã€‚å¦‚æœè„šæœ¬æ–‡ä»¶ä¸å¤§ï¼Œå¯ä»¥æŒ‡å®š emptyDir ä½¿ç”¨å†…å­˜è¿è¡Œï¼Œè¿™ä¸ªå¯ä»¥æ›´åŠ åŠ é€Ÿè„šæœ¬åŠ è½½ã€‚</li>
  <li>pod å¯åŠ¨çš„æ—¶å€™ä½¿ç”¨äº† 2 ä¸ª åˆå§‹åŒ–å®¹å™¨ï¼Œä½¿ç”¨çš„é•œåƒåˆ†åˆ«æ˜¯ï¼šæç®€æºä»£ç çš„é•œåƒ(php-caculate-purecode)å’Œæ¡†æ¶è¿è¡Œæ—¶é•œåƒ(my-lumen)ï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™åˆ†åˆ«å°† /app çš„ä»£ç æ‹·è´åˆ°äº† emptyDir å·ä¸­ï¼Œåˆ†åˆ«æ‹·è´äº†lumençš„ vendor ä¾èµ–å’Œä¸šåŠ¡æºä»£ç ã€‚è¿™é‡Œæ‹·è´ä¸šåŠ¡æºä»£ç è¿‡ç¨‹äº¦å¯ä»¥ä½¿ç”¨ cfs æˆ–è€… cos æ¥å®ç°ã€‚ç”±äºä½¿ç”¨äº†å®¿ä¸»æœºå­˜å‚¨æºä»£ç ï¼Œå½“æºä»£ç è¿‡äºåºå¤§çš„æ—¶å€™ï¼Œè¯·æ³¨æ„è¶…å‡ºå®¿ä¸»æœºå­˜å‚¨å®¹é‡é£é™©ã€‚</li>
  <li>ç”±äºæºç å’Œä¾èµ–åŒ…éƒ½å·²ç»åœ¨ initContainers ç»„ç»‡å¥½äº†ï¼Œæ‰€ä»¥ï¼Œåªéœ€è¦ä½¿ç”¨ php åŸºç¡€å®¹å™¨æ¥å¯åŠ¨åº”ç”¨å³å¯ã€‚</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-nginx-sidecar</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
  <span class="na">labels</span><span class="pi">:</span> 
    <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-nginx-sidecar</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-nginx-sidecar</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-nginx-sidecar</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="c1"># web app çš„å·¥ä½œç›®å½•</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webapp-data</span>
        <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="c1"># nginx çš„é…ç½®æ–‡ä»¶ï¼Œä» cm ä¸­ç»‘å®šè¿‡æ¥</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-php-config</span>
        <span class="na">configMap</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-sidecar-config</span>
          <span class="na">items</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">config</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">caculate-sidecar.conf</span>
      <span class="c1"># åˆå§‹åŒ–ï¼Œå°†é•œåƒä¸­çš„æºæ–‡ä»¶æ‹·è´åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ã€‚</span>
      <span class="na">initContainers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">copy-code</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">cloudbeer/php-caculate-purecode:1.0</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webapp-data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/webapp</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">cp</span><span class="pi">,</span> <span class="nv">-R</span><span class="pi">,</span> <span class="nv">/app/</span><span class="pi">,</span> <span class="nv">/webapp</span><span class="pi">]</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">copy-lumen</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">cloudbeer/my-lumen:1.0</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webapp-data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/webapp</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">cp</span><span class="pi">,</span> <span class="nv">-R</span><span class="pi">,</span> <span class="nv">/app/</span><span class="pi">,</span> <span class="nv">/webapp</span><span class="pi">]</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="c1"># fpm åº”ç”¨è¿è¡Œç¯å¢ƒ</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">caculate</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">cloudbeer/php-runtime:1.0</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9000</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webapp-data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/app</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">app</span>
      <span class="c1"># nginx sidecar</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-sidecar</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:alpine</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-php-config</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/nginx/conf.d/caculate-sidecar.conf</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">caculate-sidecar.conf</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webapp-data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/app</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">app</span>
<span class="nn">---</span>
</code></pre></div></div>

<p>æŒ‚ä¸€ä¸ª LoadBalancer çœ‹çœ‹ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-sidecar-service</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
<span class="na">spec</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
    <span class="na">selector</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-nginx-sidecar</span>
    <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
          <span class="na">port</span><span class="pi">:</span> <span class="m">8081</span>
          <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8081</span>
</code></pre></div></div>

<p>è®¿é—®å¯¹åº”çš„ å¤–éƒ¨ ip:8081ï¼Œå®Œç¾è¿è¡Œã€‚</p>

<h3 id="nginx-ç‹¬ç«‹éƒ¨ç½²">nginx ç‹¬ç«‹éƒ¨ç½²</h3>

<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿ç»´éƒ¨é—¨å¸Œæœ›å°† web server æ”¶æ•›å¹¶ç»Ÿä¸€ç®¡ç†ï¼Œå¼€å‘ä¹Ÿä¸å¤ªå…³å¿ƒ nginx çš„å…·ä½“é…ç½®ï¼Œå°†ä¸¤è€…è¿›è¡Œæ‹†åˆ†ä¼—æœ›æ‰€å½’ï¼Œå¹¶ä¸”åœ¨å¾®æœåŠ¡çš„æ¨ªå‘æ‰©å±•ä¸­ï¼Œè¿™ç§æ–¹å¼ä¹Ÿæ›´åŠ â€œä¼˜é›…â€ã€‚</p>

<p>éƒ¨ç½²æ¶æ„å›¾å¦‚ä¸‹ï¼š</p>

<p><img src="https://github.com/cloudbeer/php-best-practice/raw/main/readme-img/separate.jpg?raw=true" alt="nginx ç‹¬ç«‹éƒ¨ç½²æ¶æ„" /></p>

<h4 id="éƒ¨ç½²-fpm-ä¸šåŠ¡åº”ç”¨">éƒ¨ç½² fpm ä¸šåŠ¡åº”ç”¨</h4>

<ul>
  <li>æ­¤å¤„éƒ¨ç½²äº† php-caculate é•œåƒï¼Œæ­¤é•œåƒé‡ŒåŒ…å«äº†æºä»£ç ï¼ŒWebæ¡†æ¶ä»¥åŠ php è¿è¡Œæ—¶ï¼Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„ php-fpm ä¸šåŠ¡åº”ç”¨ã€‚</li>
  <li>é€šè¿‡ service å‘å¸ƒåº”ç”¨ï¼Œä»¥ä¾¿ nginx èƒ½å‘ç° fpm æœåŠ¡ï¼Œå¹¶è§£å¶äº† webserver å’Œ ä¸šåŠ¡æœåŠ¡ã€‚åæœŸå¯ä»¥åšçº¯php ä¸šåŠ¡çš„æ¨ªå‘æ‰©å±•å’Œ nginx çš„é›†ä¸­ç®¡ç†ã€‚</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ä¸º php-fpm éƒ¨ç½² service</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">9000</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">tcp</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-standalone</span>

<span class="nn">---</span>   
<span class="c1"># éƒ¨ç½²å…·ä½“åº”ç”¨</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
  <span class="na">labels</span><span class="pi">:</span> 
    <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">cloudbeer/php-caculate:1.0</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">caculate</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9000</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
</code></pre></div></div>

<h4 id="nginx-éƒ¨ç½²">nginx éƒ¨ç½²</h4>

<p>æ­¤éƒ¨åˆ†çš„ nginx é…ç½®åŸºæœ¬å’Œä¸Šé¢ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ fastcgi_pass çš„è°ƒç”¨ç›®æ ‡å˜æˆäº† php ä¸šåŠ¡çš„ serviceï¼šcaculate-standalone äº†ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-standalone-config</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
<span class="na">data</span><span class="pi">:</span>
    <span class="na">config</span><span class="pi">:</span> <span class="pi">|-</span>
      <span class="s">server {</span>
          <span class="s">listen       8081;</span>
          <span class="s">root   /app/public;</span>
          <span class="s">index index.php</span>
          <span class="s">charset utf-8;</span>

          <span class="s">location / {</span>
            <span class="s">try_files $uri $uri/ /index.php?$args;</span>
          <span class="s">}</span>

          <span class="s">location ~ \.php$  {</span>
            <span class="s">fastcgi_pass   caculate-standalone:9000;</span>
            <span class="s">fastcgi_index  index.php;</span>
            <span class="s">fastcgi_param  SCRIPT_FILENAME  /app/public/index.php;</span>
            <span class="s">include        fastcgi_params;</span>
          <span class="s">}</span>
      <span class="s">}</span>
</code></pre></div></div>

<p>ä¸‹é¢ä¸º nginx é…ç½®å•ç‹¬ pod å¯åŠ¨ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span>  <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-standalone-nginx-deployment</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
<span class="na">spec</span><span class="pi">:</span>
    <span class="na">selector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">template</span><span class="pi">:</span>
        <span class="na">metadata</span><span class="pi">:</span>
          <span class="na">labels</span><span class="pi">:</span>
              <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">spec</span><span class="pi">:</span>
          <span class="na">containers</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
            <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:alpine</span>
            <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-php-config</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/nginx/conf.d/caculate-standalone.conf</span>
              <span class="na">subPath</span><span class="pi">:</span> <span class="s">caculate-standalone.conf</span>
          <span class="na">volumes</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-php-config</span>
                <span class="na">configMap</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-standalone-config</span>
                  <span class="na">items</span><span class="pi">:</span>
                  <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">config</span>
                    <span class="na">path</span><span class="pi">:</span> <span class="s">caculate-standalone.conf</span>
</code></pre></div></div>

<p>ç°åœ¨ï¼Œç»™ nginx åº”ç”¨æŒ‚ä¸€ä¸ª LoadBalancer æµ‹è¯•ä¸€ä¸‹ï¼Œäº¦å®Œç¾è¿è¡Œã€‚</p>

<h3 id="ä½¿ç”¨-nginx-ingress-éƒ¨ç½²">ä½¿ç”¨ nginx-ingress éƒ¨ç½²</h3>

<p>ä¸Šé¢çš„éƒ¨ç½²æ¶æ„å›¾ä¸­ï¼Œingress å’Œ nginx åˆ†åˆ«è¿›è¡Œäº†éƒ¨ç½²ï¼Œä½†  nginx-ingress å…¶å®å·²ç»åˆå¹¶äº†è¿™ä¸¤ä¸ªéƒ¨åˆ†ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬è¯•è¯•ä½¿ç”¨ nginx-ingress éƒ¨ç½²ã€‚</p>

<p><img src="https://github.com/cloudbeer/php-best-practice/raw/main/readme-img/nginx-ingress.jpg?raw=true" alt="ä½¿ç”¨ nginx-ingress éƒ¨ç½²" /></p>

<p>ä½¿ç”¨ä¸Šé¢çš„å·²ç»éƒ¨ç½²å¥½çš„ fpm ä¸šåŠ¡çš„service: caculate-standalone ã€‚</p>

<p>éƒ¨ç½²è„šæœ¬å¦‚ä¸‹ï¼š</p>

<ul>
  <li>ingress.class çš„å€¼æ˜¯åˆ›å»º nginx-ingress æ—¶å€™åœ¨æ§åˆ¶å°å®šä¹‰çš„ã€‚</li>
  <li>ä¸çº¯ nginx é…ç½®ä¸åŒï¼Œnginx-ingress æ— éœ€é…ç½® try_files èŠ‚ç‚¹ï¼Œä¸‹é¢çš„é…ç½®å…¶å®å·²ç»å°†å…¨éƒ¨è¯·æ±‚è½¬å‘åˆ°äº† public/index.phpã€‚</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-nginx-ingress-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">SCRIPT_FILENAME</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/app/public/index.php"</span>
<span class="nn">---</span>  
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s2">"</span><span class="s">your-ingress-class"</span>
    <span class="na">nginx.ingress.kubernetes.io/backend-protocol</span><span class="pi">:</span> <span class="s2">"</span><span class="s">FCGI"</span>
    <span class="na">nginx.ingress.kubernetes.io/fastcgi-index</span><span class="pi">:</span> <span class="s2">"</span><span class="s">index.php"</span>
    <span class="na">nginx.ingress.kubernetes.io/fastcgi-params-configmap</span><span class="pi">:</span> <span class="s2">"</span><span class="s">caculate-nginx-ingress-config"</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-nginx-ingress</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">backend</span><span class="pi">:</span>
          <span class="na">serviceName</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
          <span class="na">servicePort</span><span class="pi">:</span> <span class="m">9000</span>
</code></pre></div></div>

<p>å¦‚æœ nginx-ingress æä¾›äº†å¤–ç½‘åœ°å€ï¼Œå¯ä»¥è®¿é—®ä¸€ä¸‹è¯•è¯•ï¼Œå®Œç¾è¿è¡Œã€‚</p>

<h3 id="moremesh-åŒ–">MOREï¼šmesh åŒ–</h3>

<p>åœ¨ php mesh åŒ–ä¸­ï¼Œéœ€è¦è€ƒè™‘çš„é—®é¢˜å¦‚ä¸‹ï¼š</p>

<ul>
  <li>fastcgi ä½¿ç”¨ TCP åè®®ï¼Œå¹¶ä¸”æœ‰è‡ªå·±çš„åºåˆ—åŒ–æ–¹æ³•ï¼Œæ­¤ç‰¹æ€§å¹¶æœªåœ¨ istio å’Œ envoy ä¸­æ”¯æŒï¼Œæ— æ³•è¿›è¡Œç²¾ç»†çš„æµé‡æ§åˆ¶ã€‚</li>
  <li>fpm + envoy sidecar å¯ä»¥å®ç°æœåŠ¡çº§åˆ«çš„æµé‡æ§åˆ¶ã€‚ fpm + nginx-sidecar + envoy sidecar å°† fastcgi è°ƒç”¨è½¬åŒ–ä¸º http è°ƒç”¨ï¼Œå¯ä»¥å®ç°åŸºäº http åè®®çš„ç²¾ç»†æµé‡æ§åˆ¶ã€‚</li>
  <li>å®ç°è°ƒç”¨é“¾ç›‘æ§ï¼Œéœ€è¦ä½¿ç”¨ http è¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œæœ‰å¯èƒ½éœ€è¦æ”¹é€ ä»£ç ï¼Œåœ¨header ä¸­å°è£… opentracing ã€‚</li>
</ul>

<p>å½“ä¸‹ï¼Œphp mesh çš„éƒ¨ç½²æ¨¡å¼å»ºè®®é‡‡ç”¨ fpm ä¸šåŠ¡å±‚ï¼Œnginx-sidecarï¼Œ envoy-sidecar ä¸‰ä¸ªå®¹å™¨ä¸ºä¸€ä¸ªpod çš„éƒ¨ç½²æ¨¡å¼ã€‚</p>

<p>æ¶æ„å›¾å¦‚ä¸‹ï¼š</p>

<p><img src="https://github.com/cloudbeer/php-best-practice/raw/main/readme-img/mesh.jpg?raw=true" alt="php åº”ç”¨çš„ mesh éƒ¨ç½²æ¶æ„" /></p>

<p>æ­¤å¤„çš„éƒ¨ç½²ä¸ç¬¬ä¸€éƒ¨åˆ†çš„å†…å®¹ - nginx ä½œä¸º sidecar è¿è¡Œç±»ä¼¼ï¼Œåœ¨è…¾è®¯äº‘ä¸­éœ€è¦å¼€é€š TCMï¼Œå¹¶æ³¨å…¥ envoy çš„ sidecarã€‚</p>

<hr />

<h2 id="æœ¬æ–‡ç›¸å…³çš„æºä»£ç è¯´æ˜">æœ¬æ–‡ç›¸å…³çš„æºä»£ç è¯´æ˜</h2>

<p>ä½ç½®ï¼š<a href="https://github.com/cloudbeer/php-best-practice">https://github.com/cloudbeer/php-best-practice</a></p>

<h3 id="srclumen-app">src/lumen-app/</h3>

<p>php ä¸šåŠ¡åº”ç”¨ï¼Œæ˜ å°„äº†2ä¸ªè·¯å¾„</p>

<ul>
  <li>/cpuï¼š ä¸¤ç§æ–¹å¼è®¡ç®—äº† pi</li>
  <li>/mem: åœ¨æ•°ç»„é‡Œå¡äº†å­—ç¬¦ä¸²ä¸ºäº†æ’‘çˆ†å†…å­˜</li>
</ul>

<h3 id="deployments">deployments/</h3>

<p>éƒ¨ç½²ä»£ç </p>

<ul>
  <li>app-caculate-fpm-separate.yamlï¼š nginx å’Œ fpm åˆ†åœ¨ä¸åŒçš„ pod ä¸­éƒ¨ç½²</li>
  <li>app-caculate-nginx-ingress.yamlï¼š nginx-ingress ç›´æ¥ä»£ç† fpm æœåŠ¡</li>
  <li>app-caculate-nginx-sidecar.yamlï¼š nginx å’Œ fpm éƒ¨ç½²åœ¨åŒä¸€ä¸ªpodä¸­çš„ä¸¤ä¸ªå®¹å™¨</li>
</ul>

<h3 id="dockerfile">dockerfile/</h3>

<ul>
  <li>lumen.Dockerfileï¼šåŒ…å« lumen æ¡†æ¶çš„è¿è¡Œç¯å¢ƒ</li>
  <li>runtime.Dockerfileï¼šphp åŸºç¡€è¿è¡Œç¯å¢ƒ</li>
  <li>ä¸šåŠ¡ä»£ç çš„ Dockerfile ä½äº src/lumen-app/Dockerfile å’Œ src/lumen-app/purecode.Dockerfile</li>
</ul>

  </div>

  <a class="u-url" href="/2022/01/deploy-php-in-k8s.html" hidden></a>
</article>


<script>
  var codeBlocks = document.querySelectorAll('pre.highlight');

  codeBlocks.forEach(function (codeBlock) {
    var copyButton = document.createElement('button');
    copyButton.className = 'copy';
    copyButton.type = 'button';
    copyButton.ariaLabel = 'Copy code to clipboard';
    copyButton.innerText = 'Copy';

    codeBlock.append(copyButton);

    copyButton.addEventListener('click', function () {
      var code = codeBlock.querySelector('code').innerText.trim();
      window.navigator.clipboard.writeText(code);

      copyButton.innerText = 'Copied';
      var fourSeconds = 4000;

      setTimeout(function () {
        copyButton.innerText = 'Copy';
      }, fourSeconds);
    });
  });
</script>
    </div>
  </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>è®¢é˜…æœ¬ç«™</span>
          </a>
        </p>
      </div>


    </div>

    <div class="footer-col-wrapper">

      <div class="footer-col">æ¬¢è¿è®¿é—®: <a href="https://chuchur.com/" target="_blank">ç¦…å¢ƒèŠ±å›­</a> |
<a href="https://silencehuliang.github.io/" target="_blank">Never give up</a></div>
    </div>
  </div>

</footer><div class="bbanner">
    æ¬¢è¿è½¬è½½æ–‡ç« ï¼Œè½¬è½½ä¸ç”¨å’Œæˆ‘è¯´ã€‚
    æœ¬ç«™æ‰€æœ‰ä¿¡æ¯å‡ä»£è¡¨æˆ‘è‡ªå·±ï¼Œä¸ä»£è¡¨ä»»ä½•å…¬å¸ã€‚
  </div>
</body>

<style>
  hr {
    margin: 20px 0;
  }

  .bbanner {
    padding: 20px 0;
    text-align: center;
    color: #999;
    font-size: 12px;
  }
</style>

<script>
  function addChild(top, snowShape) {
    var div = document.createElement("div");
    div.innerHTML = snowShape;
    div.className = "flake";
    div.style.position = 'fixed';
    div.style.color = 'white';
    div.style.opacity = 0.9;
    div.style.left = parseInt(Math.random() * window.innerWidth) + 'px';
    div.style.top = top + 'px';
    div.style.fontSize = parseInt(Math.random() * 50) + 'px';
    document.body.appendChild(div);
  };
  function autoWipe(snowSpeed, snowShape) {
    var flake = document.getElementsByClassName('flake');
    var timer = setInterval(function () {
      for (var i = 0; i < flake.length; i++) {
        var opacity = flake[i].style.opacity;
        var offsetTop = Number((flake[i].style.top).replace('px', ''));
        if (offsetTop < window.innerHeight) {
          offsetTop = offsetTop + snowSpeed;
          opacity = opacity - 0.003;
          flake[i].style.top = offsetTop + 'px';
          flake[i].style.opacity = opacity;
        } else {
          document.body.removeChild(flake[i]);
          addChild(0, snowShape);
        }
      }
    }, 100);
  };
  function final(bigSnowParam, snowShape) {
    for (var i = 0; i < bigSnowParam.snowNum; i++) {
      addChild(parseInt(Math.random() * window.innerHeight), snowShape);
    }
    autoWipe(bigSnowParam.snowSpeed, snowShape);
  };
  //å½¢æˆæœ€åæ•ˆæœ
  function final(bigSnowParam, snowShape) {
    for (var i = 0; i < bigSnowParam.snowNum; i++) {
      addChild(parseInt(Math.random() * window.innerHeight), snowShape);
    }
    autoWipe(bigSnowParam.snowSpeed, snowShape);
  };

  var bigSnowParam = {
    snowNum: 242,
    snowSpeed: 6
  };
  var midSnowParam = {
    snowNum: 242,
    snowSpeed: 3
  };
  var littleSnowParam = {
    snowNum: 50,
    snowSpeed: 2
  };
  //è‡ªå®šä¹‰é›ªå‚è€ƒå€¼
  var selfSnowParam = {
    snowNum: '',//å€¼ä¸ºnumber
    snowSpeed: ''//å€¼ä¸ºnumber
  };

  var snowShapeObj = {
    1: 'â†',
    2: 'â„',
    3: 'â…',
    4: 'âœ¼',
    5: 'âœ¼',
    6: 'â‰',
    7: 'â‡',
    8: 'âˆ',
    9: 'âŠ',
    10: 'âœ¥',
    11: 'âœº'
  };
  // final(littleSnowParam, snowShapeObj[1]);
</script>

</html>