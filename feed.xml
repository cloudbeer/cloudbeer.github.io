<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.1">Jekyll</generator><link href="https://cloudbeer.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://cloudbeer.github.io/" rel="alternate" type="text/html" /><updated>2022-12-04T14:12:18+00:00</updated><id>https://cloudbeer.github.io/feed.xml</id><title type="html">å•¤é…’äº‘</title><subtitle>åˆ†äº«ï¼Œè®°å½•è€Œå·²</subtitle><entry><title type="html">AWS CDK å…¥é—¨ï¼šHello World</title><link href="https://cloudbeer.github.io/2022/12/cdk-start-hello-world.html" rel="alternate" type="text/html" title="AWS CDK å…¥é—¨ï¼šHello World" /><published>2022-12-04T11:54:44+00:00</published><updated>2022-12-04T11:54:44+00:00</updated><id>https://cloudbeer.github.io/2022/12/cdk-start-hello-world</id><content type="html" xml:base="https://cloudbeer.github.io/2022/12/cdk-start-hello-world.html"><![CDATA[<p>æœ¬æ–‡æ˜¯ AWS CDK å…¥é—¨æ•™ç¨‹ï¼Œå°†åˆ©ç”¨ â€œæ¸è¿›â€ æ¨¡å¼ ä½¿ç”¨ AWS CDK ç”Ÿäº§ä¸€ä¸ªç”Ÿäº§å¯ç”¨çš„ EKS é›†ç¾¤ã€‚æœ¬æ–‡æ˜¯ä¸ŠåŠéƒ¨åˆ†ï¼ŒCDK å…¥é—¨çŸ¥è¯†ã€‚</p>

<h2 id="iac-å’Œ-cdk-ç®€ä»‹">IaC å’Œ CDK ç®€ä»‹</h2>

<h3 id="ä»€ä¹ˆæ˜¯-iac">ä»€ä¹ˆæ˜¯ IaCï¼Ÿ</h3>

<p>è¿™æ®µæ¥è‡ªï¼š<a href="https://www.redhat.com/zh/topics/automation/what-is-infrastructure-as-code-iac">https://www.redhat.com/zh/topics/automation/what-is-infrastructure-as-code-iac</a></p>

<blockquote>
  <p>åŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆIaCï¼‰æ˜¯é€šè¿‡ä»£ç è€Œéæ‰‹åŠ¨æµç¨‹æ¥ç®¡ç†å’Œç½®å¤‡åŸºç¡€è®¾æ–½çš„æ–¹æ³•ã€‚</p>
</blockquote>

<blockquote>
  <p>åˆ©ç”¨ IaC æˆ‘ä»¬å¯ä»¥åˆ›å»ºåŒ…å«åŸºç¡€è®¾æ–½è§„èŒƒçš„é…ç½®æ–‡ä»¶ï¼Œä»è€Œä¾¿äºç¼–è¾‘å’Œåˆ†å‘é…ç½®ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜å¯ç¡®ä¿æ¯æ¬¡ç½®å¤‡çš„ç¯å¢ƒéƒ½å®Œå…¨ç›¸åŒã€‚é€šè¿‡å¯¹é…ç½®è§„èŒƒè¿›è¡Œæ•´ç†å’Œè®°å½•ï¼ŒIaC æœ‰åŠ©äºå®ç°é…ç½®ç®¡ç†ï¼Œå¹¶é¿å…å‘ç”Ÿæœªè®°å½•çš„ä¸´æ—¶é…ç½®æ›´æ”¹ã€‚</p>
</blockquote>

<blockquote>
  <p>ç‰ˆæœ¬æ§åˆ¶æ˜¯ IaC çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå°±åƒå…¶ä»–ä»»ä½•è½¯ä»¶æºä»£ç æ–‡ä»¶ä¸€æ ·ï¼Œé…ç½®æ–‡ä»¶ä¹Ÿåº”è¯¥åœ¨æºä»£ç æ§åˆ¶ä¹‹ä¸‹ã€‚ä»¥åŸºç¡€è®¾æ–½å³ä»£ç æ–¹å¼éƒ¨ç½²è¿˜æ„å‘³ç€æ‚¨å¯ä»¥å°†åŸºç¡€æ¶æ„åˆ’åˆ†ä¸ºè‹¥å¹²æ¨¡å—åŒ–ç»„ä»¶ï¼Œå®ƒä»¬å¯é€šè¿‡è‡ªåŠ¨åŒ–ä»¥ä¸åŒçš„æ–¹å¼è¿›è¡Œç»„åˆã€‚</p>
</blockquote>

<blockquote>
  <p>å€ŸåŠ© IaC å®ç°åŸºç¡€æ¶æ„ç½®å¤‡çš„è‡ªåŠ¨åŒ–ï¼Œæ„å‘³ç€å¼€å‘äººå‘˜æ— éœ€å†åœ¨æ¯æ¬¡å¼€å‘æˆ–éƒ¨ç½²åº”ç”¨æ—¶æ‰‹åŠ¨ç½®å¤‡å’Œç®¡ç†æœåŠ¡å™¨ã€æ“ä½œç³»ç»Ÿã€å­˜å‚¨åŠå…¶ä»–åŸºç¡€æ¶æ„ç»„ä»¶ã€‚å¯¹åŸºç¡€æ¶æ„ç¼–ç å³å¯åˆ›å»ºä¸€ä¸ªç½®å¤‡ç”¨çš„æ¨¡æ¿ï¼Œå°½ç®¡ç½®å¤‡è¿‡ç¨‹ä»ç„¶å¯ä»¥æ‰‹åŠ¨å®Œæˆï¼Œä½†ä¹Ÿå¯ä»¥ç”±è‡ªåŠ¨åŒ–å·¥å…·ï¼ˆä¾‹å¦‚çº¢å¸½Â® AnsibleÂ® è‡ªåŠ¨åŒ–å¹³å°ï¼‰ä¸ºæ‚¨ä»£åŠ³ã€‚</p>
</blockquote>

<p>ç®€è¦æ¥è¯´å°±æ˜¯ï¼šä½¿ç”¨æè¿°æ€§çš„ä»£ç ç®¡ç†æ‚¨çš„åŸºç¡€è®¾æ–½ã€‚</p>

<h3 id="ä»€ä¹ˆæ˜¯-cdk">ä»€ä¹ˆæ˜¯ CDKï¼Ÿ</h3>

<p>è¿™æ®µæ¥è‡ªï¼š<a href="https://aws.amazon.com/cn/getting-started/guides/setup-cdk/">https://aws.amazon.com/cn/getting-started/guides/setup-cdk/</a></p>

<blockquote>
  <p>AWS CDK æ˜¯ä¸€ä¸ªå¼€æºè½¯ä»¶å¼€å‘æ¡†æ¶ï¼Œå¯è®©æ‚¨ä½¿ç”¨ç†Ÿæ‚‰çš„ç¼–ç¨‹è¯­è¨€ (å¦‚ JavaScriptã€TypeScriptã€Pythonã€Javaã€C# å’Œ Go) å®šä¹‰äº‘åº”ç”¨ç¨‹åºèµ„æºã€‚æ‚¨ç¼–å†™çš„ä»£ç è½¬æ¢ä¸º CloudFormation (CFN) æ¨¡æ¿ï¼Œå¯ä½¿ç”¨ <a href="https://aws.amazon.com/cn/cloudformation/">AWS CloudFormation</a> åˆ›å»ºåŸºç¡€è®¾æ–½ã€‚</p>
</blockquote>

<p>è¿™ä¸ªä¹Ÿæ€»ç»“ä¸€ä¸‹ï¼šCDK å°±æ˜¯ AWS çš„ IaCï¼Œä»–ä¾èµ– Cloudformationï¼Œå¯ä»¥ç”¨å¸¸ç”¨çš„è¯­è¨€æ¥æè¿°æ‚¨çš„åŸºç¡€è®¾æ–½ã€‚</p>

<h2 id="å®‰è£…å’Œè®¾ç½®-aws-cdk">å®‰è£…å’Œè®¾ç½® AWS CDK</h2>

<p>æˆ‘ä¹ æƒ¯ä½¿ç”¨å‘½ä»¤è¡Œçš„æ–¹å¼è¿è¡Œï¼Œå¦‚ <code class="language-plaintext highlighter-rouge">cdk deploy</code>ã€‚cdk è¿™ä¸ªå‘½ä»¤å…¶å®æ˜¯ä¸€ä¸ª nodejs ç¨‹åºã€‚</p>

<p>nodejs å®‰è£…å°±ä¸è¯´äº†ï¼Œç°åœ¨å›½å†…æœ‰å¾ˆå¤šå¼€æºé•œåƒï¼Œå¦‚ï¼š<a href="https://mirrors.tuna.tsinghua.edu.cn/nodejs-release">https://mirrors.tuna.tsinghua.edu.cn/nodejs-release</a>ï¼Œè¯·å®‰è£…ç‰ˆæœ¬ &gt;= 10.3.0 çš„ã€‚</p>

<p>nodejs å®‰è£…å®Œæˆåï¼Œå°±å¯ä»¥å®‰è£… cdk å‘½ä»¤è¡Œï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm i <span class="nt">-g</span> aws-cdk
</code></pre></div></div>

<p>é»˜è®¤å®‰è£…å®Œæˆå CDK å°±æ˜¯å…¨å±€å‘½ä»¤è¡Œäº†ã€‚</p>

<p>CDK åŒæ—¶è¦ä¾èµ– AWS CLI ä»¥åŠ AWS å‡­è¯ã€‚</p>

<p>å®‰è£… AWS CLI å‚è€ƒï¼š<a href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/getting-started-install.html">https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/getting-started-install.html</a></p>

<p>åœ¨å¼€å‘ç¯å¢ƒé…ç½®å‡­è¯ï¼š<a href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/cli-configure-quickstart.html">https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/cli-configure-quickstart.html</a></p>

<h2 id="hello-world">Hello World</h2>

<p>å¼€å‘ç¯å¢ƒéƒ½è®¾ç½®å¥½äº†ï¼</p>

<p>é¦–å…ˆæ–°å»ºä¸€ä¸ªç›®å½•ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>cdk-demo <span class="o">&amp;&amp;</span> <span class="nb">cd </span>cdk-demo
</code></pre></div></div>

<p>åˆå§‹æ¢é¡¹ç›®ï¼Œä½¿ç”¨ typescipt è¯­è¨€:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cdk init app <span class="nt">--language</span> typescript
</code></pre></div></div>

<ul>
  <li>é€‰æ‹© typescipt è¯­è¨€ï¼Œæ˜¯å› ä¸º cdk çš„æ–‡æ¡£æœ€å¤šæœ€å…¨çš„æ˜¯ typescipt è¯­è¨€ï¼ŒåŒ…æ‹¬ api å’Œ ç¤ºä¾‹ã€‚</li>
</ul>

<p>ç­‰è‹¥å¹²åˆ†é’Ÿï¼ˆä¼šä¾èµ–æ‚¨ä¾èµ–åŒ…çš„ä¸‹è½½é€Ÿåº¦ï¼‰ä¹‹åï¼Œæ‰“å¼€ lib/cdk-workshop-stack.tsï¼Œé»˜è®¤ç¤ºä¾‹ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåˆ›å»ºäº†ä¸€ä¸ª sqs çš„ Queue èµ„æºã€‚</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">CdkWorkshopStack</span> <span class="kd">extends</span> <span class="nx">Stack</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">scope</span><span class="p">:</span> <span class="nx">Construct</span><span class="p">,</span> <span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">props</span><span class="p">?:</span> <span class="nx">StackProps</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sqs</span><span class="p">.</span><span class="nx">Queue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">CdkWorkshopQueue</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">visibilityTimeout</span><span class="p">:</span> <span class="nx">Duration</span><span class="p">.</span><span class="nx">seconds</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
    <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">topic</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sns</span><span class="p">.</span><span class="nx">Topic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">CdkWorkshopTopic</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">topic</span><span class="p">.</span><span class="nx">addSubscription</span><span class="p">(</span><span class="k">new</span> <span class="nx">subs</span><span class="p">.</span><span class="nx">SqsSubscription</span><span class="p">(</span><span class="nx">queue</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å¯¹äºæ–°ç¯å¢ƒï¼Œéœ€è¦è¿è¡Œ:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cdk bootstrap
</code></pre></div></div>

<ul>
  <li>æ­¤å‘½ä»¤åœ¨åŒä¸€ä¸ªè´¦å·å’Œ region ä¸­åªéœ€æ‰§è¡Œä¸€æ¬¡ã€‚</li>
</ul>

<p>é€šè¿‡ list å‘½ä»¤å¯ä»¥æŸ¥çœ‹ stackã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cdk <span class="nb">ls</span>
</code></pre></div></div>

<p>è¿è¡Œéƒ¨ç½²ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cdk deploy
</code></pre></div></div>

<ul>
  <li>æ­¤å‘½ä»¤æ‰§è¡Œåï¼Œä¼šæœ‰èµ„æºæ”¹å˜åˆ—è¡¨ï¼Œå¹¶è¯¢é—®æ˜¯å¦ç¡®è®¤éƒ¨ç½²ã€‚</li>
  <li>æ£€æŸ¥æ— è¯¯åï¼Œè¾“å…¥ y</li>
</ul>

<p>å¾…æ‰§è¡Œå®Œæˆåï¼Œæ£€æŸ¥æ˜¯å¦çœŸçš„åˆ›å»ºå‡ºäº† SQS èµ„æºã€‚</p>

<p>æ¸…ç†èµ„æºï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cdk destroy
</code></pre></div></div>

<p>éªŒè¯å®Œæˆä¹‹åï¼Œè¯·åŠæ—¶ä½¿ç”¨ cdk destroy æ¸…ç†èµ„æºï¼Œå¦åˆ™ä¼š<strong>äº§ç”Ÿè´¹ç”¨</strong>ã€‚</p>

<p>ä½¿ç”¨ cdk destroy åˆ é™¤æ›´å¹²å‡€ã€‚</p>]]></content><author><name></name></author><category term="iac," /><category term="aws," /><category term="cloud-provider" /><summary type="html"><![CDATA[æœ¬æ–‡æ˜¯ AWS CDK å…¥é—¨æ•™ç¨‹ï¼Œå°†åˆ©ç”¨ â€œæ¸è¿›â€ æ¨¡å¼ ä½¿ç”¨ AWS CDK ç”Ÿäº§ä¸€ä¸ªç”Ÿäº§å¯ç”¨çš„ EKS é›†ç¾¤ã€‚æœ¬æ–‡æ˜¯ä¸ŠåŠéƒ¨åˆ†ï¼ŒCDK å…¥é—¨çŸ¥è¯†ã€‚]]></summary></entry><entry><title type="html">å®¹å™¨ DevOpsï¼šGitlab CI</title><link href="https://cloudbeer.github.io/2022/12/k8s-devops-gitlab-ci.html" rel="alternate" type="text/html" title="å®¹å™¨ DevOpsï¼šGitlab CI" /><published>2022-12-04T06:32:01+00:00</published><updated>2022-12-04T06:32:01+00:00</updated><id>https://cloudbeer.github.io/2022/12/k8s-devops-gitlab-ci</id><content type="html" xml:base="https://cloudbeer.github.io/2022/12/k8s-devops-gitlab-ci.html"><![CDATA[<p>å½“ä¸‹ Gitlab å…·å¤‡äº† CI/CD èƒ½åŠ›ã€‚ å…¶ CI æµæ°´çº¿ ä¸»è¦å®šä¹‰åœ¨æºä»£ç æ ¹ç›®å½•çš„ .gitlab-ci.yml çš„æ–‡ä»¶é‡Œã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦æè¿°äº†å¦‚ä½•ç¼–å†™ gitops æ–¹å¼çš„ gitlab-ci æ–‡ä»¶ã€‚</p>

<h2 id="ç¤ºä¾‹æè¿°">ç¤ºä¾‹æè¿°</h2>

<p>æœ¬æ–‡ä½¿ç”¨äº† gitlab saas ç‰ˆæœ¬ã€‚ä½¿ç”¨ saas ç‰ˆæœ¬çš„ ci åŠŸèƒ½ï¼Œéœ€è¦å¡«å†™ä¿¡ç”¨å¡ï¼Œæ¯ä¸ªæœˆæœ‰ 400min çš„å…è´¹çš„é¢åº¦ã€‚</p>

<p>æœ¬æ–‡çš„æºä»£ç åœ¨ï¼š<a href="https://gitlab.com/cloudbeer/gateway">https://gitlab.com/cloudbeer/gateway</a>ï¼Œè¿™æ˜¯ä¸€ä¸ª springcloud gateway åº”ç”¨ã€‚</p>

<p>ci çš„è¿‡ç¨‹åŒ…æ‹¬ï¼š</p>

<ul>
  <li>ç¼–è¯‘ java æºç </li>
  <li>æ‰“åŒ… docker é•œåƒï¼Œå¹¶ä¸Šä¼ åˆ°é•œåƒä»“åº“ï¼ˆæœ¬æ–‡ä½¿ç”¨çš„æ˜¯ AWS ECR ä»“åº“ï¼‰</li>
  <li>ä¿®æ”¹éƒ¨ç½²ç›®æ ‡è„šæœ¬çš„é•œåƒç‰ˆæœ¬</li>
</ul>

<p>å®Œæˆè¿™å‡ ä¸ªæ­¥éª¤ä¹‹åï¼Œargocd ä¼šæ¥æ‰‹ cd çš„å·¥ä½œã€‚</p>

<h2 id="gitlab-ciyml-ä»£ç æ‹†è§£">.gitlab-ci.yml ä»£ç æ‹†è§£</h2>

<h3 id="ç¯å¢ƒå˜é‡">ç¯å¢ƒå˜é‡</h3>

<p>ç¯å¢ƒå˜é‡çš„å®šä¹‰æœ‰ä¸‰ç§æ–¹å¼ï¼š</p>
<ul>
  <li>å…¨å±€å®šä¹‰ï¼šå·¦ä¾§èœå• Settings -&gt; CI/CD, é¡µé¢ä¸Š Variables éƒ¨åˆ†ï¼Œå±•å¼€ Expandã€‚</li>
  <li>åœ¨ yaml æ–‡ä»¶é‡Œç›´æ¥å®šä¹‰ï¼šå‚è§ä¸‹é¢çš„ä»£ç ã€‚</li>
  <li>æ‰‹å·¥æŒ‡å®šï¼šåœ¨æ¯æ¬¡æ‰‹å·¥å¯åŠ¨æµæ°´çº¿æ—¶ï¼Œå¯ä»¥å¡«å†™å˜é‡ã€‚</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">variables</span><span class="pi">:</span>
  <span class="na">DOCKER_DRIVER</span><span class="pi">:</span> <span class="s">overlay</span>
  <span class="na">DOCKER_REGISTRY</span><span class="pi">:</span> <span class="s">00000000.dkr.ecr.us-east-2.amazonaws.com</span>
  <span class="na">AWS_DEFAULT_REGION</span><span class="pi">:</span> <span class="s">us-east-2</span>
  <span class="na">DOCKER_HOST</span><span class="pi">:</span> <span class="s">tcp://docker:2375</span>
</code></pre></div></div>

<h3 id="stages-çš„å®šä¹‰">stages çš„å®šä¹‰</h3>

<p>é¦–å…ˆå®šä¹‰å‡ ä¸ª å¤§çš„æ­¥éª¤ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">build</span>
  <span class="pi">-</span> <span class="s">package</span>
  <span class="pi">-</span> <span class="s">deploy</span>
</code></pre></div></div>

<p>ç„¶ååœ¨å„ä¸ªæ­¥éª¤è¯¦æƒ…é‡Œï¼Œå¯ä»¥æŠŠå½“å‰çš„æ­¥éª¤è¿›è¡Œåˆ†ç±»ï¼Œå°±åƒè¿™æ ·ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">do-something</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">build</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">alpine</span>
  <span class="na">script</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sleep</span><span class="nv"> </span><span class="s">300"</span>
</code></pre></div></div>

<h3 id="æºç ç¼–è¯‘">æºç ç¼–è¯‘</h3>

<p>å¯¹äºç¼–è¯‘å‹è¯­è¨€ï¼Œéœ€è¦å°†æºä»£ç è¿›è¡Œç¼–è¯‘ï¼Œæœ¬ç¤ºä¾‹ä¸­å°±æ˜¯éœ€è¦å°† java æºä»£ç ç¼–è¯‘æ‰“åŒ…æˆ jar åŒ…ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">maven</span><span class="o">-</span><span class="nl">build:</span>
  <span class="nl">image:</span> <span class="nl">maven:</span><span class="n">latest</span>
  <span class="nl">stage:</span> <span class="n">build</span>
  <span class="nl">script:</span> <span class="s">"mvn package"</span>
  <span class="nl">artifacts:</span>
    <span class="nl">paths:</span>
      <span class="o">-</span> <span class="n">target</span><span class="o">/*.</span><span class="na">jar</span>
</code></pre></div></div>

<ul>
  <li>ç¼–è¯‘æ—¶ä½¿ç”¨ maven è¿™ä¸ªé•œåƒ</li>
  <li>è¿è¡Œçš„æŒ‡ä»¤æ˜¯ <code class="language-plaintext highlighter-rouge">mvn package</code></li>
  <li>ç¼–è¯‘çš„ç»“æœæŒ‡å®šä¸º target ç›®å½•ä¸‹çš„æ‰€æœ‰ jar æ–‡ä»¶ï¼Œgitlab ä¼šå°† artifacts ä¸Šä¼ ï¼Œä¾›ç»™åé¢çš„æ­¥éª¤ä½¿ç”¨ã€‚</li>
</ul>

<h3 id="docker-é•œåƒæ‰“åŒ…ä¸Šä¼ ">Docker é•œåƒæ‰“åŒ…ä¸Šä¼ </h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">docker-build</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">amazon/aws-cli</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">services</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker:dind</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">package</span>
  <span class="na">before_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">amazon-linux-extras install docker</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker build -t $DOCKER_REGISTRY/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA .</span>
    <span class="pi">-</span> <span class="s">aws ecr get-login-password | docker login --username AWS --password-stdin $DOCKER_REGISTRY</span>
    <span class="pi">-</span> <span class="s">docker push $DOCKER_REGISTRY/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA</span>

</code></pre></div></div>

<ul>
  <li>æ‰“åŒ…å®Œæˆåéœ€è¦ä¸Šä¼ åˆ° ecrï¼Œè€Œ ecr ä¾èµ–äº† aws cliï¼Œæ‰€ä»¥ä½¿ç”¨äº† aws_cli çš„é•œåƒåŒ…ã€‚åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿˜éœ€è¦å°† AWS çš„ AKSK é…ç½®åˆ°ç¯å¢ƒå˜é‡ã€‚</li>
  <li>åœ¨ before_script é‡Œï¼Œåœ¨ aws_cli é•œåƒé‡Œå®‰è£… dockerï¼Œæ­¤æ—¶ä½¿ç”¨äº† dind (docker in docker) æ¨¡å¼ã€‚</li>
  <li>åœ¨ docker build çš„è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨äº† git çš„ commiot sha ä½œä¸ºç‰ˆæœ¬å·ã€‚ CI_COMMIT_SHORT_SHA æ˜¯ gitlab çš„å†…ç½®ç¯å¢ƒå˜é‡ã€‚</li>
</ul>

<blockquote>
  <p>gitlab çš„ dind å¯ä»¥å‚è€ƒè¿™ä¸ªï¼š<a href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html">https://docs.gitlab.com/ee/ci/docker/using_docker_build.html</a></p>
</blockquote>

<blockquote>
  <p>gitlab å†…ç½®ç¯å¢ƒå˜é‡å‚è€ƒï¼š<a href="https://docs.gitlab.com/ee/ci/variables/predefined_variables.html">https://docs.gitlab.com/ee/ci/variables/predefined_variables.html</a></p>
</blockquote>

<h3 id="éƒ¨ç½²">éƒ¨ç½²</h3>

<p>åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œé‡‡ç”¨äº† gitops çš„æ–¹å¼ï¼Œå°† CI å’Œ CD å®Œå…¨è§£è€¦ï¼ŒCI åªéœ€è¦åšåˆ°æ„å»ºå®Œæˆï¼Œå¹¶æ›´æ–°éƒ¨ç½²ä»£ç ä»“åº“å°±å¯ä»¥äº†ã€‚å‰©ä¸‹çš„å·¥ä½œäº¤ç”± CD æ¥å®Œæˆã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">yaml-change</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">line/kubectl-kustomize</span>
  <span class="na">before_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">apk add git</span>
    <span class="pi">-</span> <span class="s">git clone https://cloudbeer:${GITHUB_PWD}@github.com/cloudbeer/cd-script.git "/${CI_COMMIT_SHA}"</span>
    <span class="pi">-</span> <span class="s">git config --global user.email "cloudbeer@gmail.com"</span>
    <span class="pi">-</span> <span class="s">git config --global user.name "gitlab-robot"</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cd "/${CI_COMMIT_SHA}/gateway"</span>
    <span class="pi">-</span> <span class="s">kustomize edit set image $DOCKER_REGISTRY/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA</span>
    <span class="pi">-</span> <span class="s">cat kustomization.yaml</span>
  <span class="na">after_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cd "/${CI_COMMIT_SHA}"</span>
    <span class="pi">-</span> <span class="s">git add .</span>
    <span class="pi">-</span> <span class="s">git commit -m "[skip ci]updating image $DOCKER_REGISTRY/$CI_COMMIT_SHORT_SHA"</span>
    <span class="pi">-</span> <span class="s">git push origin main</span>
</code></pre></div></div>

<ul>
  <li>é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“åï¼Œå°±å¯ä»¥å»ä¿®æ”¹éƒ¨ç½²ä»£ç äº†ã€‚æœ¬ç¤ºä¾‹å°†éƒ¨ç½²ä»£ç æ”¾åˆ°äº† githubï¼Œæ‚¨å¯ä»¥å°†éƒ¨ç½²ä»£ç æ”¾åˆ°ä»»æ„ git ä»“åº“ã€‚ä½†åœ¨ gitops æ¨¡å¼ä¸‹ï¼Œéƒ¨ç½²è„šæœ¬ä¸å»ºè®®å’Œä¸šåŠ¡æºä»£ç æ”¾åˆ°ä¸€èµ·ã€‚</li>
  <li>æœ¬ç¤ºä¾‹ä½¿ç”¨äº† <a href="https://kustomize.io/">kustomize</a> æ¥æ›´æ–°éƒ¨ç½²ï¼Œkustomize ä¹Ÿè¢« argocd é»˜è®¤æ”¯æŒã€‚</li>
  <li>è¿‡ç¨‹æ˜¯ï¼šå°†éƒ¨ç½²ä»£ç ä» git ä»“åº“æ‹‰å›æœ¬åœ°ï¼Œé€šè¿‡ kustomize å‘½ä»¤ä¿®æ”¹äº† image çš„åœ°å€ï¼Œä¿®æ”¹å®Œæˆåæ¨å› git ä»“åº“ã€‚</li>
</ul>

<blockquote>
  <p>GITHUB_PWD éœ€è¦é…ç½®ä¸€ä¸ª å¸¦æœ‰ scope çš„ tokenï¼Œè¯·åˆ° <a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a> é…ç½®ã€‚</p>
</blockquote>

<p>å®Œæ•´çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">variables</span><span class="pi">:</span>
  <span class="na">DOCKER_REGISTRY</span><span class="pi">:</span> <span class="s">cloudbeer</span>
  <span class="na">DOCKER_DRIVER</span><span class="pi">:</span> <span class="s">overlay</span>
  <span class="na">DOCKER_HOST</span><span class="pi">:</span> <span class="s">tcp://docker:2375</span>

<span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">build</span>
  <span class="pi">-</span> <span class="s">package</span>
  <span class="pi">-</span> <span class="s">deploy</span>

<span class="na">maven-build</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">maven:latest</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">build</span>
  <span class="na">script</span><span class="pi">:</span> <span class="s2">"</span><span class="s">mvn</span><span class="nv"> </span><span class="s">package"</span>
  <span class="na">artifacts</span><span class="pi">:</span>
    <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">target/*.jar</span>

<span class="na">docker-build</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">docker:20</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">package</span>
  <span class="na">services</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker:dind</span>
  <span class="na">before_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker info</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker build -t $DOCKER_REGISTRY/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA .</span>
    <span class="pi">-</span> <span class="s">echo $DOCKER_PASS | docker login -u$DOCKER_USER --password-stdin</span>
    <span class="pi">-</span> <span class="s">docker push $DOCKER_REGISTRY/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA</span>

<span class="na">yaml-change</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">line/kubectl-kustomize</span>
  <span class="na">before_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">apk add git</span>
    <span class="pi">-</span> <span class="s">git clone https://cloudbeer:${GITHUB_PWD}@github.com/cloudbeer/cd-script.git "/${CI_COMMIT_SHA}"</span>
    <span class="pi">-</span> <span class="s">git config --global user.email "cloudbeer@gmail.com"</span>
    <span class="pi">-</span> <span class="s">git config --global user.name "gitlab-robot"</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cd "/${CI_COMMIT_SHA}/gateway"</span>
    <span class="pi">-</span> <span class="s">kustomize edit set image $DOCKER_REGISTRY/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA</span>
    <span class="pi">-</span> <span class="s">cat kustomization.yaml</span>
  <span class="na">after_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cd "/${CI_COMMIT_SHA}"</span>
    <span class="pi">-</span> <span class="s">git add .</span>
    <span class="pi">-</span> <span class="s">git commit -m "[skip ci]updating image $DOCKER_REGISTRY/$CI_COMMIT_SHORT_SHA"</span>
    <span class="pi">-</span> <span class="s">git push origin main</span>
</code></pre></div></div>

<p>å®Œæ•´ä»£ç ä¸æ–‡ç« æ­£æ–‡ä¼šç¨æœ‰å‡ºå…¥ï¼Œæ”¹ç”¨äº†å…¬å¼€çš„ github å’Œ docker hub æ¥å­˜å‚¨ éƒ¨ç½²æ–‡ä»¶ å’Œ é•œåƒã€‚</p>

<h3 id="æœ¬é¡¹ç›®çš„è¿è¡Œå’Œæµ‹è¯•è¿‡ç¨‹">æœ¬é¡¹ç›®çš„è¿è¡Œå’Œæµ‹è¯•è¿‡ç¨‹</h3>

<p>å…‹éš†é¡¹ç›®</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://gitlab.com/cloudbeer/gateway.git
</code></pre></div></div>

<p>ä¸Šä¼ åˆ°æ‚¨è‡ªå·±çš„ gitlab ä»“åº“ï¼Œå¹¶å¯åŠ¨è‡ªåŠ¨æ„å»ºã€‚</p>

<p>ä¿®æ”¹æ„å»ºè„šæœ¬ï¼Œå°† éƒ¨ç½²ä»“åº“ï¼Œé•œåƒä»“åº“åˆ†åˆ«æ”¹æˆæ‚¨è‡ªå·±çš„åœ°å€ã€‚å¹¶å°†ç›¸å…³è´¦å·é…ç½®åˆ° Variables é‡Œã€‚</p>

<p>æ”¹åŠ¨ä»£ç åï¼Œå¦‚æœæ‚¨ä¸æƒ³è®© gitlab è‡ªåŠ¨å¯åŠ¨ pipelineï¼Œåœ¨ commit ä¿¡æ¯é‡ŒåŠ ä¸Š <code class="language-plaintext highlighter-rouge">[skip ci]xxxx</code> å³å¯ã€‚</p>

<p>è§‚å¯Ÿæ„å»ºè¿‡ç¨‹ï¼ŒæˆåŠŸåï¼Œå¯ä»¥çœ‹åˆ°é•œåƒä»“åº“ä¸­å¢åŠ äº† ç‰ˆæœ¬(tag)ï¼Œ éƒ¨ç½²ä»“åº“ä¸­çš„ gateway ç›®å½•é‡Œçš„ kustomization.yaml è¢«ä¿®æ”¹ã€‚</p>

<hr />

<p>æœ¬æ–‡æ¶‰åŠçš„ä¸‰ä¸ªå¤–éƒ¨ä»“åº“ï¼Œè¿™ä¸‰ä¸ªä»“åº“å‡ä¸º publicï¼š</p>

<p>ä¸šåŠ¡æºä»£ç ï¼š<a href="https://gitlab.com/cloudbeer/gateway">https://gitlab.com/cloudbeer/gateway</a></p>

<p>éƒ¨ç½²ä»“åº“ï¼š<a href="https://github.com/cloudbeer/cd-script">https://github.com/cloudbeer/cd-script</a></p>

<p>é•œåƒä»“åº“ï¼š<a href="https://hub.docker.com/r/cloudbeer/gateway/tags">https://hub.docker.com/r/cloudbeer/gateway/tags</a></p>]]></content><author><name></name></author><category term="devops" /><summary type="html"><![CDATA[å½“ä¸‹ Gitlab å…·å¤‡äº† CI/CD èƒ½åŠ›ã€‚ å…¶ CI æµæ°´çº¿ ä¸»è¦å®šä¹‰åœ¨æºä»£ç æ ¹ç›®å½•çš„ .gitlab-ci.yml çš„æ–‡ä»¶é‡Œã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦æè¿°äº†å¦‚ä½•ç¼–å†™ gitops æ–¹å¼çš„ gitlab-ci æ–‡ä»¶ã€‚]]></summary></entry><entry><title type="html">åœ¨ K8S ä¸­å®ç° ç°åº¦ï¼Œè“ç»¿ å‘å¸ƒ</title><link href="https://cloudbeer.github.io/2022/12/k8s-gray-blue-green.html" rel="alternate" type="text/html" title="åœ¨ K8S ä¸­å®ç° ç°åº¦ï¼Œè“ç»¿ å‘å¸ƒ" /><published>2022-12-01T08:09:00+00:00</published><updated>2022-12-01T08:09:00+00:00</updated><id>https://cloudbeer.github.io/2022/12/k8s-gray-blue-green</id><content type="html" xml:base="https://cloudbeer.github.io/2022/12/k8s-gray-blue-green.html"><![CDATA[<p>åœ¨åŸºæœ¬çš„ K8S ä¸­ï¼Œæ²¡æœ‰æä¾›æ–¹ä¾¿ç»†ç²’åº¦çš„æµé‡åˆ†é…ç­–ç•¥ã€‚ä½†å€ŸåŠ© K8S çš„ selector æœºåˆ¶ï¼Œä»ç„¶å¯ä»¥å®ç°ç®€å•çš„ç°åº¦å’Œè“ç»¿å‘å¸ƒã€‚</p>

<h2 id="åº”ç”¨éƒ¨ç½²">åº”ç”¨éƒ¨ç½²</h2>

<p>åº”ç”¨ç‰ˆæœ¬ 1</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ng-v1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">4</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">ng</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">ng</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ng</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:1.22</span>
</code></pre></div></div>

<p>åº”ç”¨ç‰ˆæœ¬ 2</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ng-v2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">ng</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">ng</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v2</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ng</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">kong/httpbin</span>
</code></pre></div></div>

<ul>
  <li>ä¸ºäº†æ¼”ç¤ºç‰ˆæœ¬ä¸åŒï¼Œåˆ†åˆ«éƒ¨ç½²äº† 2 ä¸ªå®Œå…¨ä¸åŒçš„åº”ç”¨ä½œä¸ºæ¼”ç¤ºã€‚</li>
  <li>è¿™ä¿©åº”ç”¨æœ‰ç€ç›¸åŒçš„ label: app ä»¥åŠä¸åŒçš„ label: version</li>
</ul>

<h2 id="ç°åº¦å‘å¸ƒ">ç°åº¦å‘å¸ƒ</h2>

<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª serviceï¼Œè¿™ä¸ª service å¯¹å¤–æš´éœ²æœåŠ¡ä½¿ç”¨äº† app=ng ä½œä¸ºé€‰æ‹©å™¨ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ng</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">ng</span>
</code></pre></div></div>

<p>ç”±äº service æœ¬èº«æ˜¯æŒ‰ç…§ RR çš„ç­–ç•¥è¿›è¡Œè½®è¯¢çš„ï¼Œæ‰€æœ‰å¯¹åº”çš„ pod endpoint å¾—åˆ°çš„æµé‡ä¼šä¿æŒä¸€è‡´ã€‚</p>

<p>æ‰€ä»¥ä¸Šè¿°ä»£ç ä¸­ï¼Œæµé‡ä¼šæŒ‰ç…§ pod æ•°é‡åˆ†é…ï¼Œæ­¤ç¤ºä¾‹ä¸­ v1:v2 æµé‡æ¯”ä¾‹ä¸º 4:1ã€‚é€šè¿‡æ”¹å˜ pod çš„æ•°é‡å°±å¯ä»¥å®ç°<strong>ç²—ç³™çš„</strong>ç°åº¦äº†ã€‚</p>

<p>å¯åŠ¨ä¸€ä¸ª pod æµ‹è¯•ä¸€ä¸‹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nb">test</span> <span class="nt">--image</span><span class="o">=</span>nginx:1.22 <span class="nt">--restart</span><span class="o">=</span>Never <span class="nt">--</span> sh
</code></pre></div></div>

<p>åœ¨ç»ˆç«¯ä¸­é‡å¤æ‰§è¡Œå¤šæ¬¡ curlï¼ŒæŸ¥çœ‹ä¼šå‘ç°æµé‡æŒ‰ç…§ 4:1 çš„æ¯”ä¾‹åˆ†é…äº†ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl ng
</code></pre></div></div>

<p>è¿™ä¸ª bash ä»£ç æ¨¡æ‹Ÿäº†æ¯éš” 5 ç§’é€æ­¥å¢åŠ  V2 çš„æµé‡ï¼Œé€šè¿‡ 4 æ¬¡æ”¹å˜ pod æ•°é‡ï¼Œæœ€ç»ˆå°†æµé‡å®Œå…¨åˆ‡æ¢åˆ° v2ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nv">v1count</span><span class="o">=</span>5
<span class="nv">v2count</span><span class="o">=</span>0
<span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..5<span class="o">}</span>
<span class="k">do
  </span><span class="nv">v1count</span><span class="o">=</span><span class="k">$((</span>v1count-1<span class="k">))</span>
  <span class="nv">v2count</span><span class="o">=</span><span class="k">$((</span>v2count+1<span class="k">))</span>
  kubectl scale deployment ng-v1 <span class="nt">--replicas</span> <span class="nv">$v1count</span>
  kubectl scale deployment ng-v2 <span class="nt">--replicas</span> <span class="nv">$v2count</span>
  <span class="nb">sleep </span>5
<span class="k">done</span>
</code></pre></div></div>

<p>è¿™ä¸ªæ–¹æ³•ä¸é€‚åˆå¦‚ä¸‹æƒ…å†µï¼š</p>

<ul>
  <li>podæ•°é‡åªæœ‰ä¸€ä¸¤ä¸ªçš„</li>
  <li>éœ€æŒ‰ä¸€å®šè§„åˆ™ç°åº¦</li>
</ul>

<h2 id="è“ç»¿å‘å¸ƒ">è“ç»¿å‘å¸ƒ</h2>

<p>éœ€è¦ä¿®æ”¹ serviceï¼Œå¢åŠ ä¸€ä¸ªç‰ˆæœ¬çš„ selectorï¼Œè®© service å›ºå®šåœ¨ç‰¹å®šç‰ˆæœ¬ï¼š</p>

<p>å½“åº”ç”¨æ˜¯ç‰ˆæœ¬ v1 çš„æ—¶å€™ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ng</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">ng</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
</code></pre></div></div>

<p>å®é™…ç”Ÿäº§ä¸­ï¼Œå…ˆéƒ¨ç½²å¥½ v2 ç‰ˆæœ¬ï¼Œå½“éªŒè¯æ— è¯¯åï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ service çš„ version ä¸º v2 ã€‚</p>

<p>ç°åœ¨æµ‹è¯•ä¸€ä¸‹ï¼š</p>

<p>å…ˆå°† 2 ä¸ªç‰ˆæœ¬éƒ¨ç½²æˆç­‰é‡ podã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl scale deployment ng-v1 <span class="nt">--replicas</span> 1

kubectl scale deployment ng-v2 <span class="nt">--replicas</span> 1
</code></pre></div></div>

<p>åˆå§‹çš„ service ä¸ºç‰ˆæœ¬ v1ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: ng
spec:
  ports:
    - port: 80
  selector:
    app: ng
    version: v1
</span><span class="no">EOF
</span></code></pre></div></div>

<p>ç°åœ¨åˆ‡æ¢åˆ° v2 ç‰ˆæœ¬ï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl patch svc ng <span class="nt">-p</span> <span class="s1">'{"spec":{"selector": {"app": "ng", "version": "v2"}}}'</span>
</code></pre></div></div>

<h2 id="ab-test-å‘å¸ƒ">A/B test å‘å¸ƒ</h2>

<p>A/B test æ„å‘³ç€éœ€è¦æŒ‰ç…§ä¸€å®šé€»è¾‘è¿›è¡Œæµé‡åˆ†å‘ã€‚</p>

<blockquote>
  <p>ğŸ˜­ï¼Œè‡£å¦¾åšä¸åˆ°ã€‚</p>
</blockquote>

<p>ä½†å¯ä»¥å€ŸåŠ© nginx ç­‰äº§å“å®Œæˆã€‚</p>

<p>äº‹å®ä¸Šï¼Œä¸€äº›ç¬¬ä¸‰æ–¹çš„ ingress äº§å“ï¼Œä»¥åŠ Service Mesh å°±éƒ½å¯ä»¥è§£å†³è¿™äº›é—®é¢˜çš„ã€‚</p>

<p>å¦‚æœå¯¹å»¶è¿Ÿä¸æ•æ„Ÿï¼Œå¯ä»¥è€ƒè™‘ç›´æ¥ä¸Š Istio æˆ– Linkerd ç­‰ Service Mesh äº§å“ã€‚</p>]]></content><author><name></name></author><category term="container," /><category term="devops" /><summary type="html"><![CDATA[åœ¨åŸºæœ¬çš„ K8S ä¸­ï¼Œæ²¡æœ‰æä¾›æ–¹ä¾¿ç»†ç²’åº¦çš„æµé‡åˆ†é…ç­–ç•¥ã€‚ä½†å€ŸåŠ© K8S çš„ selector æœºåˆ¶ï¼Œä»ç„¶å¯ä»¥å®ç°ç®€å•çš„ç°åº¦å’Œè“ç»¿å‘å¸ƒã€‚]]></summary></entry><entry><title type="html">Apache Airflow å…¥é—¨</title><link href="https://cloudbeer.github.io/2022/12/airflow-start.html" rel="alternate" type="text/html" title="Apache Airflow å…¥é—¨" /><published>2022-12-01T04:57:44+00:00</published><updated>2022-12-01T04:57:44+00:00</updated><id>https://cloudbeer.github.io/2022/12/airflow-start</id><content type="html" xml:base="https://cloudbeer.github.io/2022/12/airflow-start.html"><![CDATA[<p>ä»å°ç™½åˆ°ç•¥çŸ¥ä¸€äºŒã€‚</p>

<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>

<p>éƒ½è¯´ Airflow å¾ˆå¼ºå¤§ï¼Œç”¨ python è¯­è¨€å†™ DAGã€‚</p>

<p>å¯¹äºæˆ‘ï¼Œè¯­è¨€ä¸é‡è¦ï¼Œäº†è§£ä»–çš„è¿è¡Œæ¶æ„å’Œè®¾è®¡æ€æƒ³æ›´é‡è¦ã€‚</p>

<p>å…ˆå®‰è£…ä¸€ä¸ªå•æœºç‰ˆæœ¬è¯•è¯•ã€‚</p>

<h2 id="å®‰è£…">å®‰è£…</h2>

<p>åœ¨ Mac M1 ä¸Šé»˜è®¤å®‰è£…å„ç§ç¼–è¯‘é”™è¯¯ï¼Œç„¶åä½¿ç”¨ <strong>conda</strong> é‡æ–°å®‰è£…äº† pythonï¼Œç»ˆäºæå®šã€‚</p>

<p>å®‰è£…è¿‡ç¨‹å¤åˆ¶è‡ªå®˜æ–¹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">AIRFLOW_VERSION</span><span class="o">=</span>2.4.3
<span class="nv">PYTHON_VERSION</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>python <span class="nt">--version</span> | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s2">" "</span> <span class="nt">-f</span> 2 | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s2">"."</span> <span class="nt">-f</span> 1-2<span class="si">)</span><span class="s2">"</span>
<span class="nv">CONSTRAINT_URL</span><span class="o">=</span><span class="s2">"https://raw.githubusercontent.com/apache/airflow/constraints-</span><span class="k">${</span><span class="nv">AIRFLOW_VERSION</span><span class="k">}</span><span class="s2">/constraints-</span><span class="k">${</span><span class="nv">PYTHON_VERSION</span><span class="k">}</span><span class="s2">.txt"</span>
pip <span class="nb">install</span> <span class="s2">"apache-airflow==</span><span class="k">${</span><span class="nv">AIRFLOW_VERSION</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--constraint</span> <span class="s2">"</span><span class="k">${</span><span class="nv">CONSTRAINT_URL</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div></div>

<p>å¯åŠ¨ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬è¯•è¯•ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>airflow standalone
</code></pre></div></div>

<p>æˆåŠŸå¯åŠ¨åï¼Œæ§åˆ¶å°æ‰“å°äº†ä¸€äº›æœ‰ç”¨ä¿¡æ¯ã€‚æœ¬æœº Web ç«¯é»˜è®¤ä¸ºï¼š <code class="language-plaintext highlighter-rouge">http://localhost:8080</code>ã€‚</p>

<p>ç™»å½•è´¦å·ä¹Ÿåœ¨æ§åˆ¶å°ä¸­æ‰“å°ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>standalone |
standalone | Airflow is ready
standalone | Login with username: admin  password: xxxxxxxxxx
standalone | Airflow Standalone is <span class="k">for </span>development purposes only. Do not use this <span class="k">in </span>production!
standalone |
</code></pre></div></div>

<p>è¿›å…¥ä¹‹åï¼Œæœ‰å¾ˆå¤šç°æˆçš„ DAGï¼Œä¸€å¤´é›¾æ°´ã€‚</p>

<p>æˆ–è€…<strong>èµ°ä¸‹é¢è¿™ä¸ªæ­¥éª¤ï¼Œéƒ½å·®ä¸å¤šã€‚</strong></p>

<p>åˆå§‹åŒ–æ•°æ®åº“ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>airflow db init
</code></pre></div></div>

<p>è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸ªè­¦å‘Šï¼Œæ˜¯è¯´è¦å®‰è£… kubernetes çš„ excutorã€‚é¡ºæ‰‹ç»™ä»–è£…ä¸€ä¸‹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>apache-airflow-providers-cncf-kubernetes
</code></pre></div></div>

<p>åˆ›å»ºä¸€ä¸ªæ–°è´¦å·</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>airflow <span class="nb">users </span>create <span class="se">\</span>
    <span class="nt">--username</span> xie <span class="se">\</span>
    <span class="nt">--firstname</span> Cloudbeer <span class="se">\</span>
    <span class="nt">--lastname</span> Xie <span class="se">\</span>
    <span class="nt">--role</span> Admin <span class="se">\</span>
    <span class="nt">--email</span> cloudbeer@gmail.com
</code></pre></div></div>

<p>æ¢ä¸ªç«¯å£å¯åŠ¨ Web Server</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>airflow webserver <span class="nt">--port</span> 9000
</code></pre></div></div>

<p>æ¢ä¸ª ç»ˆç«¯çª—å£å¯åŠ¨ Schedulerï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>airflow scheduler
</code></pre></div></div>

<h2 id="ç¼–å†™ç¬¬ä¸€ä¸ª-dag">ç¼–å†™ç¬¬ä¸€ä¸ª DAG</h2>

<p>Airflow çš„ hello world ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
<span class="kn">from</span> <span class="nn">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>

<span class="kn">from</span> <span class="nn">airflow.operators.bash</span> <span class="kn">import</span> <span class="n">BashOperator</span>
<span class="k">with</span> <span class="n">DAG</span><span class="p">(</span>
    <span class="s">'hellodag'</span><span class="p">,</span>
    <span class="n">default_args</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'depends_on_past'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">'email'</span><span class="p">:</span> <span class="p">[</span><span class="s">'cloudbeer@gmail.com'</span><span class="p">],</span>
        <span class="s">'email_on_failure'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">'email_on_retry'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">'retries'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">'retry_delay'</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="n">description</span><span class="o">=</span><span class="s">'è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ DAG'</span><span class="p">,</span>
    <span class="n">schedule</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">catchup</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s">'example'</span><span class="p">],</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s">'print_date'</span><span class="p">,</span>
        <span class="n">bash_command</span><span class="o">=</span><span class="s">'date'</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">t2</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s">'sleep'</span><span class="p">,</span>
        <span class="n">depends_on_past</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">bash_command</span><span class="o">=</span><span class="s">'sleep 5'</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">t1</span><span class="p">.</span><span class="n">doc_md</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="s">"""</span><span class="se">\
</span><span class="s">    #### Task Documentation
    You can document your task using the attributes `doc_md` (markdown),
    `doc` (plain text), `doc_rst`, `doc_json`, `doc_yaml` which gets
    rendered in the UI's Task Instance Details page.
    ![img](http://montcs.bloomu.edu/~bobmon/Semesters/2012-01/491/import%20soul.png)
    **Image Credit:** Randall Munroe, [XKCD](https://xkcd.com/license.html)
    """</span>
    <span class="p">)</span>

    <span class="n">dag</span><span class="p">.</span><span class="n">doc_md</span> <span class="o">=</span> <span class="s">"""
    è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ DAGã€‚
    """</span> 


    <span class="n">templated_command</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
        <span class="s">"""
    {% for i in range(5) %}
        echo "{{ ds }}"
        echo "{{ macros.ds_add(ds, 7)}}"
    {% endfor %}
        """</span>
    <span class="p">)</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s">'templated'</span><span class="p">,</span>
        <span class="n">depends_on_past</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">bash_command</span><span class="o">=</span><span class="n">templated_command</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">t1</span> <span class="o">&gt;&gt;</span> <span class="p">[</span><span class="n">t2</span><span class="p">,</span> <span class="n">t3</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>ä¸Šé¢çš„ä»£ç ä¿®æ”¹ DAG çš„åå­—ä¸º hellodag</li>
  <li>æ–‡ä»¶åå‘½åä¸º hellodag.py</li>
</ul>

<p>å°†è¿™ä¸ªæ–‡ä»¶æ”¾åˆ° ~/airflow/dags ç›®å½•ä¸‹ã€‚</p>

<p>ä½¿ç”¨ python éªŒè¯ä¸€ä¸‹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python hellodag.py
</code></pre></div></div>

<p>æ²¡æœ‰é”™è¯¯ã€‚</p>

<h2 id="airflow-ä»»åŠ¡æµ‹è¯•">Airflow ä»»åŠ¡æµ‹è¯•</h2>

<p>dag æ–‡ä»¶æ”¾åˆ°äº†å¯¹åº”çš„ç›®å½•äº†ï¼Œç°åœ¨æŸ¥çœ‹ä¸€ä¸‹ dagsã€‚ï¼ˆåˆè¦å¼€ä¸€ä¸ªç»ˆç«¯ï¼‰</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>airflow dags list
</code></pre></div></div>

<ul>
  <li>hellodag å·²ç»å‡ºç°åœ¨åˆ—è¡¨äº†ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>airflow tasks list hellodag <span class="nt">--tree</span>
</code></pre></div></div>

<ul>
  <li>è¿™ä¸ªå‘½ä»¤å¯ä»¥çœ‹åˆ°è¿™ä¸ª dag åŒ…å«äº†ä¸‰ä¸ªä»»åŠ¡ <code class="language-plaintext highlighter-rouge">print_date</code>, <code class="language-plaintext highlighter-rouge">sleep</code>, <code class="language-plaintext highlighter-rouge">templated</code></li>
  <li>â€“tree æ˜¾ç¤ºäº†ä¾èµ–å…³ç³»ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Task<span class="o">(</span>BashOperator<span class="o">)</span>: print_date&gt;
    &lt;Task<span class="o">(</span>BashOperator<span class="o">)</span>: <span class="nb">sleep</span><span class="o">&gt;</span>
    &lt;Task<span class="o">(</span>BashOperator<span class="o">)</span>: templated&gt;
</code></pre></div></div>

<p>æµ‹è¯•ä¸€ä¸‹ä»»åŠ¡ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>airflow tasks <span class="nb">test </span>hellodag print_date 2015-06-01

airflow tasks <span class="nb">test </span>hellodag <span class="nb">sleep </span>2015-06-01

airflow tasks <span class="nb">test </span>hellodag templated 2015-06-01
</code></pre></div></div>

<p>è¿è¡Œ backfill (å›å¡«)</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>airflow dags backfill hellodag <span class="se">\</span>
    <span class="nt">--start-date</span> 2015-06-01 <span class="se">\</span>
    <span class="nt">--end-date</span> 2015-06-07
</code></pre></div></div>

<p>å¥½äº†ã€‚å…¥äº†ä¸ªé—¨ã€‚æˆ‘å»ç ”ç©¶ Airflow in K8S äº†ã€‚</p>]]></content><author><name></name></author><category term="data" /><summary type="html"><![CDATA[ä»å°ç™½åˆ°ç•¥çŸ¥ä¸€äºŒã€‚]]></summary></entry><entry><title type="html">ä½¿ç”¨ CDK å®‰è£… Karpenter æ–°ç‰ˆ</title><link href="https://cloudbeer.github.io/2022/11/cdk-install-karpenter-1.9.2.html" rel="alternate" type="text/html" title="ä½¿ç”¨ CDK å®‰è£… Karpenter æ–°ç‰ˆ" /><published>2022-11-30T13:49:06+00:00</published><updated>2022-11-30T13:49:06+00:00</updated><id>https://cloudbeer.github.io/2022/11/cdk-install-karpenter-1.9.2</id><content type="html" xml:base="https://cloudbeer.github.io/2022/11/cdk-install-karpenter-1.9.2.html"><![CDATA[<p>æœ¬æ–‡è®°å½•äº†ä½¿ç”¨ CDK (2.53.0) å®‰è£… Karpenter (v0.19.2) çš„æ–¹æ³•ã€‚</p>

<h2 id="cdk-å’Œ-karpenter-åˆ†åˆ«æ˜¯ä»€ä¹ˆ">CDK å’Œ Karpenter åˆ†åˆ«æ˜¯ä»€ä¹ˆ</h2>

<p>è¿™ä¸ªé—®é¢˜å…ˆä¸ç»†è¯´äº†å§ï¼Œåé¢ä¼šå‘æ–‡ç« è¡¥ã€‚</p>

<p>å¯ä»¥å»ç›¸åº”å®˜æ–¹ç½‘ç«™æŸ¥çœ‹ï¼š</p>

<p><a href="https://aws.amazon.com/cn/cdk/">CDK</a></p>

<p><a href="https://karpenter.sh/">Karpenter</a></p>

<p>åæ­£å¥½æœ‰ä¸€æ¯”ï¼š</p>

<ul>
  <li>CDK ç±»ä¼¼äº terraformã€‚</li>
  <li>Karpenter å°±æ˜¯ K8S çš„èŠ‚ç‚¹ä¼¸ç¼©å™¨ã€‚</li>
</ul>

<h2 id="é€‚ç”¨æ€§">é€‚ç”¨æ€§</h2>

<p>CDK å’Œ Karpenter å½“ä¸‹è¿™ä¸ªæ—¶é—´ç‚¹æ­£åœ¨ä»¥å¤©ä¸ºå•ä½ <strong>ç–¯ç‹‚å‘ç‰ˆ</strong>ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« å…·æœ‰æ—¶æ•ˆæ€§ã€‚</p>

<p>å½“å‰æœ€æ–°ç‰ˆæœ¬ä¸ºï¼š</p>

<p>CDK çš„ç‰ˆæœ¬ä¸ºï¼š<strong>2.53.0</strong></p>

<p>Karpenter çš„ç‰ˆæœ¬ä¸ºï¼š <strong>v0.19.2</strong></p>

<h2 id="show-me-the-code">Show me the code</h2>

<p>å…ˆä¸Šä»£ç ä¸ºæ•¬ï¼</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Cluster</span><span class="p">,</span> <span class="nx">HelmChart</span><span class="p">,</span> <span class="nx">KubernetesManifest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">aws-cdk-lib/aws-eks</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">CfnInstanceProfile</span><span class="p">,</span> <span class="nx">CfnServiceLinkedRole</span><span class="p">,</span> <span class="nx">IRole</span><span class="p">,</span> <span class="nx">ManagedPolicy</span><span class="p">,</span> <span class="nx">PolicyDocument</span><span class="p">,</span> <span class="nx">Role</span><span class="p">,</span> <span class="nx">ServicePrincipal</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">aws-cdk-lib/aws-iam</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">KarpenterControllerPolicy</span> <span class="o">=</span> <span class="p">{</span>
  <span class="dl">"</span><span class="s2">Version</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2012-10-17</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">Statement</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="dl">"</span><span class="s2">Effect</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Allow</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">Action</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">ec2:CreateLaunchTemplate</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:CreateFleet</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:RunInstances</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:CreateTags</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:TerminateInstances</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:DeleteLaunchTemplate</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:DescribeLaunchTemplates</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:DescribeInstances</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:DescribeSecurityGroups</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:DescribeSubnets</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:DescribeImages</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:DescribeInstanceTypes</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:DescribeInstanceTypeOfferings</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:DescribeAvailabilityZones</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ssm:GetParameter</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">pricing:GetProducts</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">ec2:DescribeSpotPriceHistory</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">sqs:DeleteMessage</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">sqs:GetQueueUrl</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">sqs:GetQueueAttributes</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">sqs:ReceiveMessage</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">iam:PassRole</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">],</span>
      <span class="dl">"</span><span class="s2">Resource</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">*</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">};</span>


<span class="k">export</span> <span class="kd">class</span> <span class="nx">KarpenterAddon</span> <span class="p">{</span>
  <span class="nl">cluster</span><span class="p">:</span> <span class="nx">Cluster</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">cluster</span><span class="p">:</span> <span class="nx">Cluster</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cluster</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">;</span>


    <span class="k">this</span><span class="p">.</span><span class="nx">createNodeRole</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">createKarpeter</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">createNodeRole</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">new</span> <span class="nx">CfnServiceLinkedRole</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span> <span class="dl">'</span><span class="s1">SpotSLR</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">awsServiceName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">spot.amazonaws.com</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">});</span>
    <span class="kd">const</span> <span class="nx">karpenterNodeRole</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Role</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span> <span class="dl">'</span><span class="s1">karpenter-node-role</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">assumedBy</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ServicePrincipal</span><span class="p">(</span><span class="s2">`ec2.</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">urlSuffix</span><span class="p">}</span><span class="s2">`</span><span class="p">),</span>
      <span class="na">managedPolicies</span><span class="p">:</span> <span class="p">[</span>
        <span class="nx">ManagedPolicy</span><span class="p">.</span><span class="nx">fromAwsManagedPolicyName</span><span class="p">(</span><span class="dl">"</span><span class="s2">AmazonEKSWorkerNodePolicy</span><span class="dl">"</span><span class="p">),</span>
        <span class="nx">ManagedPolicy</span><span class="p">.</span><span class="nx">fromAwsManagedPolicyName</span><span class="p">(</span><span class="dl">"</span><span class="s2">AmazonEKS_CNI_Policy</span><span class="dl">"</span><span class="p">),</span>
        <span class="nx">ManagedPolicy</span><span class="p">.</span><span class="nx">fromAwsManagedPolicyName</span><span class="p">(</span><span class="dl">"</span><span class="s2">AmazonEC2ContainerRegistryReadOnly</span><span class="dl">"</span><span class="p">),</span>
        <span class="nx">ManagedPolicy</span><span class="p">.</span><span class="nx">fromAwsManagedPolicyName</span><span class="p">(</span><span class="dl">"</span><span class="s2">AmazonSSMManagedInstanceCore</span><span class="dl">"</span><span class="p">),</span>
      <span class="p">],</span>
      <span class="na">roleName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">KarpenterNodeRole-</span><span class="dl">'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">clusterName</span>
    <span class="p">});</span>

    <span class="k">new</span> <span class="nx">CfnInstanceProfile</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span> <span class="dl">'</span><span class="s1">karpenter</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">roles</span><span class="p">:</span> <span class="p">[</span><span class="nx">karpenterNodeRole</span><span class="p">.</span><span class="nx">roleName</span><span class="p">],</span>
      <span class="na">instanceProfileName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">KarpenterNodeInstanceProfile-</span><span class="dl">'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">clusterName</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">awsAuth</span><span class="p">.</span><span class="nx">addRoleMapping</span><span class="p">(</span><span class="nx">karpenterNodeRole</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">groups</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">system:bootstrapper</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">system:nodes</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">username</span><span class="p">:</span> <span class="dl">'</span><span class="s1">system:node:</span><span class="dl">'</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">createKarpeter</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">ns</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">KubernetesManifest</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span> <span class="dl">"</span><span class="s2">karpenter-ns</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">cluster</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span>
      <span class="na">manifest</span><span class="p">:</span> <span class="p">[{</span>
        <span class="na">apiVersion</span><span class="p">:</span> <span class="dl">'</span><span class="s1">v1</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">kind</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Namespace</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">metadata</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">karpenter</span><span class="dl">'</span><span class="p">,</span>
        <span class="p">}</span>
      <span class="p">}],</span>
      <span class="na">overwrite</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">prune</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">sa</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">addServiceAccount</span><span class="p">(</span><span class="dl">"</span><span class="s2">karpenter-sa</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">karpenter</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">namespace</span><span class="p">:</span> <span class="dl">'</span><span class="s1">karpenter</span><span class="dl">'</span>
    <span class="p">});</span>
    <span class="nx">sa</span><span class="p">.</span><span class="nx">role</span><span class="p">.</span><span class="nx">addManagedPolicy</span><span class="p">(</span><span class="k">new</span> <span class="nx">ManagedPolicy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span> <span class="dl">'</span><span class="s1">karpenter-node-policy</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">document</span><span class="p">:</span> <span class="nx">PolicyDocument</span><span class="p">.</span><span class="nx">fromJson</span><span class="p">(</span><span class="nx">KarpenterControllerPolicy</span><span class="p">),</span>
    <span class="p">}))</span>
    <span class="nx">sa</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">addDependency</span><span class="p">(</span><span class="nx">ns</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">helm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HelmChart</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span> <span class="dl">"</span><span class="s2">karpenter-chart</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">cluster</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span>
      <span class="na">namespace</span><span class="p">:</span> <span class="dl">'</span><span class="s1">karpenter</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">chart</span><span class="p">:</span> <span class="dl">'</span><span class="s1">oci://public.ecr.aws/karpenter/karpenter</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">repository</span><span class="p">:</span> <span class="dl">'</span><span class="s1">oci://public.ecr.aws/karpenter/karpenter</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">release</span><span class="p">:</span> <span class="dl">"</span><span class="s2">karpenter</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">version</span><span class="p">:</span> <span class="dl">"</span><span class="s2">v0.19.2</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">values</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">serviceAccount</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">create</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">karpenter</span><span class="dl">"</span>
        <span class="p">},</span>
        <span class="dl">"</span><span class="s2">serviceAccount.annotations</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">eks.amazonaws.com/role-arn</span><span class="dl">"</span><span class="p">:</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">role</span><span class="p">.</span><span class="nx">roleArn</span>
        <span class="p">},</span>
        <span class="na">settings</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">aws</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">clusterEndpoint</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">clusterEndpoint</span><span class="p">,</span>
            <span class="na">clusterName</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">clusterName</span><span class="p">,</span>
            <span class="na">defaultInstanceProfile</span><span class="p">:</span> <span class="dl">'</span><span class="s1">KarpenterNodeInstanceProfile-</span><span class="dl">'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">clusterName</span><span class="p">,</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">helm</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">addDependency</span><span class="p">(</span><span class="nx">ns</span><span class="p">);</span>
    <span class="nx">helm</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">addDependency</span><span class="p">(</span><span class="nx">sa</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„ä»£ç å¤§æ¦‚è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<ul>
  <li>åˆ›å»ºä¸€ä¸ªè§’è‰²ï¼Œè¿™ä¸ªæ‹¥æœ‰è§’è‰²æœ‰ <code class="language-plaintext highlighter-rouge">AmazonEKSWorkerNodePolicy</code> <code class="language-plaintext highlighter-rouge">AmazonEKS_CNI_Policy</code> <code class="language-plaintext highlighter-rouge">AmazonEC2ContainerRegistryReadOnly</code> <code class="language-plaintext highlighter-rouge">AmazonSSMManagedInstanceCore</code> å‡ ä¸ªé¢„è®¾ç­–ç•¥ã€‚ æœªæ¥ Kapenter ä¼šå°†è¿™ä¸ªè§’è‰²èµ‹äºˆ Nodeã€‚</li>
  <li>åœ¨ karpenter è¿™ä¸ªå‘½åç©ºé—´ä¸‹åˆ›å»ºä¸€ç³»åˆ—èµ„æºï¼ŒåŒ…æ‹¬ï¼š
    <ul>
      <li>IRSAï¼šå°† K8S çš„ Service Account ä¸ IAM çš„ Role å»ºç«‹å…³è”ã€‚</li>
      <li>é€šè¿‡ Helm å®‰è£… Karpenterã€‚</li>
    </ul>
  </li>
</ul>

<h2 id="ä¸Šé¢ä»£ç çš„å‘">ä¸Šé¢ä»£ç çš„å‘</h2>

<p>å‘ä¸»è¦é›†ä¸­åœ¨ Helm å›¾æ ·çš„å®‰è£…ï¼š</p>

<ol>
  <li>CDK çš„ HelmChart å¯¹äº oci åº“çš„æ”¯æŒå¤„äºèµ·æ­¥é˜¶æ®µï¼Œç»è¿‡å¤šæ¬¡è¯•éªŒä»¥åŠé˜…è¯»ç›¸å…³æºç ï¼Œæ‰ç¡®è®¤å†™æ³•ï¼š<code class="language-plaintext highlighter-rouge">chart: 'oci://public.ecr.aws/karpenter/karpenter'</code>ï¼Œ<code class="language-plaintext highlighter-rouge">repository: 'oci://public.ecr.aws/karpenter/karpenter'</code>ã€‚</li>
  <li>Karpenter HelmChart å¯¹äº values çš„å†™æ³•ï¼Œè¿™ä¸ªå’Œå®˜ç½‘ä¸ä¸€æ ·ï¼Œå¦‚æœæŒ‰ç…§ terraform çš„å†™æ³•ä¼šå®Œå…¨æ— æ•ˆï¼Œterraform çš„å†™æ³•æ˜¯ï¼šâ€settings.aws.clusterEndpointâ€ï¼Œè€Œè¿™é‡Œçš„å†™æ³•<strong>å¿…é¡»æ˜¯</strong> JSON æ ¼å¼ã€‚</li>
</ol>]]></content><author><name></name></author><category term="container," /><category term="iac," /><category term="aws," /><category term="cloud-provider" /><summary type="html"><![CDATA[æœ¬æ–‡è®°å½•äº†ä½¿ç”¨ CDK (2.53.0) å®‰è£… Karpenter (v0.19.2) çš„æ–¹æ³•ã€‚]]></summary></entry><entry><title type="html">æ­£å¼å¼€å¼ </title><link href="https://cloudbeer.github.io/2022/11/cloudbeer-first.html" rel="alternate" type="text/html" title="æ­£å¼å¼€å¼ " /><published>2022-11-30T12:12:44+00:00</published><updated>2022-11-30T12:12:44+00:00</updated><id>https://cloudbeer.github.io/2022/11/cloudbeer-first</id><content type="html" xml:base="https://cloudbeer.github.io/2022/11/cloudbeer-first.html"><![CDATA[<p>å¼€å¼ å’¯</p>

<h2 id="å¼€å¼ å’¯">å¼€å¼ å’¯</h2>

<p>è¯´ç‚¹å•¥å‘¢ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ã€‚</p>

<h2 id="å…³äº-jekyll">å…³äº jekyll</h2>

<p>ruby æœ‰ç‚¹è›‹ç–¼ï¼Œgem åˆæ˜¯ä¸ªå•¥ï¼Œbundle å‘¢ï¼Ÿ</p>

<p>èƒ½ç”¨å°±å¥½ï¼</p>

<p>æœ¬åœ°å¯åŠ¨åŠ¨æ€åŠ è½½æ˜¯:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jekyll serve <span class="nt">--livereload</span>
</code></pre></div></div>

<p>æˆ‘å…ˆæ¨åˆ° github è¯•è¯•å’¯ã€‚</p>]]></content><author><name></name></author><category term="tucao" /><summary type="html"><![CDATA[å¼€å¼ å’¯]]></summary></entry><entry><title type="html">phpåº”ç”¨å®¹å™¨åŒ–éƒ¨ç½²å®è·µ</title><link href="https://cloudbeer.github.io/2022/01/deploy-php-in-k8s.html" rel="alternate" type="text/html" title="phpåº”ç”¨å®¹å™¨åŒ–éƒ¨ç½²å®è·µ" /><published>2022-01-21T02:56:53+00:00</published><updated>2022-01-21T02:56:53+00:00</updated><id>https://cloudbeer.github.io/2022/01/deploy-php-in-k8s</id><content type="html" xml:base="https://cloudbeer.github.io/2022/01/deploy-php-in-k8s.html"><![CDATA[<p>ç›®å‰å¸‚åœºä¸Š php ä»æœ‰ä¸€å¸­ä¹‹åœ°ã€‚æœ¬æ–‡æ¢è®¨å¦‚ä½•å°† php åº”ç”¨å®¹å™¨åŒ–å¹¶è¿ç§»éƒ¨ç½²åˆ° K8Sã€‚</p>

<h2 id="php-åº”ç”¨é•œåƒå‡†å¤‡">php åº”ç”¨é•œåƒå‡†å¤‡</h2>

<p>é•œåƒçš„å±‚æ¬¡ï¼šåŸºç¡€ä¾èµ–é•œåƒ-&gt;è¿è¡Œæ¡†æ¶-&gt;åº”ç”¨/ä»£ç é•œåƒ</p>

<p>åŸºäºå®¹å™¨çš„å•è¿›ç¨‹è¿è¡Œç†å¿µï¼Œä¸‹é¢çš„éƒ¨ç½²è¿‡ç¨‹å¹¶æœªä½¿ç”¨å•ä½“çš„ nginx+php-fpm ä¸€ä½“çš„å®¹å™¨è¿è¡Œæ–¹å¼ï¼Œè€Œæ˜¯å°† php-fpm å’Œ nginx æ‹†æ•£ã€‚</p>

<h3 id="åŸºç¡€é•œåƒ">åŸºç¡€é•œåƒ</h3>

<p>å®‰è£…åŸºç¡€ç³»ç»Ÿä¾èµ–åŒ…å’Œå…¬å¸ php åº”ç”¨ä¸­å„ä¸ªå¼€å‘å°ç»„éƒ½ä¼šç”¨åˆ°çš„æ‰©å±•åŒ…ã€‚</p>

<p>ä¸‹é¢çš„ç¤ºä¾‹åŸºäºå®˜æ–¹ fpmï¼Œå®‰è£…äº†é€šç”¨ç³»ç»Ÿçº§çš„ä¾èµ–å’Œ php åŒ…ç®¡ç†å™¨ã€‚</p>

<p>å¦‚æœå¯ä»¥ï¼Œå»ºè®®ä½¿ç”¨æ›´åŸºç¡€çš„é•œåƒä» php æºç è¿›è¡Œç¼–è¯‘ã€‚</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># runtime.Dockerfile</span>
<span class="k">FROM</span><span class="s"> php:8.0.3-fpm</span>

<span class="c"># è‡ªå®šä¹‰ç±»åº“ç¤ºä¾‹</span>
<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get <span class="nb">install</span> <span class="nt">-y</span> git zlib1g-dev libpng-dev libicu-dev
<span class="k">RUN </span>docker-php-ext-install <span class="se">\
</span>    gd <span class="se">\
</span>    intl
<span class="k">RUN </span>docker-php-ext-configure intl


<span class="c"># å®‰è£… composer</span>
<span class="k">RUN </span>curl <span class="nt">-sS</span> https://getcomposer.org/installer | php <span class="nt">--</span> <span class="se">\
</span>    <span class="nt">--install-dir</span><span class="o">=</span>/usr/local/bin <span class="nt">--filename</span><span class="o">=</span>composer <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chmod</span> +x /usr/local/bin/composer 
</code></pre></div></div>

<p>å°†ä¸Šè¿°æ–‡ä»¶ç¼–è¯‘æˆé•œåƒï¼Œå¹¶ push åˆ°ä»“åº“ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> cloudbeer/php-runtime:1.0 <span class="nt">-f</span> runtime.Dockerfile <span class="nb">.</span>
docker push cloudbeer/php-runtime:1.0
</code></pre></div></div>

<h3 id="åº”ç”¨å±‚æ¡†æ¶é•œåƒ">åº”ç”¨å±‚æ¡†æ¶é•œåƒ</h3>

<p>å¦‚æœå¼€å‘æ¡†æ¶æ¯”è¾ƒç¨³å®šï¼Œå»ºè®®ç›´æ¥æŠŠæ¡†æ¶æ‰“åŒ…æˆåŸºç¡€é•œåƒä»¥é¿å…åç»­éƒ¨ç½²è¿‡ç¨‹ä¸­é¢‘ç¹å®‰è£…ä¾èµ–åŒ…ï¼ŒåŠ é€Ÿå‘å¸ƒæ‰“åŒ…å‘å¸ƒè¿‡ç¨‹ï¼Œå¦‚ä¸šåŠ¡å¼€å‘Aç»„ä½¿ç”¨äº† lumen æ¡†æ¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸“é—¨ä¸º lumen æ‰“ä¸€ä¸ªé•œåƒã€‚</p>

<p>å¦‚ä¸‹é•œåƒï¼Œå®‰è£…äº† lumen web æ¡†æ¶ã€‚</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># lumen.Dockerfile</span>
<span class="k">FROM</span><span class="s"> cloudbeer/php-runtime:1.0</span>

<span class="k">RUN </span><span class="nb">mkdir</span> /app
<span class="k">WORKDIR</span><span class="s"> /app</span>

<span class="k">RUN </span><span class="nb">echo</span> <span class="s1">'{</span><span class="se">\
</span><span class="s1">    "require": {</span><span class="se">\
</span><span class="s1">    "php": "^7.3|^8.0",</span><span class="se">\
</span><span class="s1">    "laravel/lumen-framework": "^8.0"</span><span class="se">\
</span><span class="s1">    }</span><span class="se">\
</span><span class="s1"> }'</span> <span class="o">&gt;</span> composer.json

<span class="k">RUN </span>composer i
</code></pre></div></div>

<p>ä¸Šè¿°é•œåƒæ‰“åŒ…ä¸ºï¼šcloudbeer/my-lumen:1.0</p>

<h3 id="åº”ç”¨å±‚é•œåƒ">åº”ç”¨å±‚é•œåƒ</h3>

<p>ç”±äºæˆ‘ä»¬åœ¨åº”ç”¨å±‚æ¡†æ¶é‡Œå·²ç»æŠŠ lumen è¿è¡Œæ—¶éƒ½å®‰è£…å¥½äº†ï¼Œæ‰€ä»¥è¿™ä¸ªé•œåƒé‡Œï¼Œåªéœ€æ‹·è´çº¯æºç å³å¯ã€‚è®°å¾—åˆ›å»º .gitignore æˆ–è€… .dockerignore æ–‡ä»¶ï¼Œæ’é™¤ venderï¼Œtest ç­‰ç›®å½•ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># .dockerignore</span>
/vendor
/tests
/.idea
/.git
.gitignore
Dockerfile
Homestead.json
Homestead.yaml
.env
.ent.example
.phpunit.result.cache
</code></pre></div></div>

<p>åº”ç”¨é•œåƒé‡Œåªéœ€è¦æ‹·è´è„šæœ¬æ–‡ä»¶å³å¯ã€‚è¿™ä¸ªé•œåƒåŒ…å«äº†å®Œæ•´çš„ php è¿è¡Œæ—¶å’Œä¸šåŠ¡ä»£ç ï¼Œå¯åŠ¨åå¯ä»¥ç›´æ¥æ¥æ”¶ fastcgi è°ƒç”¨ã€‚</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> cloudbeer/my-lumen:1.0</span>
<span class="k">COPY</span><span class="s"> ./ /app/</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„é•œåƒæ‰“åŒ…ä¸ºï¼š cloudbeer/php-caculate:1.0</p>

<p>å¦ä¸€ç§æ‰“åŒ…ä»£ç æ–¹å¼ï¼Œæˆ‘ä»¬ä½¿ç”¨çº¯çš„å®¹å™¨å°†æºä»£ç æ‰“åŒ…ï¼Œåé¢ä¼šåœ¨ K8S ä¸­éƒ¨ç½²æ—¶å°†æ–‡ä»¶æ‹·è´åˆ°æ¡†æ¶è¿è¡Œæ—¶å®¹å™¨ä¸­è¿è¡Œã€‚</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> debian:buster-slim</span>
<span class="k">RUN </span><span class="nb">mkdir</span> /app
<span class="k">COPY</span><span class="s"> ./ /app/</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„é•œåƒæ‰“åŒ…ä¸ºï¼š cloudbeer/php-caculate-purecode:1.0</p>

<p>ä»£ç å±‚åœ¨è¿˜å¯ä»¥æœ‰æ›´å¤šçš„æ‰“åŒ…æ–¹å¼ï¼Œå¦‚ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨é‡Œï¼Œæˆ–è€…ä½¿ç”¨ NFS å­˜å‚¨ï¼ŒåæœŸç»‘å®šåˆ°å®¹å™¨è¿è¡Œæ—¶è¿è¡Œã€‚</p>

<h3 id="æœ¬åœ°æµ‹è¯•">æœ¬åœ°æµ‹è¯•</h3>

<p>å¯åŠ¨é•œåƒ cloudbeer/php-caculate:1.0</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-it</span> cloudbeer/php-caculate:1.0 sh

<span class="c"># å®¹å™¨å†…è¿è¡Œ</span>
<span class="c"># å¯åŠ¨ php æµ‹è¯•</span>
php <span class="nt">-S</span> localhost:8000 <span class="nt">-t</span> public &amp;
<span class="c"># æŸ¥çœ‹ç»“æœ</span>
curl http://localhost:8000/cpu
</code></pre></div></div>

<p>å®Œç¾è¿è¡Œã€‚</p>

<p>ç›®å‰å·²ç»å®Œæˆäº†åº”ç”¨é•œåƒæ‰“åŒ…ã€‚å…¶ä¸­å‰ä¸¤å±‚é•œåƒå¯ä»¥å¤ç”¨ï¼ŒçœŸæ­£çš„ä¸šåŠ¡åº”ç”¨åªéœ€æ‹·è´ä»£ç ã€‚</p>

<p>ä¸Šè¿°ä»£ç ä¸­çš„é•œåƒï¼Œæˆ‘å‡å·²æ‰“åŒ…ä¸Šä¼ åˆ° docker hub å®˜ç½‘ï¼Œå¯ä»¥å¿½ç•¥ build å’Œ push è¿‡ç¨‹ï¼Œç›´æ¥è¿›è¡Œæµ‹è¯•ã€‚</p>

<h2 id="éƒ¨ç½²åˆ°-k8s">éƒ¨ç½²åˆ° K8S</h2>

<p>php åº”ç”¨éƒ¨ç½²åˆ°å®¹å™¨ç¯å¢ƒï¼Œæœ€è‡ªç„¶çš„ä¸€ç§æ–¹å¼æ˜¯ï¼šç›´æ¥å°† php çš„è¿è¡Œç¯å¢ƒå’Œ web server ä»¥åŠä¸šåŠ¡æºä»£ç æ‰“åŒ…æ”¾åœ¨ä¸€ä¸ªå®¹å™¨ä¸­è¿è¡Œã€‚è¿™ä¸ªæ–¹å¼æ˜¯æœ€ç®€å•çš„æ–¹å¼ï¼Œphp å®˜æ–¹ä¹Ÿæä¾›äº† php:nginx è¿™ç§é•œåƒåº•åŒ…ã€‚</p>

<p>ä½† php è¿è¡Œæ—¶å’Œ web server æ˜¯åœ¨ä¸¤ä¸ªè¿›ç¨‹ä¸­è¿è¡Œï¼Œè¿™ä¸ªä¸ç¬¦åˆå®¹å™¨çš„æœ€ä½³å®è·µã€‚ä¸€èˆ¬å»ºè®®å°†è¿™ä¸¤ä¸ªè¿›ç¨‹åˆ†åˆ«è¿è¡Œåœ¨ä¸åŒçš„å®¹å™¨ä¸­ã€‚</p>

<h3 id="nginx-ä½œä¸º-sidecar-è¿è¡Œ">nginx ä½œä¸º sidecar è¿è¡Œ</h3>

<p>K8S åœ¨åŒä¸€ä¸ª pod ä¸­ï¼Œå¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ã€‚æˆ‘ä»¬å°† php-fpm çš„ä¸šåŠ¡ä»£ç éƒ¨ç½²åœ¨ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œä¸ä¹‹ç›¸ä¼´ç”Ÿçš„æœ‰ä¸€ä¸ª nginx å®¹å™¨ï¼Œnginx ä½œä¸ºfastcgiçš„è°ƒç”¨æ–¹ï¼Œå¹¶å¯ä»¥ä»£ç†ä¸€äº›é™æ€èµ„æºï¼Œè¿™ä¸ªæ¨¡å¼ç±»ä¼¼ mesh çš„sidecar æ¨¡å¼ã€‚æ¶æ„å›¾å¦‚ä¸‹ï¼š</p>

<p><img src="https://github.com/cloudbeer/php-best-practice/blob/main/readme-img/sidecar.jpg?raw=true" alt="nginx ä½œä¸º sidecar éƒ¨ç½²" /></p>

<h4 id="nginx-é…ç½®">nginx é…ç½®</h4>

<p>ç”±äº nginx å’Œ php-fpm åœ¨ä¸€ä¸ª pod ä¸­ï¼Œæ‰€ä»¥åªéœ€å‘èµ· localhost è°ƒç”¨å³å¯ã€‚ nginx çš„é…ç½®å¦‚ä¸‹ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªé…ç½®å†™åˆ° cm ä¸­ï¼Œåé¢é€šè¿‡ volume ç»‘å®šåˆ°å®¹å™¨ä¸­ã€‚è¿™ä¸ªé…ç½®æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„çš„ï¼š</p>

<ul>
  <li>åº”ç”¨ä½¿ç”¨äº† lumen çš„ route ä½“ç³»ï¼Œæ‰€ä»¥éœ€è¦å°†è·¯ç”±é€šè¿‡ try_files å…¨éƒ¨æŒ‡å‘ ./public/index.php æ–‡ä»¶ã€‚</li>
  <li>fastcgi_param  SCRIPT_FILENAME  /app/public/index.php è¿™é‡Œä¹Ÿå°†æ‰€æœ‰è„šæœ¬æŒ‡å‘è¿™ä¸ªæ–‡ä»¶ã€‚</li>
</ul>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># nginx config</span>
<span class="k">apiVersion:</span> <span class="s">v1</span>
<span class="s">kind:</span> <span class="s">ConfigMap</span>
<span class="s">metadata:</span>
    <span class="s">name:</span> <span class="s">caculate-sidecar-config</span>
    <span class="s">namespace:</span> <span class="s">php-test</span>
<span class="s">data:</span>
    <span class="s">config:</span> <span class="s">|-</span>
      <span class="s">server</span> <span class="p">{</span>
          <span class="kn">listen</span>       <span class="mi">8081</span><span class="p">;</span>
          <span class="kn">root</span>   <span class="n">/app/public</span><span class="p">;</span>
          <span class="kn">index</span> <span class="s">index.php</span>
          <span class="s">charset</span> <span class="s">utf-8</span><span class="p">;</span>

          <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
            <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri</span><span class="n">/</span> <span class="n">/index.php?</span><span class="nv">$args</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php$</span>  <span class="p">{</span>
            <span class="kn">fastcgi_pass</span>   <span class="nf">127.0.0.1</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
            <span class="kn">fastcgi_index</span>  <span class="s">index.php</span><span class="p">;</span>
            <span class="kn">fastcgi_param</span>  <span class="s">SCRIPT_FILENAME</span>  <span class="n">/app/public/index.php</span><span class="p">;</span>
            <span class="kn">include</span>        <span class="s">fastcgi_params</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
</code></pre></div></div>

<h4 id="åº”ç”¨éƒ¨ç½²è„šæœ¬">åº”ç”¨éƒ¨ç½²è„šæœ¬</h4>

<p>åœ¨ä¸‹é¢çš„éƒ¨ç½²è„šæœ¬ä¸­ï¼Œæœ‰å‡ ç‚¹å€¼å¾—å…³æ³¨ä¸€ä¸‹ï¼š</p>

<ul>
  <li>ä½¿ç”¨äº† emptyDir:{} ä½œä¸ºå®¹å™¨çš„æºä»£ç å­˜å‚¨ä»‹è´¨ï¼Œè¿™æ ·å¯ä»¥å°†åº”ç”¨è¯»å–åˆ°ä¸´æ—¶ç›®å½•ä¸­ï¼ŒåŠ é€Ÿè¿è¡Œæ—¶ php æºç çš„åŠ è½½ã€‚å¦‚æœè„šæœ¬æ–‡ä»¶ä¸å¤§ï¼Œå¯ä»¥æŒ‡å®š emptyDir ä½¿ç”¨å†…å­˜è¿è¡Œï¼Œè¿™ä¸ªå¯ä»¥æ›´åŠ åŠ é€Ÿè„šæœ¬åŠ è½½ã€‚</li>
  <li>pod å¯åŠ¨çš„æ—¶å€™ä½¿ç”¨äº† 2 ä¸ª åˆå§‹åŒ–å®¹å™¨ï¼Œä½¿ç”¨çš„é•œåƒåˆ†åˆ«æ˜¯ï¼šæç®€æºä»£ç çš„é•œåƒ(php-caculate-purecode)å’Œæ¡†æ¶è¿è¡Œæ—¶é•œåƒ(my-lumen)ï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™åˆ†åˆ«å°† /app çš„ä»£ç æ‹·è´åˆ°äº† emptyDir å·ä¸­ï¼Œåˆ†åˆ«æ‹·è´äº†lumençš„ vendor ä¾èµ–å’Œä¸šåŠ¡æºä»£ç ã€‚è¿™é‡Œæ‹·è´ä¸šåŠ¡æºä»£ç è¿‡ç¨‹äº¦å¯ä»¥ä½¿ç”¨ cfs æˆ–è€… cos æ¥å®ç°ã€‚ç”±äºä½¿ç”¨äº†å®¿ä¸»æœºå­˜å‚¨æºä»£ç ï¼Œå½“æºä»£ç è¿‡äºåºå¤§çš„æ—¶å€™ï¼Œè¯·æ³¨æ„è¶…å‡ºå®¿ä¸»æœºå­˜å‚¨å®¹é‡é£é™©ã€‚</li>
  <li>ç”±äºæºç å’Œä¾èµ–åŒ…éƒ½å·²ç»åœ¨ initContainers ç»„ç»‡å¥½äº†ï¼Œæ‰€ä»¥ï¼Œåªéœ€è¦ä½¿ç”¨ php åŸºç¡€å®¹å™¨æ¥å¯åŠ¨åº”ç”¨å³å¯ã€‚</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-nginx-sidecar</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
  <span class="na">labels</span><span class="pi">:</span> 
    <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-nginx-sidecar</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-nginx-sidecar</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-nginx-sidecar</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="c1"># web app çš„å·¥ä½œç›®å½•</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webapp-data</span>
        <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="c1"># nginx çš„é…ç½®æ–‡ä»¶ï¼Œä» cm ä¸­ç»‘å®šè¿‡æ¥</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-php-config</span>
        <span class="na">configMap</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-sidecar-config</span>
          <span class="na">items</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">config</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">caculate-sidecar.conf</span>
      <span class="c1"># åˆå§‹åŒ–ï¼Œå°†é•œåƒä¸­çš„æºæ–‡ä»¶æ‹·è´åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ã€‚</span>
      <span class="na">initContainers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">copy-code</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">cloudbeer/php-caculate-purecode:1.0</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webapp-data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/webapp</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">cp</span><span class="pi">,</span> <span class="nv">-R</span><span class="pi">,</span> <span class="nv">/app/</span><span class="pi">,</span> <span class="nv">/webapp</span><span class="pi">]</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">copy-lumen</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">cloudbeer/my-lumen:1.0</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webapp-data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/webapp</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">cp</span><span class="pi">,</span> <span class="nv">-R</span><span class="pi">,</span> <span class="nv">/app/</span><span class="pi">,</span> <span class="nv">/webapp</span><span class="pi">]</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="c1"># fpm åº”ç”¨è¿è¡Œç¯å¢ƒ</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">caculate</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">cloudbeer/php-runtime:1.0</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9000</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webapp-data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/app</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">app</span>
      <span class="c1"># nginx sidecar</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-sidecar</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:alpine</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-php-config</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/nginx/conf.d/caculate-sidecar.conf</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">caculate-sidecar.conf</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webapp-data</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/app</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">app</span>
<span class="nn">---</span>
</code></pre></div></div>

<p>æŒ‚ä¸€ä¸ª LoadBalancer çœ‹çœ‹ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-sidecar-service</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
<span class="na">spec</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
    <span class="na">selector</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-nginx-sidecar</span>
    <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
          <span class="na">port</span><span class="pi">:</span> <span class="m">8081</span>
          <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8081</span>
</code></pre></div></div>

<p>è®¿é—®å¯¹åº”çš„ å¤–éƒ¨ ip:8081ï¼Œå®Œç¾è¿è¡Œã€‚</p>

<h3 id="nginx-ç‹¬ç«‹éƒ¨ç½²">nginx ç‹¬ç«‹éƒ¨ç½²</h3>

<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿ç»´éƒ¨é—¨å¸Œæœ›å°† web server æ”¶æ•›å¹¶ç»Ÿä¸€ç®¡ç†ï¼Œå¼€å‘ä¹Ÿä¸å¤ªå…³å¿ƒ nginx çš„å…·ä½“é…ç½®ï¼Œå°†ä¸¤è€…è¿›è¡Œæ‹†åˆ†ä¼—æœ›æ‰€å½’ï¼Œå¹¶ä¸”åœ¨å¾®æœåŠ¡çš„æ¨ªå‘æ‰©å±•ä¸­ï¼Œè¿™ç§æ–¹å¼ä¹Ÿæ›´åŠ â€œä¼˜é›…â€ã€‚</p>

<p>éƒ¨ç½²æ¶æ„å›¾å¦‚ä¸‹ï¼š</p>

<p><img src="https://github.com/cloudbeer/php-best-practice/raw/main/readme-img/separate.jpg?raw=true" alt="nginx ç‹¬ç«‹éƒ¨ç½²æ¶æ„" /></p>

<h4 id="éƒ¨ç½²-fpm-ä¸šåŠ¡åº”ç”¨">éƒ¨ç½² fpm ä¸šåŠ¡åº”ç”¨</h4>

<ul>
  <li>æ­¤å¤„éƒ¨ç½²äº† php-caculate é•œåƒï¼Œæ­¤é•œåƒé‡ŒåŒ…å«äº†æºä»£ç ï¼ŒWebæ¡†æ¶ä»¥åŠ php è¿è¡Œæ—¶ï¼Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„ php-fpm ä¸šåŠ¡åº”ç”¨ã€‚</li>
  <li>é€šè¿‡ service å‘å¸ƒåº”ç”¨ï¼Œä»¥ä¾¿ nginx èƒ½å‘ç° fpm æœåŠ¡ï¼Œå¹¶è§£å¶äº† webserver å’Œ ä¸šåŠ¡æœåŠ¡ã€‚åæœŸå¯ä»¥åšçº¯php ä¸šåŠ¡çš„æ¨ªå‘æ‰©å±•å’Œ nginx çš„é›†ä¸­ç®¡ç†ã€‚</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ä¸º php-fpm éƒ¨ç½² service</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">9000</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">tcp</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-standalone</span>

<span class="nn">---</span>   
<span class="c1"># éƒ¨ç½²å…·ä½“åº”ç”¨</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
  <span class="na">labels</span><span class="pi">:</span> 
    <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">cloudbeer/php-caculate:1.0</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">caculate</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1Gi"</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9000</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
</code></pre></div></div>

<h4 id="nginx-éƒ¨ç½²">nginx éƒ¨ç½²</h4>

<p>æ­¤éƒ¨åˆ†çš„ nginx é…ç½®åŸºæœ¬å’Œä¸Šé¢ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ fastcgi_pass çš„è°ƒç”¨ç›®æ ‡å˜æˆäº† php ä¸šåŠ¡çš„ serviceï¼šcaculate-standalone äº†ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-standalone-config</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
<span class="na">data</span><span class="pi">:</span>
    <span class="na">config</span><span class="pi">:</span> <span class="pi">|-</span>
      <span class="s">server {</span>
          <span class="s">listen       8081;</span>
          <span class="s">root   /app/public;</span>
          <span class="s">index index.php</span>
          <span class="s">charset utf-8;</span>

          <span class="s">location / {</span>
            <span class="s">try_files $uri $uri/ /index.php?$args;</span>
          <span class="s">}</span>

          <span class="s">location ~ \.php$  {</span>
            <span class="s">fastcgi_pass   caculate-standalone:9000;</span>
            <span class="s">fastcgi_index  index.php;</span>
            <span class="s">fastcgi_param  SCRIPT_FILENAME  /app/public/index.php;</span>
            <span class="s">include        fastcgi_params;</span>
          <span class="s">}</span>
      <span class="s">}</span>
</code></pre></div></div>

<p>ä¸‹é¢ä¸º nginx é…ç½®å•ç‹¬ pod å¯åŠ¨ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span>  <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-standalone-nginx-deployment</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
<span class="na">spec</span><span class="pi">:</span>
    <span class="na">selector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">template</span><span class="pi">:</span>
        <span class="na">metadata</span><span class="pi">:</span>
          <span class="na">labels</span><span class="pi">:</span>
              <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">spec</span><span class="pi">:</span>
          <span class="na">containers</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
            <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:alpine</span>
            <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-php-config</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/nginx/conf.d/caculate-standalone.conf</span>
              <span class="na">subPath</span><span class="pi">:</span> <span class="s">caculate-standalone.conf</span>
          <span class="na">volumes</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-php-config</span>
                <span class="na">configMap</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-standalone-config</span>
                  <span class="na">items</span><span class="pi">:</span>
                  <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">config</span>
                    <span class="na">path</span><span class="pi">:</span> <span class="s">caculate-standalone.conf</span>
</code></pre></div></div>

<p>ç°åœ¨ï¼Œç»™ nginx åº”ç”¨æŒ‚ä¸€ä¸ª LoadBalancer æµ‹è¯•ä¸€ä¸‹ï¼Œäº¦å®Œç¾è¿è¡Œã€‚</p>

<h3 id="ä½¿ç”¨-nginx-ingress-éƒ¨ç½²">ä½¿ç”¨ nginx-ingress éƒ¨ç½²</h3>

<p>ä¸Šé¢çš„éƒ¨ç½²æ¶æ„å›¾ä¸­ï¼Œingress å’Œ nginx åˆ†åˆ«è¿›è¡Œäº†éƒ¨ç½²ï¼Œä½†  nginx-ingress å…¶å®å·²ç»åˆå¹¶äº†è¿™ä¸¤ä¸ªéƒ¨åˆ†ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬è¯•è¯•ä½¿ç”¨ nginx-ingress éƒ¨ç½²ã€‚</p>

<p><img src="https://github.com/cloudbeer/php-best-practice/raw/main/readme-img/nginx-ingress.jpg?raw=true" alt="ä½¿ç”¨ nginx-ingress éƒ¨ç½²" /></p>

<p>ä½¿ç”¨ä¸Šé¢çš„å·²ç»éƒ¨ç½²å¥½çš„ fpm ä¸šåŠ¡çš„service: caculate-standalone ã€‚</p>

<p>éƒ¨ç½²è„šæœ¬å¦‚ä¸‹ï¼š</p>

<ul>
  <li>ingress.class çš„å€¼æ˜¯åˆ›å»º nginx-ingress æ—¶å€™åœ¨æ§åˆ¶å°å®šä¹‰çš„ã€‚</li>
  <li>ä¸çº¯ nginx é…ç½®ä¸åŒï¼Œnginx-ingress æ— éœ€é…ç½® try_files èŠ‚ç‚¹ï¼Œä¸‹é¢çš„é…ç½®å…¶å®å·²ç»å°†å…¨éƒ¨è¯·æ±‚è½¬å‘åˆ°äº† public/index.phpã€‚</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-nginx-ingress-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">SCRIPT_FILENAME</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/app/public/index.php"</span>
<span class="nn">---</span>  
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s2">"</span><span class="s">your-ingress-class"</span>
    <span class="na">nginx.ingress.kubernetes.io/backend-protocol</span><span class="pi">:</span> <span class="s2">"</span><span class="s">FCGI"</span>
    <span class="na">nginx.ingress.kubernetes.io/fastcgi-index</span><span class="pi">:</span> <span class="s2">"</span><span class="s">index.php"</span>
    <span class="na">nginx.ingress.kubernetes.io/fastcgi-params-configmap</span><span class="pi">:</span> <span class="s2">"</span><span class="s">caculate-nginx-ingress-config"</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">caculate-nginx-ingress</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">php-test</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">backend</span><span class="pi">:</span>
          <span class="na">serviceName</span><span class="pi">:</span> <span class="s">caculate-standalone</span>
          <span class="na">servicePort</span><span class="pi">:</span> <span class="m">9000</span>
</code></pre></div></div>

<p>å¦‚æœ nginx-ingress æä¾›äº†å¤–ç½‘åœ°å€ï¼Œå¯ä»¥è®¿é—®ä¸€ä¸‹è¯•è¯•ï¼Œå®Œç¾è¿è¡Œã€‚</p>

<h3 id="moremesh-åŒ–">MOREï¼šmesh åŒ–</h3>

<p>åœ¨ php mesh åŒ–ä¸­ï¼Œéœ€è¦è€ƒè™‘çš„é—®é¢˜å¦‚ä¸‹ï¼š</p>

<ul>
  <li>fastcgi ä½¿ç”¨ TCP åè®®ï¼Œå¹¶ä¸”æœ‰è‡ªå·±çš„åºåˆ—åŒ–æ–¹æ³•ï¼Œæ­¤ç‰¹æ€§å¹¶æœªåœ¨ istio å’Œ envoy ä¸­æ”¯æŒï¼Œæ— æ³•è¿›è¡Œç²¾ç»†çš„æµé‡æ§åˆ¶ã€‚</li>
  <li>fpm + envoy sidecar å¯ä»¥å®ç°æœåŠ¡çº§åˆ«çš„æµé‡æ§åˆ¶ã€‚ fpm + nginx-sidecar + envoy sidecar å°† fastcgi è°ƒç”¨è½¬åŒ–ä¸º http è°ƒç”¨ï¼Œå¯ä»¥å®ç°åŸºäº http åè®®çš„ç²¾ç»†æµé‡æ§åˆ¶ã€‚</li>
  <li>å®ç°è°ƒç”¨é“¾ç›‘æ§ï¼Œéœ€è¦ä½¿ç”¨ http è¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œæœ‰å¯èƒ½éœ€è¦æ”¹é€ ä»£ç ï¼Œåœ¨header ä¸­å°è£… opentracing ã€‚</li>
</ul>

<p>å½“ä¸‹ï¼Œphp mesh çš„éƒ¨ç½²æ¨¡å¼å»ºè®®é‡‡ç”¨ fpm ä¸šåŠ¡å±‚ï¼Œnginx-sidecarï¼Œ envoy-sidecar ä¸‰ä¸ªå®¹å™¨ä¸ºä¸€ä¸ªpod çš„éƒ¨ç½²æ¨¡å¼ã€‚</p>

<p>æ¶æ„å›¾å¦‚ä¸‹ï¼š</p>

<p><img src="https://github.com/cloudbeer/php-best-practice/raw/main/readme-img/mesh.jpg?raw=true" alt="php åº”ç”¨çš„ mesh éƒ¨ç½²æ¶æ„" /></p>

<p>æ­¤å¤„çš„éƒ¨ç½²ä¸ç¬¬ä¸€éƒ¨åˆ†çš„å†…å®¹ - nginx ä½œä¸º sidecar è¿è¡Œç±»ä¼¼ï¼Œåœ¨è…¾è®¯äº‘ä¸­éœ€è¦å¼€é€š TCMï¼Œå¹¶æ³¨å…¥ envoy çš„ sidecarã€‚</p>

<hr />

<h2 id="æœ¬æ–‡ç›¸å…³çš„æºä»£ç è¯´æ˜">æœ¬æ–‡ç›¸å…³çš„æºä»£ç è¯´æ˜</h2>

<p>ä½ç½®ï¼š<a href="https://github.com/cloudbeer/php-best-practice">https://github.com/cloudbeer/php-best-practice</a></p>

<h3 id="srclumen-app">src/lumen-app/</h3>

<p>php ä¸šåŠ¡åº”ç”¨ï¼Œæ˜ å°„äº†2ä¸ªè·¯å¾„</p>

<ul>
  <li>/cpuï¼š ä¸¤ç§æ–¹å¼è®¡ç®—äº† pi</li>
  <li>/mem: åœ¨æ•°ç»„é‡Œå¡äº†å­—ç¬¦ä¸²ä¸ºäº†æ’‘çˆ†å†…å­˜</li>
</ul>

<h3 id="deployments">deployments/</h3>

<p>éƒ¨ç½²ä»£ç </p>

<ul>
  <li>app-caculate-fpm-separate.yamlï¼š nginx å’Œ fpm åˆ†åœ¨ä¸åŒçš„ pod ä¸­éƒ¨ç½²</li>
  <li>app-caculate-nginx-ingress.yamlï¼š nginx-ingress ç›´æ¥ä»£ç† fpm æœåŠ¡</li>
  <li>app-caculate-nginx-sidecar.yamlï¼š nginx å’Œ fpm éƒ¨ç½²åœ¨åŒä¸€ä¸ªpodä¸­çš„ä¸¤ä¸ªå®¹å™¨</li>
</ul>

<h3 id="dockerfile">dockerfile/</h3>

<ul>
  <li>lumen.Dockerfileï¼šåŒ…å« lumen æ¡†æ¶çš„è¿è¡Œç¯å¢ƒ</li>
  <li>runtime.Dockerfileï¼šphp åŸºç¡€è¿è¡Œç¯å¢ƒ</li>
  <li>ä¸šåŠ¡ä»£ç çš„ Dockerfile ä½äº src/lumen-app/Dockerfile å’Œ src/lumen-app/purecode.Dockerfile</li>
</ul>]]></content><author><name></name></author><category term="container," /><category term="language" /><summary type="html"><![CDATA[ç›®å‰å¸‚åœºä¸Š php ä»æœ‰ä¸€å¸­ä¹‹åœ°ã€‚æœ¬æ–‡æ¢è®¨å¦‚ä½•å°† php åº”ç”¨å®¹å™¨åŒ–å¹¶è¿ç§»éƒ¨ç½²åˆ° K8Sã€‚]]></summary></entry><entry><title type="html">ç”Ÿäº§æœ‰æƒé™æ§åˆ¶çš„ kubeconfig</title><link href="https://cloudbeer.github.io/2021/07/create-kubeconfig.html" rel="alternate" type="text/html" title="ç”Ÿäº§æœ‰æƒé™æ§åˆ¶çš„ kubeconfig" /><published>2021-07-16T01:53:06+00:00</published><updated>2021-07-16T01:53:06+00:00</updated><id>https://cloudbeer.github.io/2021/07/create-kubeconfig</id><content type="html" xml:base="https://cloudbeer.github.io/2021/07/create-kubeconfig.html"><![CDATA[<p>â€‹
åœ¨å¼€å‘æµ‹è¯•åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¼€é€šäº† k8s é›†ç¾¤ï¼Œéœ€è¦æŠŠé›†ç¾¤çš„èµ„æºåˆ†é…ç»™ä½¿ç”¨è€…ï¼Œä½†å¸Œæœ›ä»–ä»¬åªèƒ½åœ¨è‡ªå·±çš„å‘½åç©ºé—´ä½¿ç”¨èµ„æºï¼Œä¸å½±å“å…¶ä»–äººçš„ã€‚</p>

<p>ä¸‹é¢çš„è¿‡ç¨‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ k8s åŸç”Ÿèƒ½åŠ›åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>

<h2 id="å®ç°æ­¥éª¤">å®ç°æ­¥éª¤</h2>

<h3 id="åˆ›å»º-namespace">åˆ›å»º namespace</h3>

<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªä½¿ç”¨è€…åå­—çš„å‘½åç©ºé—´</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create ns well
</code></pre></div></div>

<h3 id="åˆ›å»º-serviceaccount">åˆ›å»º ServiceAccount</h3>

<p>åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸‹åˆ›å»º SA</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">well-sa</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">well</span>
</code></pre></div></div>

<h3 id="åˆ›å»ºä¸€ä¸ª-role">åˆ›å»ºä¸€ä¸ª Role</h3>

<p>åœ¨ç”¨æˆ·å‘½åç©ºé—´ä¸‹åˆ›å»º Roleï¼Œè¿™é‡Œå°†ä½ å¸Œæœ›ç»™ä½¿ç”¨è€…çš„èµ„æºå’Œæƒé™æ”¾è¿›å»ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">well-role</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">well</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> 
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="pi">-</span> <span class="s">deployments</span>
  <span class="pi">-</span> <span class="s">configmaps</span>
  <span class="pi">-</span> <span class="s">services</span>
  <span class="na">verbs</span><span class="pi">:</span> 
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
  <span class="pi">-</span> <span class="s">create</span>
  <span class="pi">-</span> <span class="s">update</span>
  <span class="pi">-</span> <span class="s">delete</span>
</code></pre></div></div>

<h3 id="åˆ›å»º-rolebinding">åˆ›å»º RoleBinding</h3>

<p>å°†åˆšåˆšåˆ›å»ºçš„ SA å’Œ Role ç»‘åœ¨ä¸€èµ·ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">well-binding</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">well</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">well-sa</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">well-role</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<p>ç°åœ¨ well-sa è¿™ä¸ª ServiceAccount å°±å¯ä»¥è®¿é—® well å‘½åç©ºé—´ä¸‹çš„ç›¸åº”èµ„æºäº†ã€‚æ¥ä¸‹æ¥éœ€è¦æŠŠ SA å¯¹åº”çš„é’¥åŒ™ç»™ä½¿ç”¨è€…ã€‚</p>

<h3 id="ç”Ÿäº§-kubeconfig">ç”Ÿäº§ kubeconfig</h3>

<p>kubeconfig æ¨¡ç‰ˆå¦‚ä¸‹ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
<span class="na">users</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">well</span>
  <span class="na">user</span><span class="pi">:</span>
    <span class="na">token</span><span class="pi">:</span> <span class="s">&lt;token&gt;</span>
<span class="na">clusters</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">cluster</span><span class="pi">:</span>
    <span class="na">certificate-authority-data</span><span class="pi">:</span> <span class="s">&lt;certificate-authority-data&gt;</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">&lt;api-server&gt;</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">well-cluster</span>
<span class="na">contexts</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s">well-cluster</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">well</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">well</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">well-cluster</span>
<span class="na">current-context</span><span class="pi">:</span> <span class="s">well-cluster</span>
</code></pre></div></div>

<p>ç°åœ¨åªéœ€è¦å°†ä¸Šé¢ç›¸åº”çš„å†…å®¹æ›¿æ¢æˆå®é™…çš„å†…å®¹ã€‚</p>

<p>è¿™äº›å‚æ•°çš„è·å–è·¯å¾„å¦‚ä¸‹ï¼š</p>

<ul>
  <li>é€šè¿‡å‘½ä»¤ <code class="language-plaintext highlighter-rouge">kubectl config view --flatten --minify</code>Â  å¯ä»¥æ‹¿åˆ° certificate-authority-data å’Œ api-server ä¿¡æ¯ ã€‚</li>
  <li>é€šè¿‡å‘½ä»¤ <code class="language-plaintext highlighter-rouge">kubectl describe sa well-sa -n well</code>Â  æ‹¿åˆ° secret çš„ keyã€‚</li>
  <li>é€šè¿‡å‘½ä»¤ <code class="language-plaintext highlighter-rouge">kubectl describe secret &lt;key&gt; -n well</code>  æ‹¿åˆ° token ä¿¡æ¯ã€‚</li>
</ul>

<p>æ›¿æ¢å®Œæˆåå°†kubeconfig å­˜æˆæ–‡ä»¶å‘æ”¾ç»™ä½¿ç”¨è€…å³å¯ã€‚</p>

<h2 id="è‡ªåŠ¨åŒ–">è‡ªåŠ¨åŒ–</h2>

<p>ä¸Šè¿°è¿‡ç¨‹å¯ä»¥è‡ªåŠ¨åŒ–å®Œæˆï¼Œä¸‹é¢æ˜¯å®ç°è¿™ä¸€è¿‡ç¨‹çš„å®Œæ•´ Shell è„šæœ¬ã€‚</p>

<p>é¦–å…ˆä½ éœ€è¦æœ‰ä¸€ä¸ªæƒé™è¶³å¤Ÿçš„ kubeconfig åœ¨ä½ çš„ kubectl å½“å‰ä¸Šä¸‹æ–‡ã€‚</p>

<p>æ‹·è´æ­¤è„šæœ¬å‘½åæ–‡ä»¶åä¸º create-key.shï¼Œç»™æ‰§è¡Œæƒé™ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"æ¬¢è¿ä½¿ç”¨ kubeconfig ç”Ÿæˆå™¨ï¼Œæ­¤è„šæœ¬å¯ä»¥äº§ç”Ÿä¸€ä¸ªæœ‰é™æƒé™çš„å¯†é’¥ã€‚"</span>
<span class="nb">echo</span> <span class="s2">"æ‰§è¡Œæ­¤è„šæœ¬éœ€è¦æ‚¨é¦–å…ˆæ‹¥æœ‰é›†ç¾¤æœ€å¤§æƒé™çš„é»˜è®¤é’¥åŒ™ã€‚"</span>
<span class="nb">echo 
echo</span> <span class="s2">"ä½¿ç”¨æ–¹æ³•ï¼š"</span>
<span class="nb">echo</span> <span class="s2">"./create-key.sh"</span>
<span class="nb">echo</span> <span class="s2">"æˆ–è€…"</span>
<span class="nb">echo</span> <span class="s2">"./create-key.sh &lt;yourname&gt;"</span>
<span class="nb">echo</span>

<span class="c"># æ£€æŸ¥ ns</span>
<span class="k">function </span>userExists<span class="o">()</span> <span class="o">{</span>
  <span class="nv">checkUser</span><span class="o">=</span><span class="sb">`</span>kubectl get ns | <span class="nb">grep</span> <span class="nt">-w</span> <span class="nv">$1</span><span class="sb">`</span> 
  <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$checkUser</span><span class="s2">"</span> <span class="o">]</span>
  <span class="k">then
    </span><span class="nb">echo </span>0
  <span class="k">else
    </span><span class="nb">echo </span>1
  <span class="k">fi</span>
<span class="o">}</span>


<span class="nv">USER</span><span class="o">=</span><span class="nv">$1</span>

<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span><span class="k">then
  while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">read</span> <span class="nt">-p</span> <span class="s2">"è¯·è¾“å…¥ç”¨æˆ·æ ‡è¯†ï¼š"</span> USER

    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span> <span class="c"># å•¥ä¹Ÿä¸è¾“å…¥</span>
      <span class="nb">echo</span> <span class="s2">"æ‚¨å¾—è¾“å…¥ç‚¹å•¥ï¼Œæˆ–è€… ctrl + c é€€å‡ºï¼Œè¯·é‡æ–°è¾“å…¥ã€‚"</span>
      <span class="nb">echo
    </span><span class="k">else
      </span><span class="nv">checkUser</span><span class="o">=</span><span class="sb">`</span>userExists <span class="nv">$USER</span><span class="sb">`</span>
      <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$checkUser</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span>
      <span class="k">then
        </span><span class="nb">break
      </span><span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$USER</span><span class="s2"> è¢«å ç”¨ï¼Œè¯·é‡æ–°è¾“å…¥æˆ–è€… ctrl + c é€€å‡ºã€‚"</span>
        <span class="nb">echo
      </span><span class="k">fi
    fi
  done
else
    </span><span class="nv">checkUser</span><span class="o">=</span><span class="sb">`</span>userExists <span class="nv">$USER</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$checkUser</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span><span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$USER</span><span class="s2"> è¢«å ç”¨ã€‚"</span> <span class="o">&gt;&gt;</span>/dev/stderr
        <span class="nb">exit
    </span><span class="k">fi
fi


</span>kubectl create ns <span class="nv">$USER</span>

<span class="c"># åˆ›å»º SA</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  name: </span><span class="nv">$USER</span><span class="sh">-sa
  namespace: </span><span class="nv">$USER</span><span class="sh">
</span><span class="no">EOF

</span><span class="c"># åˆ›å»ºä¸€ä¸ªè§’è‰²ï¼Œå¹¶æ§åˆ¶èµ„æºï¼Œè°ƒæ•´è¿™éƒ¨åˆ†åˆ†é…æ‚¨éœ€è¦çš„èµ„æºæƒé™</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: </span><span class="nv">$USER</span><span class="sh">-role
  namespace: </span><span class="nv">$USER</span><span class="sh">
rules:
- apiGroups: [""]
  resources: 
  - pods
  - deployments
  - configmaps
  - services
  verbs: 
  - get
  - list
  - watch
  - create
  - update
  - delete
</span><span class="no">EOF

</span><span class="c"># åˆ›å»º Role Binding</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl apply -f -
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: </span><span class="nv">$USER</span><span class="sh">-binding
  namespace: </span><span class="nv">$USER</span><span class="sh">
subjects:
- kind: ServiceAccount
  name: </span><span class="nv">$USER</span><span class="sh">-sa
roleRef:
  kind: Role
  name: </span><span class="nv">$USER</span><span class="sh">-role
  apiGroup: rbac.authorization.k8s.io
</span><span class="no">EOF

</span><span class="nv">KUBE_APISERVER</span><span class="o">=</span><span class="sb">`</span>kubectl config view <span class="nt">--minify</span> <span class="nt">-o</span><span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.clusters[*].cluster.server}"</span><span class="sb">`</span>
<span class="nv">TOKEN_KEY</span><span class="o">=</span><span class="sb">`</span>kubectl get sa <span class="nv">$USER</span><span class="nt">-sa</span> <span class="nt">-n</span> <span class="nv">$USER</span> <span class="nt">-o</span><span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.secrets[0].name}"</span><span class="sb">`</span>
<span class="nv">TOKEN</span><span class="o">=</span><span class="sb">`</span>kubectl get secrets <span class="nv">$TOKEN_KEY</span> <span class="nt">-n</span> <span class="nv">$USER</span> <span class="nt">-o</span><span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.data.token}"</span><span class="sb">`</span>
<span class="nv">CLUSTER_AUTH</span><span class="o">=</span><span class="sb">`</span>kubectl config view <span class="nt">--flatten</span> <span class="nt">--minify</span> <span class="nt">-o</span><span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.clusters[0].cluster.certificate-authority-data}"</span><span class="sb">`</span>
<span class="nv">TOKEN_DECODE</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$TOKEN</span> | <span class="nb">base64</span> <span class="nt">--decode</span><span class="sb">`</span>

<span class="c"># ç”Ÿäº§ kubeconfig æ–‡ä»¶</span>
<span class="nb">cat</span> <span class="o">&gt;</span> <span class="nv">$USER</span>.config  <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Config
users:
- name: </span><span class="nv">$USER</span><span class="sh">
  user:
    token: </span><span class="nv">$TOKEN_DECODE</span><span class="sh">
clusters:
- cluster:
    certificate-authority-data: </span><span class="nv">$CLUSTER_AUTH</span><span class="sh">
    server: </span><span class="nv">$KUBE_APISERVER</span><span class="sh">
  name: </span><span class="nv">$USER</span><span class="sh">-cluster
contexts:
- context:
    cluster: </span><span class="nv">$USER</span><span class="sh">-cluster
    namespace: </span><span class="nv">$USER</span><span class="sh">
    user: </span><span class="nv">$USER</span><span class="sh">
  name: </span><span class="nv">$USER</span><span class="sh">-cluster
current-context: </span><span class="nv">$USER</span><span class="sh">-cluster
</span><span class="no">EOF

</span><span class="nb">cat</span> <span class="nv">$USER</span>.config | pbcopy

<span class="nb">echo
echo</span> <span class="s2">"æˆåŠŸäº†ï¼ï¼ï¼ï¼"</span>
<span class="nb">echo
echo
echo</span> <span class="s2">"kubeconfig æ–‡ä»¶å·²ç»ä¿å­˜ä¸º ./</span><span class="nv">$USER</span><span class="s2">.configï¼Œå¹¶å·²ç»æ‹·è´è‡³æ‚¨çš„å‰ªåˆ‡æ¿ä¸­äº†ã€‚"</span>
<span class="nb">echo</span> <span class="s2">"å½“å‰ kubeconfig ä»…å…è®¸è®¿é—®å‘½åç©ºé—´ </span><span class="nv">$USER</span><span class="s2"> ä¸‹çš„ç‰¹å®šèµ„æºã€‚"</span>
<span class="nb">echo
echo</span> <span class="s2">"æ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤è¯•è¯•çœ‹ï¼š"</span>
<span class="nb">echo</span> <span class="s2">"kubectl get po --kubeconfig=./</span><span class="nv">$USER</span><span class="s2">.config"</span>
<span class="nb">echo</span> <span class="s2">"kubectl get secret --kubeconfig=./</span><span class="nv">$USER</span><span class="s2">.config"</span>
<span class="nb">echo</span> <span class="s2">"kubectl get po --kubeconfig=./</span><span class="nv">$USER</span><span class="s2">.config -n default"</span>
</code></pre></div></div>

<ul>
  <li>æ‰§è¡Œ ./create-key.sh æˆ–è€… ./create-key.sh well éƒ½å¯ä»¥ã€‚</li>
  <li>æ‰§è¡Œå®Œæˆä¼šåœ¨å½“å‰ç›®å½•ä¸‹ä¿å­˜ä¸€ä¸ª well.config çš„æ–‡ä»¶ï¼Œè¿™ä¸ªå°±æ˜¯ kubeconfig æ–‡ä»¶ï¼Œå‘ç»™ä½¿ç”¨è¿™å°±å¥½ã€‚æˆ–è€…å°†å‰ªåˆ‡æ¿é‡Œçš„å†…å®¹è´´ç»™ä½¿ç”¨è€…ã€‚</li>
  <li>æœ¬è„šæœ¬ç»™äº†æµ‹è¯•ç”¨ä¾‹ï¼Œå…¶ä¸­ï¼Œkubectl get po æœ‰æƒé™ï¼Œkubectl get secret æ²¡æœ‰æƒé™ï¼Œkubectl get po -n default æ²¡æœ‰æƒé™ã€‚</li>
  <li>ä¿®æ”¹ Role çš„éƒ¨åˆ†ï¼Œå¯ä»¥ç²¾ç»†æ§åˆ¶æƒé™ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºå¤šä¸ª Role å’Œ Bindingï¼Œå¯¹ä¸åŒçš„èµ„æºåˆ†æƒé™æ§åˆ¶ã€‚</li>
  <li>éœ€è¦é‡Šæ”¾èµ„æºï¼Œç›´æ¥åˆ é™¤å‘½åç©ºé—´ï¼Œæ–¹ä¾¿å¿«æ·ã€‚<code class="language-plaintext highlighter-rouge">kubectl delete ns well</code></li>
</ul>

<p>æ­¤è„šæœ¬åœ¨ Mac ä¸‹æµ‹è¯•é€šè¿‡ã€‚</p>]]></content><author><name></name></author><category term="container" /><summary type="html"><![CDATA[â€‹ åœ¨å¼€å‘æµ‹è¯•åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¼€é€šäº† k8s é›†ç¾¤ï¼Œéœ€è¦æŠŠé›†ç¾¤çš„èµ„æºåˆ†é…ç»™ä½¿ç”¨è€…ï¼Œä½†å¸Œæœ›ä»–ä»¬åªèƒ½åœ¨è‡ªå·±çš„å‘½åç©ºé—´ä½¿ç”¨èµ„æºï¼Œä¸å½±å“å…¶ä»–äººçš„ã€‚]]></summary></entry><entry><title type="html">ä½¿ç”¨ docker ä½œä¸º Web å¼€å‘æœåŠ¡å™¨</title><link href="https://cloudbeer.github.io/2020/06/docker-as-web-server.html" rel="alternate" type="text/html" title="ä½¿ç”¨ docker ä½œä¸º Web å¼€å‘æœåŠ¡å™¨" /><published>2020-06-07T16:10:49+00:00</published><updated>2020-06-07T16:10:49+00:00</updated><id>https://cloudbeer.github.io/2020/06/docker-as-web-server</id><content type="html" xml:base="https://cloudbeer.github.io/2020/06/docker-as-web-server.html"><![CDATA[<p>æä¾›ä¸€ç§æ€è·¯ï¼Œä¸´æ—¶å¯åŠ¨ä¸€ä¸ª nginx å®¹å™¨ä½œä¸ºæœåŠ¡å™¨æ¥å¼€å‘å‰ç«¯åº”ç”¨ï¼Œnginx ä½œä¸ºé™æ€é¡µé¢å‘å¸ƒå™¨ï¼Œå¹¶å¯ä»¥ä»£ç†è¿œç«¯ APIã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ shell ä¸­æ“ä½œæ‰“å¼€æµè§ˆå™¨ï¼Œå¹¶ç›‘æ§æ–‡ä»¶çš„æ”¹å˜å¹¶åˆ·æ–°æµè§ˆå™¨ã€‚phpï¼Œpython ç­‰è„šæœ¬ç±»çš„ web å¼€å‘ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œåªéœ€è¦æ›´æ¢ç›¸åº”çš„ server é•œåƒä½œä¸ºå®¹å™¨è¿è¡Œçš„åŸºç¡€ç¯å¢ƒã€‚</p>

<h2 id="å‰ææ¡ä»¶">å‰ææ¡ä»¶</h2>

<ul>
  <li>å®‰è£…äº† dockerï¼šå®‰è£…æ–¹æ³•ç•¥ã€‚</li>
  <li>nginx é•œåƒï¼š <code class="language-plaintext highlighter-rouge">docker pull nginx:alpine</code>Â ã€‚</li>
  <li>è¿™ä¸ªä¾‹å­ä½¿ç”¨äº† python ä½œä¸ºè„šæœ¬è¯­è¨€ã€‚</li>
</ul>

<p>ä»¥ä¸‹è„šæœ¬æˆ‘åœ¨ mac ä¸­è¿è¡Œé€šè¿‡ã€‚</p>

<h2 id="nginx-é…ç½®">nginx é…ç½®</h2>

<p>é¦–å…ˆé…ç½® nginxï¼Œè¿™ä¸ªè„šæœ¬ä¼šä»å®¹å™¨ä¸­å¯åŠ¨ï¼Œå¯åŠ¨åï¼Œå®¹å™¨çš„ /app æ˜¯ä¸»ç›®å½•ï¼Œå¹¶åå‘ä»£ç†äº† 2 ç»„ apiã€‚</p>

<p>å¦‚æœè¿œç«¯æœåŠ¡å™¨æ˜¯æœ¬æœºï¼Œéœ€è¦ä»å®¹å™¨å†…éƒ¨è®¿é—®å®¿ä¸»æœºèµ„æºï¼Œlocalhost æ˜¯ä¸å¥½ä½¿çš„ï¼Œè¯·ä½¿ç”¨åŸŸåï¼š<code class="language-plaintext highlighter-rouge">host.docker.internal</code></p>

<p>nginx çš„é…ç½®å¦‚ä¸‹ï¼š</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span> 
  <span class="kn">listen</span>       <span class="mi">8500</span><span class="p">;</span>
  <span class="kn">index</span>   <span class="s">index.html</span><span class="p">;</span>
  <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
    <span class="kn">index</span>   <span class="s">index.html</span><span class="p">;</span>
    <span class="kn">root</span>    <span class="n">/app</span><span class="p">;</span>
    <span class="kn">expires</span> <span class="s">1s</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kn">location</span> <span class="s">^~/api/crm/</span> <span class="p">{</span>
    <span class="kn">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
    <span class="kn">proxy_pass</span>      <span class="s">http://host.docker.internal:7304/</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kn">location</span> <span class="s">^~/api/qq/</span> <span class="p">{</span>
    <span class="kn">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
    <span class="kn">proxy_pass</span>      <span class="s">http://www.qq.com/api/</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="docker">docker</h2>

<p>docker å¯åŠ¨è„šæœ¬å¦‚ä¸‹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-it</span> <span class="nt">-v</span> &lt;publishPath&gt;:/app <span class="nt">-v</span> &lt;nginxConfPath&gt;:/etc/nginx/conf.d/server.conf <span class="nt">-p</span> 8500:8500 nginx:alpine
</code></pre></div></div>

<p>ç›´æ¥è¿è¡Œè¿™ä¸ªè„šæœ¬ï¼Œæ‰“å¼€ <a href="http://localhost:8500">http://localhost:8500</a>ï¼Œæˆ‘ä»¬çš„ç®€æ˜“å¼€å‘æœåŠ¡ç¯å¢ƒå°±æ­å»ºèµ·æ¥äº†ã€‚æ¯æ¬¡ä¿®æ”¹æ–‡ä»¶çš„æ—¶å€™ï¼Œåˆ·æ–°æµè§ˆå™¨å°±å¯ä»¥çœ‹åˆ°æ”¹å˜ã€‚</p>

<p>ä½†ï¼Œå¦‚æœèƒ½è‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨å°±åœ†æ»¡äº†ã€‚ä¸‹é¢å’±ä»¬è¯•ç€æ¥è§£å†³æ­¤é—®é¢˜ã€‚</p>

<h2 id="å¼€å‘è¿‡ç¨‹ä¸­çš„è‡ªåŠ¨åˆ·æ–°">å¼€å‘è¿‡ç¨‹ä¸­çš„è‡ªåŠ¨åˆ·æ–°</h2>

<p>æˆ‘æƒ³ç›´æ¥é€šè¿‡å¤–éƒ¨è„šæœ¬ç›‘æ§æ–‡ä»¶çš„æ”¹å˜ã€‚å¹¶è‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨ã€‚</p>

<p>docker è„šæœ¬ä¹Ÿæ”¾åœ¨é‡Œé¢ä¸€èµ·æ‰§è¡Œç®—äº†ã€‚</p>

<p>å®Œæˆè¿™æ¬¡ä»»åŠ¡ä½¿ç”¨äº† pythonï¼Œå®Œæ•´çš„è„šæœ¬æ˜¯è¿™ä¹ˆå†™çš„ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
#coding=utf-8
</span>
<span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">webbrowser</span>
<span class="kn">import</span> <span class="nn">_thread</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">watchdog.observers</span> <span class="kn">import</span> <span class="n">Observer</span>
<span class="kn">from</span> <span class="nn">watchdog.events</span> <span class="kn">import</span> <span class="n">FileSystemEventHandler</span>

<span class="c1"># å¯åŠ¨æµè§ˆå™¨ï¼Œå¹¶è®¿é—®ç›®æ ‡åœ°å€
</span><span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Chrome</span><span class="p">()</span>
<span class="n">driver</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://localhost:8500'</span><span class="p">)</span>

<span class="c1"># å½“å‰å·¥ä½œç›®å½•
</span><span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="c1"># æˆ‘å½“å‰çš„å‘å¸ƒç›®å½•
</span><span class="n">publishPath</span> <span class="o">=</span> <span class="n">cwd</span> <span class="o">+</span> <span class="s">"/publish"</span>


<span class="k">def</span> <span class="nf">dockerServer</span><span class="p">():</span>
  <span class="s">""" æ­¤å‡½æ•°å¯åŠ¨ docker """</span>
  <span class="n">dockerCmd</span> <span class="o">=</span> <span class="p">[</span><span class="s">'docker'</span><span class="p">,</span> <span class="s">'run'</span><span class="p">,</span> <span class="s">'--rm'</span><span class="p">,</span> <span class="s">'-it'</span><span class="p">,</span> 
                <span class="s">'-v'</span><span class="p">,</span> <span class="n">publishPath</span> <span class="o">+</span><span class="s">":/app"</span><span class="p">,</span>
                <span class="s">'-v'</span><span class="p">,</span> <span class="n">cwd</span><span class="o">+</span><span class="s">"/server.conf:/etc/nginx/conf.d/server.conf"</span><span class="p">,</span>
                <span class="s">'-p'</span><span class="p">,</span> <span class="s">"8500:8500"</span><span class="p">,</span> <span class="s">'nginx:alpine'</span><span class="p">]</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"å¼€å§‹æ‰§è¡Œ nginx in docker..."</span><span class="p">)</span>
  <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="s">" "</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">dockerCmd</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">refreshBrowser</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
  <span class="s">""" å»¶æ—¶ 1 ç§’åˆ·æ–°æµè§ˆå™¨ï¼Œå½“æœ‰å¤§é‡æ–‡ä»¶è¢«æ›´æ–°æ—¶å€™ï¼Œå¯ä»¥ä¸¢å¼ƒæ— æ•ˆåˆ·æ–°åŠ¨ä½œ """</span>
  <span class="k">print</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="s">"ç§’ååˆ·æ–°æµè§ˆå™¨..."</span><span class="p">)</span>
  <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
  <span class="n">driver</span><span class="p">.</span><span class="n">refresh</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">RefreshBrowserHandler</span><span class="p">(</span><span class="n">FileSystemEventHandler</span><span class="p">):</span>
  <span class="s">""" watchdog çš„ç›‘æ§äº‹ä»¶ """</span>
  <span class="k">def</span> <span class="nf">on_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="n">refreshBrowser</span><span class="p">()</span>  <span class="c1"># è¿™é‡Œéœ€æ”¹è¿›ï¼Œåº”è¯¥å°†ä»»åŠ¡æ”¾åˆ°çº¿ç¨‹æ± é‡Œï¼Œä»¥ä¾¿ä¸¢å¼ƒæŒç»­åˆ·æ–°æ“ä½œã€‚
</span>
<span class="k">def</span> <span class="nf">watchPublish</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
  <span class="s">""" watchdog ç›‘æ§å‘å¸ƒç›®å½•ï¼Œä¸€æ—¦å‘ç°æ–‡ä»¶æ”¹å˜ï¼Œä¾¿å‡ºå‘åˆ·æ–°äº‹ä»¶ """</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"æ­£åœ¨ç›‘æ§ç›®å½•æ”¹å˜:"</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
  <span class="n">event_handler</span> <span class="o">=</span> <span class="n">RefreshBrowserHandler</span><span class="p">()</span>
  <span class="n">observer</span> <span class="o">=</span> <span class="n">Observer</span><span class="p">()</span>
  <span class="n">observer</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">event_handler</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">observer</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
    <span class="n">observer</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
  <span class="n">observer</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>


<span class="c1"># å¯åŠ¨
</span><span class="n">_thread</span><span class="p">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="n">dockerServer</span><span class="p">,</span> <span class="p">())</span>
<span class="n">_thread</span><span class="p">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="n">refreshBrowser</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="n">watchPublish</span><span class="p">(</span><span class="n">publishPath</span><span class="p">)</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„è„šæœ¬éœ€è¦å¦‚ä¸‹çš„ä¾èµ–ï¼š</p>

<ul>
  <li>python è‡ªå¸¦çš„ webbrowser æ— æ³•æ§åˆ¶åˆ·æ–°æµè§ˆå™¨ï¼Œæ‰€ä»¥é‡‡ç”¨äº† selenium åŒ…: <code class="language-plaintext highlighter-rouge">pip install selenium</code> ã€‚</li>
  <li>æˆ‘ä½¿ç”¨äº† chomeï¼Œä½†æç¤ºæ— æ³•æ‰¾åˆ° chromedriverï¼Œä¸‹è½½ä¸€ä¸ªå®‰è£…å¥½äº†ï¼Œä»è¿™é‡Œä¸‹è½½ï¼š<a href="http://npm.taobao.org/mirrors/chromedriver">http://npm.taobao.org/mirrors/chromedriver</a>ï¼Œæ‰¾åˆ°å’Œä½ å½“å‰æµè§ˆå™¨ç‰ˆæœ¬åŒ¹é…çš„å®‰è£…åŒ…ã€‚</li>
  <li>å¦å¤–éœ€è¦å®‰è£…çš„åŒ… æ˜¯ watchdogï¼Œä¹Ÿ pip å®‰è£…ä¸€ä¸‹ã€‚</li>
</ul>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>docker çš„ images å¹³æ—¶å°±åœ¨é‚£é‡Œå®‰é™çš„èººç€ï¼Œç­‰æˆ‘ä»¬éœ€è¦å¼€å‘çš„æ—¶å€™ï¼Œå¯åŠ¨ä»–ï¼Œå¼€å‘å®Œç”¨ ctrl+c å…³é—­ä»–ï¼Œç”±äºä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">--rm</code>ï¼Œdocker çš„å®ä¾‹ä¹Ÿè·Ÿç€æ¸…é™¤äº†ï¼Œå¾ˆæ¸…çˆ½ã€‚</p>

<p>æ¨è€Œå¹¿ä¹‹ï¼Œè¿™ç§æ–¹æ³•å¯¹äºæ‰€æœ‰è„šæœ¬ç±»çš„ Web å¼€å‘éƒ½æœ‰æ•ˆï¼Œæˆ‘ä»¬æ— éœ€å®‰è£…ä»»ä½•ç¯å¢ƒï¼Œåªéœ€è¦ä¸´æ—¶å¯åŠ¨ä¸€ä¸ª docker å®¹å™¨å°±å¥½ï¼Œå¤„å¥³åº§ç¨‹åºå‘˜å¯ä»¥è¯•è¯•è¿™ç§æ–¹æ³•ã€‚</p>

<hr />

<p>å‚è€ƒï¼š</p>

<p><a href="https://stackoverflow.com/questions/32923451/how-to-run-an-function-when-anything-changes-in-a-dir-with-python-watchdog">How to run an function when anything changes in a dir with Python Watchdog?</a></p>

<p><a href="https://selenium-python.readthedocs.io/">Selenium with Python</a></p>]]></content><author><name></name></author><category term="container" /><summary type="html"><![CDATA[æä¾›ä¸€ç§æ€è·¯ï¼Œä¸´æ—¶å¯åŠ¨ä¸€ä¸ª nginx å®¹å™¨ä½œä¸ºæœåŠ¡å™¨æ¥å¼€å‘å‰ç«¯åº”ç”¨ï¼Œnginx ä½œä¸ºé™æ€é¡µé¢å‘å¸ƒå™¨ï¼Œå¹¶å¯ä»¥ä»£ç†è¿œç«¯ APIã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ shell ä¸­æ“ä½œæ‰“å¼€æµè§ˆå™¨ï¼Œå¹¶ç›‘æ§æ–‡ä»¶çš„æ”¹å˜å¹¶åˆ·æ–°æµè§ˆå™¨ã€‚phpï¼Œpython ç­‰è„šæœ¬ç±»çš„ web å¼€å‘ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œåªéœ€è¦æ›´æ¢ç›¸åº”çš„ server é•œåƒä½œä¸ºå®¹å™¨è¿è¡Œçš„åŸºç¡€ç¯å¢ƒã€‚]]></summary></entry></feed>