<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.1">Jekyll</generator><link href="https://youbug.cn/feed.xml" rel="self" type="application/atom+xml" /><link href="https://youbug.cn/" rel="alternate" type="text/html" /><updated>2023-03-29T17:25:02+00:00</updated><id>https://youbug.cn/feed.xml</id><title type="html">YouBug</title><subtitle>åˆ†äº«ï¼Œè®°å½•è€Œå·²</subtitle><entry><title type="html">AI/ML Bookmarks</title><link href="https://youbug.cn/2023/03/aiml-awsome-projects.html" rel="alternate" type="text/html" title="AI/ML Bookmarks" /><published>2023-03-29T02:10:49+00:00</published><updated>2023-03-29T02:10:49+00:00</updated><id>https://youbug.cn/2023/03/aiml-awsome-projects</id><content type="html" xml:base="https://youbug.cn/2023/03/aiml-awsome-projects.html"><![CDATA[<p>æœ¬æ–‡å°±æ˜¯ Bookmarksï¼Œæ˜¯æˆ‘ä½“éªŒè¿‡çš„(ğŸ¦‹)ï¼Œæ­£åœ¨ä½“éªŒçš„æˆ–å‡†å¤‡ä½“éªŒçš„ä¸€äº›ç°æˆçš„åº“å’Œé“¾æ¥ã€‚æœ¬æ–‡è¿‘æœŸå¯èƒ½éšæ—¶æ›´æ–°ã€‚</p>

<h2 id="-ä¸­æ–‡è¯­è¨€å¤§æ¨¡å‹">ğŸ ä¸­æ–‡è¯­è¨€å¤§æ¨¡å‹</h2>

<h3 id="chatglm-">ChatGLM ğŸ¦‹</h3>

<p>æ¸…åå¤§å­¦çš„å¤§è¯­è¨€æ¨¡å‹ã€‚</p>

<p>ChatGLM-6B æ˜¯ä¸€ä¸ªå¼€æºçš„ã€æ”¯æŒä¸­è‹±åŒè¯­çš„å¯¹è¯è¯­è¨€æ¨¡å‹ã€‚</p>

<p><a href="https://github.com/THUDM/ChatGLM-6B">https://github.com/THUDM/ChatGLM-6B</a></p>

<p><a href="https://huggingface.co/THUDM">https://huggingface.co/THUDM</a></p>

<h3 id="chatyuan-">ChatYuan ğŸ¦‹</h3>

<p>Large Language Model for Dialogue in Chinese and Englishï¼Œæ˜¯ä¸€ä¸ªæ”¯æŒä¸­è‹±åŒè¯­çš„åŠŸèƒ½å‹å¯¹è¯è¯­è¨€å¤§æ¨¡å‹ã€‚</p>

<p><a href="https://github.com/clue-ai/ChatYuan">https://github.com/clue-ai/ChatYuan</a></p>

<p><a href="https://www.clueai.cn/">https://www.clueai.cn/</a></p>

<p><a href="https://huggingface.co/ClueAI">https://huggingface.co/ClueAI</a></p>

<h2 id="--è™šæ‹Ÿä¸»æ’­">ğŸ  è™šæ‹Ÿä¸»æ’­</h2>

<h3 id="sadtalker-">SadTalker ğŸ¦‹</h3>

<p>Learning Realistic 3D Motion Coefficients for Stylized Audio-Driven Single Image Talking Face Animation</p>

<p>è¾“å…¥å›¾ç‰‡æ–‡ä»¶ï¼Œå£°éŸ³æ–‡ä»¶ï¼Œç”Ÿæˆç¬¦åˆå£å‹çš„æ’­éŸ³è§†é¢‘ã€‚</p>

<p><a href="https://github.com/Winfredy/SadTalker">https://github.com/Winfredy/SadTalker</a></p>

<blockquote>
  <p>å½“å‰ç‰¹æ€§ï¼š</p>

  <ul>
    <li>3D æ•ˆæœ</li>
    <li>å¯ä»¥çœ¨çœ¼ç›</li>
    <li>
      <p>é•œå¤´ï¼Œçœ¼ç¥è½¬ç§»</p>
    </li>
    <li>è¾“å…¥å›¾ç‰‡ä¼šè¢«æˆªå–è„¸éƒ¨æ”¾å¤§ (2023-03-28)</li>
    <li>ç”Ÿæˆçš„è§†é¢‘åå°  (2023-03-28)</li>
    <li>ç¨‹åºè¿è¡Œç¯å¢ƒè¾ƒä¸ºè‹›åˆ»ï¼Œéœ€è¦ N å¡ï¼Œ cudnn ç­‰ (2023-03-28)</li>
  </ul>
</blockquote>

<h3 id="wav2lip">Wav2Lip</h3>

<p>Accurately Lip-syncing Videos In The Wild.</p>

<p><a href="https://github.com/Rudrabha/Wav2Lip">https://github.com/Rudrabha/Wav2Lip</a></p>

<p><a href="https://www.youtube.com/watch?v=Ic0TBhfuOrA">https://www.youtube.com/watch?v=Ic0TBhfuOrA</a></p>

<h2 id="-å£°éŸ³">ğŸ å£°éŸ³</h2>

<h3 id="audioldm-">audioldm ğŸ¦‹</h3>

<p>Generate speech, sound effects, music and beyond.</p>

<p>This repo currently support:</p>

<ul>
  <li>Text-to-Audio Generation: Generate audio given text input.</li>
  <li>Audio-to-Audio Generation: Given an audio, generate another audio that contain the same type of sound.</li>
  <li>Text-guided Audio-to-Audio Style Transfer: Transfer the sound of an audio into another one using the text description.</li>
</ul>

<p><a href="https://github.com/haoheliu/AudioLDM">https://github.com/haoheliu/AudioLDM</a></p>

<p><a href="https://audioldm.github.io/">https://audioldm.github.io/</a></p>

<blockquote>
  <ul>
    <li>é€šè¿‡æ–‡æœ¬ç”Ÿäº§å£°éŸ³</li>
    <li>ä¹Ÿå¯ä»¥ç”ŸæˆéŸ³ä¹</li>
    <li>å½“å‰é»˜è®¤çš„ model æ•ˆæœä¸€èˆ¬ï¼Œä¸çŸ¥é“è‡ªå·±ç»ƒä¼šæ€æ · (2023-03-29)</li>
  </ul>
</blockquote>

<h2 id="--è¯•ç©¿try-on">ğŸ  è¯•ç©¿(Try-On)</h2>

<h3 id="dressing-in-order-dior">Dressing in Order (DiOr)</h3>

<p>Dressing in Order: Recurrent Person Image Generation for Pose Transfer, Virtual Try-on and Outfit Editing.</p>

<p>å¯ä»¥å¤šä»¶è¡£æœã€‚</p>

<p><a href="https://github.com/cuiaiyu/dressing-in-order">https://github.com/cuiaiyu/dressing-in-order</a></p>

<h3 id="hr-viton">HR-VITON</h3>

<p><a href="https://github.com/sangyun884/HR-VITON">https://github.com/sangyun884/HR-VITON</a></p>

<p><a href="https://github.com/shadow2496/VITON-HD">https://github.com/shadow2496/VITON-HD</a></p>

<h3 id="pidm">PIDM</h3>

<p>Person Image Synthesis via Denoising Diffusion Model Open</p>

<p>å¯ä»¥æ§åˆ¶å§¿æ€ã€‚æä¾› ipynb æ–‡ä»¶ã€‚</p>

<p><a href="https://github.com/ankanbhunia/PIDM">https://github.com/ankanbhunia/PIDM</a></p>

<h2 id="--å¼€æº-ui">ğŸ  å¼€æº UI</h2>

<h3 id="stable-diffusion-web-ui-">Stable Diffusion web UI ğŸ¦‹</h3>

<p>Diffussion ç”Ÿå›¾ and Moreï¼Œæ— éœ€å¤šè¨€ã€‚</p>

<p><a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui">https://github.com/AUTOMATIC1111/stable-diffusion-webui</a></p>

<h3 id="invokeai-">InvokeAI ğŸ¦‹</h3>

<p>Diffussion ç”Ÿå›¾ï¼Œç•Œé¢ç²¾ç¾ã€‚</p>

<p><a href="https://github.com/invoke-ai/InvokeAI">https://github.com/invoke-ai/InvokeAI</a></p>

<p><a href="https://invoke-ai.github.io/InvokeAI/">https://invoke-ai.github.io/InvokeAI/</a></p>

<h2 id="--å•†ä¸šåœ¨çº¿åº”ç”¨">ğŸ  å•†ä¸š/åœ¨çº¿åº”ç”¨</h2>

<h3 id="openai">OpenAI</h3>

<p>ChatGPT</p>

<p>DALL.E</p>

<p>â€¦</p>

<h3 id="midjourney-">midjourney ğŸ¦‹</h3>

<p>Diffussion ç”Ÿå›¾ï¼Œåœ¨ Discord å†…ä½¿ç”¨ã€‚</p>

<p><a href="https://www.midjourney.com/">https://www.midjourney.com/</a></p>

<h3 id="leonardoai">Leonardo.ai</h3>

<p>Diffussion ç”Ÿå›¾ï¼Œåœ¨ Discord å†…ä½¿ç”¨ã€‚</p>

<p><a href="https://leonardo.ai/">https://leonardo.ai/</a></p>

<h3 id="playground-ai-">Playground AI ğŸ¦‹</h3>

<p>æ¯å¤©å…è´¹ 1000 å¼ ï¼Œé™å®šæ¨¡å‹ä¸º SD 1.5, SD 2.1ã€‚Prompt å‚è€ƒã€‚</p>

<p><a href="https://playgroundai.com/">https://playgroundai.com/</a></p>

<h3 id="prompthero">PromptHero</h3>

<p>Prompt å‚è€ƒï¼ŒPro ç‰ˆæœ¬æä¾› SD æ¨¡å‹ç”Ÿäº§ã€‚</p>

<p><a href="https://prompthero.com/">https://prompthero.com/</a></p>

<h3 id="runaway-ml">runaway ml</h3>

<p>åœ¨çº¿è§†é¢‘å·¥å…· <a href="https://app.runwayml.com/">https://app.runwayml.com/</a></p>

<p>å¼€æºï¼š<a href="https://github.com/runwayml">https://github.com/runwayml</a></p>

<h3 id="d-id-">D-ID ğŸ¦‹</h3>

<p>æ•°å­—äººåˆæˆã€‚</p>

<p><a href="https://www.d-id.com/">https://www.d-id.com/</a></p>

<h3 id="ç™¾åº¦æ–‡å¿ƒ">ç™¾åº¦æ–‡å¿ƒ</h3>

<p>æ–‡å¿ƒå¤§æ¨¡å‹</p>

<p><a href="https://wenxin.baidu.com/">https://wenxin.baidu.com/</a></p>

<p>æ–‡å¿ƒä¸€è¨€</p>

<p><a href="https://yiyan.baidu.com/">https://yiyan.baidu.com/</a></p>

<p>æ–‡å¿ƒä¸€æ ¼ ğŸ¦‹</p>

<p><a href="https://yige.baidu.com/">https://yige.baidu.com/</a></p>

<h3 id="ç½‘æ˜“">ç½‘æ˜“</h3>

<p>å¤©éŸ³ - éŸ³ä¹åˆ›ä½œå¹³å°</p>

<p><a href="https://tianyin.163.com/">https://tianyin.163.com/</a></p>

<h2 id="--å…¶ä»–">ğŸ  å…¶ä»–</h2>

<h3 id="film">FILM</h3>

<p>Frame Interpolation for Large Motionï¼Œè§†é¢‘æ’å¸§ã€‚</p>

<p><a href="https://github.com/google-research/frame-interpolation">https://github.com/google-research/frame-interpolation</a></p>

<h3 id="rife">RIFE</h3>

<p>Real-Time Intermediate Flow Estimation for Video Frame Interpolation.</p>

<p>ECCV 2022 - è§†é¢‘æ’å¸§ä¸­çš„å®æ—¶ä¸­é—´æµä¼°è®¡ï¼Œæ—·ä¸–ç§‘æŠ€ã€‚</p>

<p><a href="https://github.com/megvii-research/ECCV2022-RIFE">https://github.com/megvii-research/ECCV2022-RIFE</a></p>

<p><a href="https://zhuanlan.zhihu.com/p/568553080">https://zhuanlan.zhihu.com/p/568553080</a></p>

<h3 id="humannerf">HumanNeRF</h3>

<p>Free-viewpoint Rendering of Moving People from Monocular Video (CVPR 2022)</p>

<p><a href="https://github.com/chungyiweng/humannerf">https://github.com/chungyiweng/humannerf</a></p>

<p><a href="https://github.com/zhaofuq/HumanNeRF">https://github.com/zhaofuq/HumanNeRF</a></p>

<p><a href="https://github.com/Chen-Lehan/HumanNeRF">https://github.com/Chen-Lehan/HumanNeRF</a></p>

<h3 id="sysmocap">SysMocap</h3>

<p>A cross-platform real-time video-driven motion capture and 3D virtual character rendering system for VTuber/Live/AR/VR.</p>

<p>è·¨å¹³å°çš„å®æ—¶è§†é¢‘é©±åŠ¨åŠ¨ä½œæ•æ‰åŠ3Dè™šæ‹Ÿå½¢è±¡ç”Ÿæˆç³»ç»Ÿ for VTuber/Live/AR/VR.</p>

<p><a href="https://github.com/xianfei/SysMocap">https://github.com/xianfei/SysMocap</a></p>]]></content><author><name>å•¤é…’äº‘</name></author><category term="aiml" /><summary type="html"><![CDATA[æœ¬æ–‡å°±æ˜¯ Bookmarksï¼Œæ˜¯æˆ‘ä½“éªŒè¿‡çš„(ğŸ¦‹)ï¼Œæ­£åœ¨ä½“éªŒçš„æˆ–å‡†å¤‡ä½“éªŒçš„ä¸€äº›ç°æˆçš„åº“å’Œé“¾æ¥ã€‚æœ¬æ–‡è¿‘æœŸå¯èƒ½éšæ—¶æ›´æ–°ã€‚]]></summary></entry><entry><title type="html">ä½¿ç”¨ Java ç»„è£… Amazon Textract è§£æå‡ºæ¥çš„é”®å€¼å¯¹</title><link href="https://youbug.cn/2023/03/textract-form-data.html" rel="alternate" type="text/html" title="ä½¿ç”¨ Java ç»„è£… Amazon Textract è§£æå‡ºæ¥çš„é”®å€¼å¯¹" /><published>2023-03-04T05:10:49+00:00</published><updated>2023-03-04T05:10:49+00:00</updated><id>https://youbug.cn/2023/03/textract-form-data</id><content type="html" xml:base="https://youbug.cn/2023/03/textract-form-data.html"><![CDATA[<p>Amazon Textract å°±æ˜¯ OCR, é’ˆå¯¹å›½é™…å•æ®å•¥çš„è¯†åˆ«æœ‰å¥‡æ•ˆï¼Œçœ‹æ§åˆ¶å°çš„ Demo è§‰å¾—å¾ˆå—æƒŠï¼Œå±…ç„¶æœ‰ KV é”®å€¼å¯¹çš„æ˜¾ç¤ºã€‚ä½†ç”¨ Java ä»£ç å’‹è·å–é”®å€¼å¯¹å‘¢ï¼Ÿä»–çš„ KEY_VALUE_SET ç±»å‹çš„ Block ä½¿ç”¨æ–¹æ³• .text() å•¥éƒ½æ²¡æœ‰å“‡ã€‚</p>

<h2 id="java-çš„-block-è¾“å‡º">Java çš„ Block è¾“å‡º</h2>

<p>å…ˆæ‰“å°ä¸€ä¸‹çœ‹çœ‹:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="o">(</span><span class="nc">Block</span> <span class="n">block</span> <span class="o">:</span> <span class="n">blocks</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"The block type is "</span> <span class="o">+</span> <span class="n">block</span><span class="o">.</span><span class="na">blockType</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">block</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"----------\n"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä¸‹é¢æ˜¯æ‰“å°çš„åŸå§‹ Block éƒ¨åˆ†ä¿¡æ¯ï¼ˆå®é™…ä¸Šæœ‰ä¸€å¤§å¨ï¼Œè¿™é‡Œä¸€ä¸ªç±»å‹ç•™äº†ä¸€ä¸ªï¼‰ï¼š</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
The block type is PAGE
Block(BlockType=PAGE, Geometry=Geometry(BoundingBox=BoundingBox(Width=0.8405368, Height=1.0, Left=0.09841533, Top=0.0), Polygon=[Point(X=0.09841533, Y=0.0), Point(X=0.9389521, Y=0.0), Point(X=0.9229099, Y=1.0), Point(X=0.11533637, Y=1.0)]), Id=bbede76c-e163-45ee-81d4-82afc8bad5ad, Relationships=[Relationship(Type=CHILD, Ids=[e694910a-dc8c-4bd4-9b4e-d6262b549705, c959f258-1e33-4591-8394-dce960cc7e55, 82c3e843-c149-4f8b-b3bc-0e3299f6d551, 4932758c-12a7-4bc3-90a4-87a135c54d6e, 01aa9893-ccb2-4b0a-b2a0-ea954b35fe4b, 2975d587-f5de-4436-92f3-480f1c9aa656, 951fca1a-7f9d-475b-8aff-e9e0ef9000d5, ....])])
----------

The block type is LINE
Block(BlockType=LINE, Confidence=70.37652, Text=xxxxxxxxxxx - mail@frankonia.de, Geometry=Geometry(BoundingBox=BoundingBox(Width=0.2087112, Height=0.023847194, Left=0.58435017, Top=0.03585644), Polygon=[Point(X=0.58439976, Y=0.03585644), Point(X=0.7930614, Y=0.036802612), Point(X=0.7928248, Y=0.059703637), Point(X=0.58435017, Y=0.058780655)]), Id=e694910a-dc8c-4bd4-9b4e-d6262b549705, Relationships=[Relationship(Type=CHILD, Ids=[3d1c10aa-9ee9-4efa-8f24-eb4487fcc927, 7e653065-ecf4-47a5-9518-aa4b70fcd7ea, d103f1ac-25ab-48cf-9824-0ff6277e59e2])])
----------

The block type is WORD
Block(BlockType=WORD, Confidence=98.42162, Text=Fax, TextType=PRINTED, Geometry=Geometry(BoundingBox=BoundingBox(Width=0.018412054, Height=0.01635857, Left=0.6832591, Top=0.061593868), Polygon=[Point(X=0.68335754, Y=0.061593868), Point(X=0.7016712, Y=0.061674744), Point(X=0.70156115, Y=0.07795244), Point(X=0.6832591, Y=0.07787301)]), Id=66db8d1e-a1b6-40c4-8a77-afc4fc250870)
----------

The block type is WORD
Block(BlockType=WORD, Confidence=98.718414, Text=â‚¬, TextType=PRINTED, Geometry=Geometry(BoundingBox=BoundingBox(Width=0.0076815123, Height=0.018535566, Left=0.8544621, Top=0.87233585), Polygon=[Point(X=0.8547062, Y=0.87233585), Point(X=0.8621436, Y=0.8723405), Point(X=0.86189395, Y=0.8908714), Point(X=0.8544621, Y=0.8908674)]), Id=db9dcabb-8aa6-4bb7-b924-5f91add0530b)
----------


The block type is KEY_VALUE_SET
Block(BlockType=KEY_VALUE_SET, Confidence=86.59171, Geometry=Geometry(BoundingBox=BoundingBox(Width=0.08317889, Height=0.024558436, Left=0.6154753, Top=0.7993664), Polygon=[Point(X=0.6155607, Y=0.7993664), Point(X=0.6986542, Y=0.79944664), Point(X=0.69848675, Y=0.8239249), Point(X=0.6154753, Y=0.82385427)]), Id=89664d58-b1eb-4ad3-912f-705500e4b08b, Relationships=[Relationship(Type=VALUE, Ids=[0df283e1-7079-46ef-baea-fafedc580ee4]), Relationship(Type=CHILD, Ids=[11a76d29-860a-43f4-bf8a-816b5993ae9c, 47f62df8-6fb1-4b09-b4ff-ac8901f230a3])], EntityTypes=[KEY])
----------

The block type is KEY_VALUE_SET
Block(BlockType=KEY_VALUE_SET, Confidence=86.59171, Geometry=Geometry(BoundingBox=BoundingBox(Width=0.056614958, Height=0.023218233, Left=0.81078696, Top=0.7957822), Polygon=[Point(X=0.8110504, Y=0.7957822), Point(X=0.8674019, Y=0.7958376), Point(X=0.8670859, Y=0.8190004), Point(X=0.81078696, Y=0.8189512)]), Id=0df283e1-7079-46ef-baea-fafedc580ee4, Relationships=[Relationship(Type=CHILD, Ids=[2f71d668-e883-40dc-9d73-0a50d5954e84, 904205cd-0eeb-4bd6-a4e1-05c1dd168182])], EntityTypes=[VALUE])
----------

</code></pre></div></div>

<h2 id="æ•°æ®ç»“æ„åˆ†æ">æ•°æ®ç»“æ„åˆ†æ</h2>

<p>è¿™çœŸæ˜¯ä¸ªè´¹çœ¼ç›çš„æ´»å„¿ï¼Œå¯¹æ¯” python çš„ä»£ç ï¼Œåˆ†æå‡º KEY_VALUE_SET éƒ¨åˆ†çš„ç»“æ„ä¸ºï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">KEY_VALUE_SET</code> åˆ†ç±» <code class="language-plaintext highlighter-rouge">KEY</code> å’Œ <code class="language-plaintext highlighter-rouge">VALUE</code>, è¿™ä¸ªè®°å½•åœ¨ <code class="language-plaintext highlighter-rouge">blockType()</code> ä¸º <code class="language-plaintext highlighter-rouge">KEY_VALUE_SET</code> çš„ <code class="language-plaintext highlighter-rouge">EntityTypes</code> å­—æ®µé‡Œäº†ã€‚</li>
  <li>é€šè¿‡ <code class="language-plaintext highlighter-rouge">KEY</code> çš„ block çš„ <code class="language-plaintext highlighter-rouge">Relationships</code> ä¸­çš„ <code class="language-plaintext highlighter-rouge">CHILD</code> çš„ <code class="language-plaintext highlighter-rouge">Ids</code> å»æ‰¾åˆ°å¯¹åº”çš„ <code class="language-plaintext highlighter-rouge">WORD</code>ï¼Œ<code class="language-plaintext highlighter-rouge">text()</code> å°±æ˜¯ <code class="language-plaintext highlighter-rouge">KEY</code> çš„å€¼äº†ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">KEY</code> block çš„ <code class="language-plaintext highlighter-rouge">Relationships</code> é‡Œæœ‰ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">VALUE</code> çš„å…³ç³»ï¼Œvalue block çš„ <code class="language-plaintext highlighter-rouge">Ids</code> å°±å­˜åœ¨è¿™é‡Œã€‚</li>
  <li>é€šè¿‡ä¸Šé¢çš„ id åŒ¹é… block çš„ <code class="language-plaintext highlighter-rouge">Id</code> å­—æ®µå¾—åˆ°å¯¹åº”çš„ value blockã€‚</li>
  <li>ç„¶åé€šè¿‡ value block <code class="language-plaintext highlighter-rouge">Relationships</code> çš„ <code class="language-plaintext highlighter-rouge">CHILD</code> å†å¯»æ‰¾ä¸º <code class="language-plaintext highlighter-rouge">WORD</code> ç±»å‹çš„ block çš„å€¼ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">LINE</code> ç±»å‹æš‚æ—¶æ²¡ç”¨ä¸Šã€‚</li>
</ul>

<h2 id="å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </h2>

<p>ç„¶åå°±å¯ä»¥å†™å‡º java å¯¹åº”çš„ä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">aws.cloudbeer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">software.amazon.awssdk.auth.credentials.ProfileCredentialsProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">software.amazon.awssdk.regions.Region</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">software.amazon.awssdk.services.textract.TextractClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">software.amazon.awssdk.services.textract.model.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Collectors</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">Region</span> <span class="n">region</span> <span class="o">=</span> <span class="nc">Region</span><span class="o">.</span><span class="na">US_EAST_1</span><span class="o">;</span>
        <span class="nc">TextractClient</span> <span class="n">textractClient</span> <span class="o">=</span> <span class="nc">TextractClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">region</span><span class="o">(</span><span class="n">region</span><span class="o">)</span>
                <span class="o">.</span><span class="na">credentialsProvider</span><span class="o">(</span><span class="nc">ProfileCredentialsProvider</span><span class="o">.</span><span class="na">create</span><span class="o">())</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">analyzeDocS3</span><span class="o">(</span><span class="n">textractClient</span><span class="o">,</span> <span class="s">"cloudbeer-textract"</span><span class="o">,</span> <span class="s">"1.jpg"</span><span class="o">);</span>
        <span class="n">textractClient</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">analyzeDocS3</span><span class="o">(</span><span class="nc">TextractClient</span> <span class="n">textractClient</span><span class="o">,</span> <span class="nc">String</span> <span class="n">bucketName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">docName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">S3Object</span> <span class="n">s3Object</span> <span class="o">=</span> <span class="nc">S3Object</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">bucket</span><span class="o">(</span><span class="n">bucketName</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">docName</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

            <span class="nc">Document</span> <span class="n">myDoc</span> <span class="o">=</span> <span class="nc">Document</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">s3Object</span><span class="o">(</span><span class="n">s3Object</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>


            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">FeatureType</span><span class="o">&gt;</span> <span class="n">featureTypes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">FeatureType</span><span class="o">&gt;();</span>
            <span class="n">featureTypes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">FeatureType</span><span class="o">.</span><span class="na">FORMS</span><span class="o">);</span>
<span class="c1">//            featureTypes.add(FeatureType.TABLES);</span>
<span class="c1">//            featureTypes.add(FeatureType.QUERIES);</span>
<span class="c1">//            featureTypes.add(FeatureType.SIGNATURES);</span>


            <span class="nc">AnalyzeDocumentRequest</span> <span class="n">analyzeDocumentRequest</span> <span class="o">=</span> <span class="nc">AnalyzeDocumentRequest</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">featureTypes</span><span class="o">(</span><span class="n">featureTypes</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">myDoc</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

            <span class="nc">AnalyzeDocumentResponse</span> <span class="n">analyzeDocument</span> <span class="o">=</span> <span class="n">textractClient</span><span class="o">.</span><span class="na">analyzeDocument</span><span class="o">(</span><span class="n">analyzeDocumentRequest</span><span class="o">);</span>

            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Block</span><span class="o">&gt;</span> <span class="n">docInfo</span> <span class="o">=</span> <span class="n">analyzeDocument</span><span class="o">.</span><span class="na">blocks</span><span class="o">();</span>

            <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">kvSets</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>


            <span class="k">for</span> <span class="o">(</span><span class="nc">Block</span> <span class="n">block</span> <span class="o">:</span> <span class="n">docInfo</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">block</span><span class="o">.</span><span class="na">blockType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">BlockType</span><span class="o">.</span><span class="na">KEY_VALUE_SET</span> <span class="o">&amp;&amp;</span> <span class="n">block</span><span class="o">.</span><span class="na">entityTypes</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="nc">EntityType</span><span class="o">.</span><span class="na">KEY</span><span class="o">))</span> <span class="o">{</span>

                    <span class="nc">StringBuilder</span> <span class="n">key</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
                    <span class="nc">StringBuilder</span> <span class="n">val</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>

                    <span class="k">for</span> <span class="o">(</span><span class="nc">Relationship</span> <span class="n">relationship</span> <span class="o">:</span> <span class="n">block</span><span class="o">.</span><span class="na">relationships</span><span class="o">())</span> <span class="o">{</span>
                        <span class="c1">// é€šè¿‡ KeySet  çš„å…³ç³»ä¸­çš„ CHILD å»æ‰¾Keyçš„çš„å€¼</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">relationship</span><span class="o">.</span><span class="na">type</span><span class="o">()</span> <span class="o">==</span> <span class="nc">RelationshipType</span><span class="o">.</span><span class="na">CHILD</span><span class="o">)</span> <span class="o">{</span>
                            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">relationship</span><span class="o">.</span><span class="na">ids</span><span class="o">();</span>
                            <span class="n">key</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">findKeyWord</span><span class="o">(</span><span class="n">docInfo</span><span class="o">,</span> <span class="n">ids</span><span class="o">)).</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="c1">// é€šè¿‡ KeySet çš„å…³ç³»ä¸­çš„ VALUE å»æ‰¾ VALUE çš„ blockï¼Œåœ¨é€šè¿‡ VALUE çš„ CHILD å»æ‰¾å€¼</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">relationship</span><span class="o">.</span><span class="na">type</span><span class="o">()</span> <span class="o">==</span> <span class="nc">RelationshipType</span><span class="o">.</span><span class="na">VALUE</span><span class="o">)</span> <span class="o">{</span>
                            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">relationship</span><span class="o">.</span><span class="na">ids</span><span class="o">();</span>
                            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">id</span> <span class="o">:</span> <span class="n">ids</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">val</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">findValueWord</span><span class="o">(</span><span class="n">docInfo</span><span class="o">,</span> <span class="n">ids</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">))).</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
                            <span class="o">}</span>

                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="n">kvSets</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">val</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">kvSets</span><span class="o">);</span>


        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TextractException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">findValueWord</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Block</span><span class="o">&gt;</span> <span class="n">blocks</span><span class="o">,</span> <span class="nc">String</span> <span class="n">keyId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">StringBuilder</span> <span class="n">rtn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Block</span><span class="o">&gt;</span> <span class="n">valBlock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">blockType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">BlockType</span><span class="o">.</span><span class="na">KEY_VALUE_SET</span> <span class="o">&amp;&amp;</span> <span class="n">keyId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">id</span><span class="o">())).</span><span class="na">findFirst</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">valBlock</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
             <span class="nc">Block</span> <span class="n">block</span> <span class="o">=</span> <span class="n">valBlock</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Relationship</span> <span class="n">relationship</span> <span class="o">:</span> <span class="n">block</span><span class="o">.</span><span class="na">relationships</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// é€šè¿‡ KeySet  çš„å…³ç³» å„¿å­å»æ‰¾Keyçš„çš„å€¼</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">relationship</span><span class="o">.</span><span class="na">type</span><span class="o">()</span> <span class="o">==</span> <span class="nc">RelationshipType</span><span class="o">.</span><span class="na">CHILD</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">relationship</span><span class="o">.</span><span class="na">ids</span><span class="o">();</span>
                    <span class="n">rtn</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">findKeyWord</span><span class="o">(</span><span class="n">blocks</span><span class="o">,</span> <span class="n">ids</span><span class="o">)).</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">rtn</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">findKeyWord</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Block</span><span class="o">&gt;</span> <span class="n">blocks</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">StringBuilder</span> <span class="n">rtn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">id</span> <span class="o">:</span> <span class="n">ids</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Block</span><span class="o">&gt;</span> <span class="n">vBlocks</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">blockType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">BlockType</span><span class="o">.</span><span class="na">WORD</span> <span class="o">&amp;&amp;</span> <span class="n">id</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">id</span><span class="o">())).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">vBlocks</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">rtn</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">vBlocks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">text</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">rtn</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<hr />
<p>å‚è€ƒï¼š</p>

<p>Textract JAVA Demo <a href="https://github.com/awsdocs/aws-doc-sdk-examples/tree/main/javav2/example_code/textract">https://github.com/awsdocs/aws-doc-sdk-examples/tree/main/javav2/example_code/textract</a></p>

<p>Python Extract KV Pairs <a href="https://docs.aws.amazon.com/textract/latest/dg/examples-extract-kvp.html">https://docs.aws.amazon.com/textract/latest/dg/examples-extract-kvp.html</a></p>]]></content><author><name>å•¤é…’äº‘</name></author><category term="aws," /><category term="tucao" /><summary type="html"><![CDATA[Amazon Textract å°±æ˜¯ OCR, é’ˆå¯¹å›½é™…å•æ®å•¥çš„è¯†åˆ«æœ‰å¥‡æ•ˆï¼Œçœ‹æ§åˆ¶å°çš„ Demo è§‰å¾—å¾ˆå—æƒŠï¼Œå±…ç„¶æœ‰ KV é”®å€¼å¯¹çš„æ˜¾ç¤ºã€‚ä½†ç”¨ Java ä»£ç å’‹è·å–é”®å€¼å¯¹å‘¢ï¼Ÿä»–çš„ KEY_VALUE_SET ç±»å‹çš„ Block ä½¿ç”¨æ–¹æ³• .text() å•¥éƒ½æ²¡æœ‰å“‡ã€‚]]></summary></entry><entry><title type="html">åœ¨ AWS é‡Œï¼Œä½¿ç”¨ Jenkins è·¨è´¦å·æ‰§è¡Œä»»åŠ¡</title><link href="https://youbug.cn/2023/03/jenkins-assume-role.html" rel="alternate" type="text/html" title="åœ¨ AWS é‡Œï¼Œä½¿ç”¨ Jenkins è·¨è´¦å·æ‰§è¡Œä»»åŠ¡" /><published>2023-03-02T07:02:33+00:00</published><updated>2023-03-02T07:02:33+00:00</updated><id>https://youbug.cn/2023/03/jenkins-assume-role</id><content type="html" xml:base="https://youbug.cn/2023/03/jenkins-assume-role.html"><![CDATA[<p>åœ¨ AWS ä¸­ï¼Œä¼ä¸šçš„ Jenkins é€šå¸¸å®‰è£…åœ¨å¼€å‘æµ‹è¯•ç¯å¢ƒï¼Œå¦‚æœéœ€è¦æ“ä½œç”Ÿäº§ç¯å¢ƒä¸­çš„èµ„æºï¼Œå¦‚ä½•è®¾ç½®æƒé™å‘¢ï¼Ÿæœ¬æ–‡ä»‹ç»äº†æ–¹æ³•ã€‚</p>

<h2 id="jenkins-configuration-jenkins-è®¾ç½®">Jenkins Configuration ï¼ˆJenkins è®¾ç½®ï¼‰</h2>

<p>As a Jenkins administator, Menu: Manage Jenkins -&gt; Manage Plugins, Search â€œPipeline: AWS Stepsâ€, ensure this Jenkins plugin is installed.</p>

<p>ä»¥ Jenkins çš„ç®¡ç†å‘˜èº«ä»½ç™»å½•ï¼Œè¿›å…¥èœå•ï¼š Manage Jenkins -&gt; Manage Pluginsï¼Œæœç´¢ â€œPipeline: AWS Stepsâ€ï¼Œå®‰è£…è¿™ä¸ªæ’ä»¶ã€‚</p>

<p>From â€œManage Jenkins  -&gt; Configure Systemâ€ to enable â€˜Retrieve credentials from nodeâ€™.</p>

<p>åœ¨èœå• â€œç³»ç»Ÿç®¡ç† -&gt; ç³»ç»Ÿé…ç½®â€ ä¸­ï¼Œå¯ç”¨ â€œPipeline: AWS Stepsâ€ çš„ â€œRetrieve credentials from nodeâ€ã€‚</p>

<h2 id="node-settings-èŠ‚ç‚¹è®¾ç½®jenkins-è¿è¡ŒèŠ‚ç‚¹">Node settings èŠ‚ç‚¹è®¾ç½®ï¼ˆJenkins è¿è¡ŒèŠ‚ç‚¹ï¼‰</h2>

<p>My Jenkins is installed in an EC2 instace and the workers in EC2 also.</p>

<p>Firstly, Bind a role to the EC2. Choose the Jenkins EC2, then choose Actions -&gt; Security -&gt; Modify IAM role.</p>

<p>ç°åœ¨è®¾ç½® Jenkins æ‰€åœ¨çš„ EC2 çš„è§’è‰²ã€‚</p>

<p>é€‰æ‹©ç›®æ ‡ EC2ï¼Œå¹¶é€‰æ‹©å¦‚å›¾çš„èœå•ï¼š</p>

<p><img src="/assets/posts/devops/jenkins-assume-01.png" alt="Set EC2 Role" /></p>

<p>Next, you can choose a role, or create a new one.</p>

<p>When you update the IAM role of EC2, your Jenkins will be granted the role.</p>

<p>ç°åœ¨è¯·é€‰æ‹©ä¸€ä¸ª roleï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚</p>

<p>é€‰æ‹©å¥½ä¹‹åï¼Œæ›´æ–° EC2 çš„ Roleã€‚</p>

<h2 id="create-an-iam-role-in-another-account-åœ¨å¦ä¸€ä¸ªè´¦å·ä¸­åˆ›å»ºè§’è‰²">Create an IAM Role in another account ï¼ˆåœ¨å¦ä¸€ä¸ªè´¦å·ä¸­åˆ›å»ºè§’è‰²ï¼‰</h2>

<p>Now, We can login to the production account.</p>

<p>Create a new role:</p>

<p>ç°åœ¨ç™»å½•åˆ°ç”Ÿäº§è´¦å·ã€‚å¹¶åˆ›å»ºä¸€ä¸ªè§’è‰²ã€‚</p>

<ul>
  <li>Trusted entity type: Amazon Web Services account</li>
  <li>An Amazon Web Services account: Another Amazon Web Services account of the account id of Jenkins installed (number, such as 12345679012).</li>
  <li>Next choose some permissions policy.</li>
  <li>Give the role a name, such as â€˜for-Jenkinsâ€™.</li>
</ul>

<h2 id="modify-the-jenkins-ec2-role">Modify the Jenkins EC2 role</h2>

<p>Now back to the Jenkins account. Modify the ec2 role.</p>

<p>In the â€œPermisionsâ€ tab, choose â€œAdd permissions -&gt; Create inline policyâ€:</p>

<p>ç°åœ¨è¿”å› Jenkins æ‰€åœ¨çš„è´¦å·ï¼Œç»™åˆšåˆš EC2 çš„è§’è‰²è¿›è¡Œè§’è‰²æ‰®æ¼”ã€‚</p>

<p>åœ¨è§’è‰²è®¾ç½®é¢æ¿è®¾ç½®ä¸€ä¸ªå†…è”ç­–ç•¥ï¼Œè¿›å…¥ â€œPermisionsâ€ tab, é€‰æ‹© â€œAdd permissions -&gt; Create inline policyâ€:</p>

<p>The policy is like:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws-cn:iam::&lt;your-prod-account-id&gt;:role/for-Jenkins"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="jenkinsfile">Jenkinsfile</h2>

<p>Now the Jenkinsfile maybe as:</p>

<p>Jenkinsfile è¿™ä¹ˆå†™å°±è¡Œ:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
  <span class="n">agent</span> <span class="n">any</span>
  <span class="n">stages</span> <span class="o">{</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">'build'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">script</span> <span class="o">{</span>
          <span class="n">withAWS</span><span class="o">(</span><span class="nl">role:</span><span class="s1">'for-Jenkins'</span><span class="o">,</span> <span class="nl">roleAccount:</span><span class="s1">'&lt;your-prod-account-id&gt;'</span><span class="o">,</span> <span class="nl">region:</span> <span class="s1">'cn-northwest-1'</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">def</span> <span class="n">res</span> <span class="o">=</span> <span class="n">s3Upload</span><span class="o">(</span><span class="nl">file:</span><span class="s1">'readme.md'</span><span class="o">,</span> <span class="nl">bucket:</span><span class="s1">'xxxx'</span><span class="o">,</span> <span class="nl">path:</span><span class="s1">'readme.md'</span><span class="o">)</span>
            <span class="n">println</span><span class="o">(</span><span class="n">res</span><span class="o">)</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>You will see the file uploaded to the target s3 bucket if the permissions are right.</p>

<p>å¦‚æœæƒé™è®¾ç½®åˆç†ï¼Œå°±å¯ä»¥çœ‹åˆ° Jenkins æˆåŠŸä¸Šä¼ æ–‡ä»¶åˆ°å¦ä¸€ä¸ªè´¦å·äº†ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
Setting AWS region cn-northwest-1 
 Retrieving credentials from node.
Requesting assume role
Assuming role ARN is arn:aws-cn:iam::123456789012:role/ role arn:aws-cn:sts::123456789012:assumed-role/for-Jenkins/Jenkins-Jenkins-withAWS-gitee-16 with <span class="nb">id </span>AROATUJBXHIVWAC6AZW3X:Jenkins-Jenkins-withAWS-gitee-16 
 <span class="o">[</span>Pipeline] <span class="o">{</span>
<span class="o">[</span>Pipeline] s3Upload
Uploading file:/var/Jenkins_home/workspace/Jenkins-withAWS_gitee/readme.md to s3://xxxxx/readme.md 
Finished: Uploading to xxxxx/readme.md
Upload <span class="nb">complete</span>
<span class="o">[</span>Pipeline] <span class="nb">echo
</span>s3://xxxxx/readme.md
<span class="o">[</span>Pipeline] <span class="o">}</span>
<span class="o">[</span>Pipeline] // withAWS
<span class="o">[</span>Pipeline] <span class="o">}</span>
<span class="o">[</span>Pipeline] <span class="o">}</span>
<span class="o">[</span>Pipeline] // stage
<span class="o">[</span>Pipeline] <span class="o">}</span>
<span class="o">[</span>Pipeline] // withEnv
<span class="o">[</span>Pipeline] <span class="o">}</span>
<span class="o">[</span>Pipeline] // node
<span class="o">[</span>Pipeline] End of Pipeline
Finished: SUCCESS
...
</code></pre></div></div>

<h2 id="more">More</h2>

<p>Mybe your Jenkins worker runs in a pod. In this situation, you can use <a href="https://docs.aws.amazon.com/zh_cn/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-enable-IAM.html">IRSA style</a> to assume role between accounts.</p>

<p>If you use AKSK in Jenkins, you can assume the role to the IAM user of AKSK.</p>

<p>å¦‚æœ Jenkins å®‰è£…åœ¨ EKS çš„ Pod é‡Œï¼Œé‚£ä¹ˆå¯ä»¥åˆ©ç”¨ <a href="https://docs.aws.amazon.com/zh_cn/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-enable-IAM.html">IRSA æ–¹å¼</a> è¿›è¡Œè§’è‰²æ‰®æ¼”ã€‚</p>

<p>å¦å¤–ä¸€ç‚¹ï¼Œå¦‚æœåœ¨ Jenkins é‡Œä½¿ç”¨çš„æ˜¯ AKSKï¼Œé‚£ä¹ˆå°±æŠŠè§’è‰²æ‰®æ¼”åˆ° AKSK å¯¹åº”çš„ IAM User å³å¯ã€‚</p>

<hr />

<p>Referencesï¼š</p>

<p><a href="https://plugins.Jenkins.io/pipeline-aws/">Jenkins plugin: Pipeline: AWS Steps</a></p>]]></content><author><name>å•¤é…’äº‘</name></author><category term="devops," /><category term="aws" /><summary type="html"><![CDATA[åœ¨ AWS ä¸­ï¼Œä¼ä¸šçš„ Jenkins é€šå¸¸å®‰è£…åœ¨å¼€å‘æµ‹è¯•ç¯å¢ƒï¼Œå¦‚æœéœ€è¦æ“ä½œç”Ÿäº§ç¯å¢ƒä¸­çš„èµ„æºï¼Œå¦‚ä½•è®¾ç½®æƒé™å‘¢ï¼Ÿæœ¬æ–‡ä»‹ç»äº†æ–¹æ³•ã€‚]]></summary></entry><entry><title type="html">ä½¿ç”¨ Lambda é…åˆ GuardDuty äº‹ä»¶å°ç¦æ”»å‡»æº</title><link href="https://youbug.cn/2023/02/guardduty-lambda-block.html" rel="alternate" type="text/html" title="ä½¿ç”¨ Lambda é…åˆ GuardDuty äº‹ä»¶å°ç¦æ”»å‡»æº" /><published>2023-02-23T05:10:49+00:00</published><updated>2023-02-23T05:10:49+00:00</updated><id>https://youbug.cn/2023/02/guardduty-lambda-block</id><content type="html" xml:base="https://youbug.cn/2023/02/guardduty-lambda-block.html"><![CDATA[<p>åœ¨é’ˆå¯¹ AWS çš„ç½‘ç»œæ”»å‡»è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ç±»æ”»å‡»æ˜¯æš´åŠ›ç ´è§£ root è´¦å·ï¼Œæ­¤ç±»æ”»å‡»ä¼šè¢« GuardDuty ç›‘æ§å¹¶è®°å½•åˆ°ã€‚å½“å‘ç”Ÿæ­¤ç±»æš´åŠ›ç ´è§£äº‹ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ Lambda æ¥å¯¹æ”»å‡»æºè¿›è¡ŒåŠæ—¶å°ç¦ã€‚</p>

<h2 id="lambda-å‡½æ•°">Lambda å‡½æ•°</h2>

<p>ä¸‹é¢çš„ Lambda å‡½æ•°æ˜¯åŸºäº GuardDuty å¯¹ä¸€ä¸ª RDP æš´åŠ›ç ´è§£äº‹ä»¶è¿›è¡Œçš„ å“åº”ï¼Œä½¿ç”¨ nodejs ç¼–å†™ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">aws-sdk</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">innerCidrs</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">172.31.0.0/16</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">172.33.0.0/16</span><span class="dl">"</span><span class="p">];</span> <span class="c1">//å†…ç½‘ IP cidrã€‚</span>
<span class="kd">const</span> <span class="nx">protectedVpcIds</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">vpc-xxxxxxxx</span><span class="dl">'</span><span class="p">];</span> <span class="c1">//å½“å¤–éƒ¨æ”»å‡»æ—¶å€™ï¼Œéœ€è¦ä¿æŠ¤çš„ VPCã€‚</span>
<span class="kd">const</span> <span class="nx">forbiddenSgId</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">sg-xxxxxxxxxxxx</span><span class="dl">"</span><span class="p">;</span> <span class="c1">//é¢„å®šä¹‰çš„éš”ç¦»å®‰å…¨ç»„ IDï¼Œæ­¤å®‰å…¨ç»„è§„åˆ™æ˜¯å…¨éƒ¨å°ç¦ã€‚</span>
<span class="kd">const</span> <span class="nx">region</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">cn-northwest-1</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">region</span><span class="p">});</span>
<span class="kd">const</span> <span class="nx">ec2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">EC2</span><span class="p">();</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">sourceIp</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">sourceIpV4</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">attackType</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">isInnerIp</span> <span class="o">=</span> <span class="nx">checkInnerIp</span><span class="p">(</span><span class="nx">sourceIp</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isInnerIp</span> <span class="o">&amp;&amp;</span> <span class="nx">attackType</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">RDPBruteForce</span><span class="dl">"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">è¿™æ˜¯å†…éƒ¨ IPï¼Œç›´æ¥ä¿®æ”¹ç›®æ ‡ä¸»æœºå®‰å…¨ç»„è¿›è¡Œéš”ç¦»ã€‚</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">ec2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">findEC2</span><span class="p">(</span><span class="nx">sourceIp</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ec2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">banInnerEc2</span><span class="p">(</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">InstanceId</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">ex</span><span class="p">){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">è¿™æ˜¯å¤–éƒ¨ IPï¼Œå»ºè®®è°ƒç”¨ ç½‘ç»œé˜²ç«å¢™ APIï¼ˆå¦‚ fortnetï¼‰è¿›è¡Œç½‘ç»œé˜»æ–­ã€‚</span><span class="dl">"</span><span class="p">);</span>
    
    <span class="c1">// await banExternalIp(sourceIp);</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">statusCode</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="na">body</span><span class="p">:</span> <span class="dl">"</span><span class="s2">OK</span><span class="dl">"</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// åˆ¤æ–­æ˜¯å¦æ˜¯å†…éƒ¨ IP</span>
<span class="kd">function</span> <span class="nx">checkInnerIp</span><span class="p">(</span><span class="nx">ipAddress</span><span class="p">){</span>
  <span class="kd">const</span> <span class="nx">cidrLen</span> <span class="o">=</span> <span class="nx">innerCidrs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">cidrLen</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">checkIpInCidr</span><span class="p">(</span><span class="nx">innerCidrs</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">ipAddress</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">checkIpInCidr</span><span class="p">(</span><span class="nx">cidr</span><span class="p">,</span> <span class="nx">ipAddress</span><span class="p">){</span>
  <span class="kd">const</span> <span class="nx">ipInt</span> <span class="o">=</span> <span class="nx">ipToInt</span><span class="p">(</span><span class="nx">ipAddress</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">parseCIDR</span><span class="p">(</span><span class="nx">cidr</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ipInt</span> <span class="o">&gt;=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">start</span> <span class="o">&amp;&amp;</span> <span class="nx">ipInt</span><span class="o">&lt;=</span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">){</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">ipToInt</span><span class="p">(</span><span class="nx">ip</span><span class="p">){</span>
  <span class="kd">const</span> <span class="nx">subnet</span> <span class="o">=</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">.</span><span class="dl">'</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nb">Number</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">subnet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">subnet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">subnet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="nx">subnet</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">parseCIDR</span><span class="p">(</span><span class="nx">cidr</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">subnetAddress</span><span class="p">,</span> <span class="nx">mask</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cidr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">maskBits</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">mask</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">subnetInt</span> <span class="o">=</span> <span class="nx">ipToInt</span><span class="p">(</span><span class="nx">subnetAddress</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">subnetMaskInt</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="nx">maskBits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="nx">maskBits</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">subnetInt</span> <span class="o">&amp;</span> <span class="nx">subnetMaskInt</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="nx">maskBits</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">{</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span> <span class="p">};</span>
<span class="p">}</span>

<span class="c1">//é€šè¿‡ ip å¯»æ‰¾ EC2 å®ä¾‹</span>
<span class="kd">function</span> <span class="nx">findEC2</span><span class="p">(</span><span class="nx">privateIpAddress</span><span class="p">){</span>
  <span class="kd">const</span> <span class="nx">ec2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">EC2</span><span class="p">({</span> <span class="nx">region</span><span class="p">,</span> <span class="na">apiVersion</span><span class="p">:</span> <span class="dl">'</span><span class="s1">2016-11-15</span><span class="dl">'</span> <span class="p">});</span>
  <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">Filters</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">Name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">private-ip-address</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">Values</span><span class="p">:</span> <span class="p">[</span><span class="nx">privateIpAddress</span><span class="p">],</span>
      <span class="p">},</span>
    <span class="p">],</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">ec2</span><span class="p">.</span><span class="nx">describeInstances</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span> 
        <span class="kd">const</span> <span class="nx">instances</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">Reservations</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">reservation</span> <span class="o">=&gt;</span> <span class="nx">reservation</span><span class="p">.</span><span class="nx">Instances</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">instances</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">resolve</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="nx">resolve</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> 
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// å°ç¦ VPC å†… EC2</span>
<span class="kd">function</span> <span class="nx">banInnerEc2</span><span class="p">(</span><span class="nx">instanceId</span><span class="p">){</span>
  <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">InstanceId</span><span class="p">:</span> <span class="nx">instanceId</span><span class="p">,</span>
    <span class="na">Groups</span><span class="p">:</span> <span class="p">[</span><span class="nx">forbiddenSgId</span><span class="p">]</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="nx">ec2</span><span class="p">.</span><span class="nx">modifyInstanceAttribute</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span>
<span class="p">}</span>


<span class="k">async</span> <span class="kd">function</span> <span class="nx">banExternalIp</span><span class="p">(</span><span class="nx">ip</span><span class="p">){</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">vpcId</span> <span class="k">of</span> <span class="nx">protectedVpcIds</span><span class="p">){</span>
    <span class="k">await</span> <span class="nx">banExternalIpInVpc</span><span class="p">(</span><span class="nx">vpcId</span><span class="p">,</span> <span class="nx">ip</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// TODO: ç»‘å®šå­ç½‘ã€‚</span>
<span class="c1">// éœ€è¦æ³¨æ„ï¼šå¤š NACL ç­–ç•¥éœ€è¦ç¡®è®¤å…¶ä¼˜å…ˆé¡ºåºï¼Œé€šå¸¸ä¿®æ”¹ NACL ä¼šæœ‰ç½‘ç»œé£é™©ï¼Œå®é™…ç¯å¢ƒä¸­å»ºè®®é€šè¿‡å¤–éƒ¨é˜²ç«å¢™è¿›è¡Œå°ç¦ã€‚</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">banExternalIpInVpc</span><span class="p">(</span><span class="nx">vpcId</span><span class="p">,</span> <span class="nx">ip</span><span class="p">){</span>
  <span class="kd">const</span> <span class="nx">aclParams</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">VpcId</span><span class="p">:</span> <span class="nx">vpcId</span>
  <span class="p">};</span>
  
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ec2</span><span class="p">.</span><span class="nx">createNetworkAcl</span><span class="p">(</span><span class="nx">aclParams</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">aclId</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">NetworkAcl</span><span class="p">.</span><span class="nx">NetworkAclId</span><span class="p">;</span>
  
  <span class="kd">const</span> <span class="nx">allowAllInRuleParams</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">NetworkAclId</span><span class="p">:</span> <span class="nx">aclId</span><span class="p">,</span>
    <span class="na">RuleNumber</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="na">Protocol</span><span class="p">:</span> <span class="dl">'</span><span class="s1">-1</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">RuleAction</span><span class="p">:</span> <span class="dl">'</span><span class="s1">allow</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">Egress</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">CidrBlock</span><span class="p">:</span> <span class="s2">`0.0.0.0/0`</span>
  <span class="p">};</span>
  <span class="kd">const</span> <span class="nx">allowAllOutRuleParams</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">NetworkAclId</span><span class="p">:</span> <span class="nx">aclId</span><span class="p">,</span>
    <span class="na">RuleNumber</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="na">Protocol</span><span class="p">:</span> <span class="dl">'</span><span class="s1">-1</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">RuleAction</span><span class="p">:</span> <span class="dl">'</span><span class="s1">allow</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">Egress</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">CidrBlock</span><span class="p">:</span> <span class="s2">`0.0.0.0/0`</span>
  <span class="p">};</span>
  
  <span class="kd">const</span> <span class="nx">denyRuleParams</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">NetworkAclId</span><span class="p">:</span> <span class="nx">aclId</span><span class="p">,</span>
    <span class="na">RuleNumber</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">Protocol</span><span class="p">:</span> <span class="dl">'</span><span class="s1">-1</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">RuleAction</span><span class="p">:</span> <span class="dl">'</span><span class="s1">deny</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">Egress</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">CidrBlock</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">ip</span><span class="p">}</span><span class="s2">/32`</span>
  <span class="p">};</span>
  
  <span class="k">await</span> <span class="nx">ec2</span><span class="p">.</span><span class="nx">createNetworkAclEntry</span><span class="p">(</span><span class="nx">allowAllInRuleParams</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span>
  <span class="k">await</span> <span class="nx">ec2</span><span class="p">.</span><span class="nx">createNetworkAclEntry</span><span class="p">(</span><span class="nx">allowAllOutRuleParams</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span>
  <span class="k">await</span> <span class="nx">ec2</span><span class="p">.</span><span class="nx">createNetworkAclEntry</span><span class="p">(</span><span class="nx">denyRuleParams</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span>
  
<span class="p">}</span>

</code></pre></div></div>

<p>ç¨‹åºæ€è·¯ï¼š</p>

<ul>
  <li>ä»æ”»å‡»äº‹ä»¶ä¸­å¾—åˆ°æ”»å‡»æºçš„ IPï¼Œåˆ¤æ–­ IP æ˜¯å¦æ˜¯å†…ç½‘IPã€‚</li>
  <li>å¦‚æœæ˜¯ å†…ç½‘ IPï¼Œé‚£ä¹ˆåˆ™æ‰¾åˆ°å½“å‰ IP å¯¹åº”çš„ä¸»æœºï¼Œå¹¶æŠŠæ­¤ä¸»æœºåŠ å…¥ä¸€ä¸ªç‰¹æ®Šçš„å®‰å…¨ç»„ã€‚</li>
  <li>å¦‚æœæ˜¯å¤–ç½‘ IPï¼Œåˆ™è°ƒç”¨ç½‘ç»œé˜²ç«å¢™è¿›è¡Œå°ç¦ï¼ˆæˆ–è€…é€šè¿‡è®¾ç½® NACL è¿›è¡Œå°ç¦ï¼‰ã€‚</li>
  <li>æ­¤ä¾‹å­ä»…é€‚ç”¨ IPv4ã€‚</li>
</ul>

<p>å‡è®¾ä»¥ä¸Šå‡½æ•°å‘½åä¸º <code class="language-plaintext highlighter-rouge">LockTarget</code>ã€‚</p>

<p>ç°åœ¨æ¨¡æ‹Ÿä¸€ä¸ª GuardDuty çš„æ”»å‡»äº‹ä»¶ï¼Œæˆ‘æµ‹è¯•çš„ GuardDuty çš„äº‹ä»¶æ ¼å¼å¦‚ä¸‹ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"12345678-1234-1234-1234-123456789012"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"detail-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GuardDuty Finding"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"aws.guardduty"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"account"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123456789012"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-02-25T17:01:23Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="nl">"resources"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AwsEc2Instance"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"i-01234567890abcdef"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"detail"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"schemaVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3.3"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"accountId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123456789012"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"partition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"aws"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cn-northwest-1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EXAMPLE-GUARDDUTY-FINDING-ID"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"arn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:guardduty:us-west-2:123456789012:detector/EXAMPLE_DETECTOR_ID/finding/EXAMPLE-GUARDDUTY-FINDING-ID"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UnauthorizedAccess:EC2/RDPBruteForce"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-02-25T16:59:33.185Z"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-02-25T16:59:33.185Z"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"severity"</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w">
    </span><span class="nl">"confidence"</span><span class="p">:</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EC2 Instance 123.45.67.89 is involved in RDP brute force attack"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"...."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"resourceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Instance"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"instanceDetails"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"instanceId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"i-01234567890abcdef"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"instanceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t2.micro"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"launchTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-02-25T16:46:47Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"platform"</span><span class="p">:</span><span class="w"> </span><span class="s2">"windows"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"networkInterfaces"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"ipv4Addresses"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"123.45.67.89"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"networkInterfaceId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eni-01234567890abcdef"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"subnetId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"subnet-01234567890abcdef"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"vpcId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vpc-01234567890abcdef"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"serviceName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"guardduty"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"detectorId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EXAMPLE_DETECTOR_ID"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"eventFirstSeen"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-02-25T16:46:47Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"eventLastSeen"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-02-25T16:46:47Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"archived"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"additionalInfo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"ThreatListName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Example Threat List"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"DetectTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-02-25T16:46:47Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"DetectContentType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/octet-stream"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"AttackType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDP brute force"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"network"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"IN"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDP"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"sourceIpV4"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192.31.8.115"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>ä¸Šè¿°ä»£ç å‡ºè‡ªäº ChatGPTï¼Œå’Œå®é™…çš„ GuardDuty äº‹ä»¶å¯èƒ½ä¼šç¨æœ‰å‡ºå…¥ï¼Œè¯·ä½¿ç”¨çœŸå®çš„ JSON ç»“æ„è·å–æ”»å‡»æº IPã€‚</li>
</ul>

<h2 id="é…ç½®">é…ç½®</h2>

<p>ç°åœ¨åœ¨ EventBridge ä¸­åˆ›å»ºä¸€ä¸ªè§„åˆ™:</p>

<ul>
  <li>é€‰æ‹©å…·æœ‰äº‹ä»¶æ¨¡å¼çš„è§„åˆ™</li>
  <li>äº‹ä»¶æ¨¡å¼é€‰æ‹© GuardDuty, GuardDuty Findings</li>
  <li>ç›®æ ‡é€‰æ‹©ï¼šLambda å‡½æ•°, LockTarget</li>
</ul>

<p>é€šè¿‡ä»¥ä¸Šçš„ä»£ç å’Œè®¾ç½®ï¼Œæˆ‘ä»¬å³å¯å°†æ”»å‡»æºç›´æ¥éš”ç¦»ã€‚</p>]]></content><author><name>å•¤é…’äº‘</name></author><category term="aws" /><summary type="html"><![CDATA[åœ¨é’ˆå¯¹ AWS çš„ç½‘ç»œæ”»å‡»è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ç±»æ”»å‡»æ˜¯æš´åŠ›ç ´è§£ root è´¦å·ï¼Œæ­¤ç±»æ”»å‡»ä¼šè¢« GuardDuty ç›‘æ§å¹¶è®°å½•åˆ°ã€‚å½“å‘ç”Ÿæ­¤ç±»æš´åŠ›ç ´è§£äº‹ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ Lambda æ¥å¯¹æ”»å‡»æºè¿›è¡ŒåŠæ—¶å°ç¦ã€‚]]></summary></entry><entry><title type="html">SharingSphere-Proxy å…¥é—¨</title><link href="https://youbug.cn/2023/02/shardingsphere-proxy-start.html" rel="alternate" type="text/html" title="SharingSphere-Proxy å…¥é—¨" /><published>2023-02-17T03:27:44+00:00</published><updated>2023-02-17T03:27:44+00:00</updated><id>https://youbug.cn/2023/02/shardingsphere-proxy-start</id><content type="html" xml:base="https://youbug.cn/2023/02/shardingsphere-proxy-start.html"><![CDATA[<p>äº‘å‚å•†æä¾›çš„æ•°æ®åº“è¯»å†™åˆ†ç¦»ï¼Œé€šå¸¸ä¼šæä¾›å¤šä¸ª url/endpoint ä¾›å¼€å‘è€…ä½¿ç”¨ï¼Œä¸€èˆ¬éœ€è¦åº”ç”¨è‡ªå·±å»åŒºåˆ†è¯»å†™åœºæ™¯è¿›è¡Œç¨‹åºæ”¹é€ ã€‚ç°åœ¨æœ‰äº†è¿™ç§æ•°æ®è®¿é—®çš„åˆ†å¸ƒå¼ä¸­é—´ä»¶ï¼Œè‡ªåŠ¨å¯¹ SQL è¯­å¥è¿›è¡Œæ£€æµ‹å’Œè·¯ç”±ã€‚æœ¬æ–‡ä½“éªŒäº†ä¸€ä¸‹ SharingSphere-Proxyï¼Œå¹¶è®°å½•äº†ä¸€ä¸‹é…ç½®å’ŒéªŒè¯è¿‡ç¨‹ã€‚</p>

<h2 id="é…ç½®">é…ç½®</h2>

<p>é¦–å…ˆæŠŠ SharingSphere-Proxy çš„é…ç½®æ‹·è´å‡ºæ¥ï¼Œç”¨å®˜æ–¹æ–‡æ¡£æä¾›çš„å‘½ä»¤å³å¯ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--name</span> tmp <span class="nt">--entrypoint</span><span class="o">=</span>bash apache/shardingsphere-proxy
docker <span class="nb">cp </span>tmp:/opt/shardingsphere-proxy/conf /host/path/to/conf
docker <span class="nb">rm </span>tmp
</code></pre></div></div>

<ul>
  <li>/host/path/to/conf ä¿®æ”¹æˆä½ è‡ªå·±çš„ç›®å½•ã€‚</li>
</ul>

<p>å¯¹äºç®€å•çš„è¯»å†™åˆ†ç¦»ï¼Œéœ€è¦ 2 ä¸ªé…ç½®æ–‡ä»¶ï¼Œå†…å®¹åˆ†åˆ«å¦‚ä¸‹ï¼š</p>

<p>server.yaml</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">authority</span><span class="pi">:</span>
  <span class="na">users</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">user</span><span class="pi">:</span> <span class="s">admin</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s">YourPassword</span>
  <span class="na">privilege</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">ALL_PERMITTED</span>

<span class="na">transaction</span><span class="pi">:</span>
  <span class="na">defaultType</span><span class="pi">:</span> <span class="s">XA</span>
  <span class="na">providerType</span><span class="pi">:</span> <span class="s">Atomikos</span>

<span class="na">sqlParser</span><span class="pi">:</span>
  <span class="na">sqlCommentParseEnabled</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">sqlStatementCache</span><span class="pi">:</span>
    <span class="na">initialCapacity</span><span class="pi">:</span> <span class="m">2000</span>
    <span class="na">maximumSize</span><span class="pi">:</span> <span class="m">65535</span>
  <span class="na">parseTreeCache</span><span class="pi">:</span>
    <span class="na">initialCapacity</span><span class="pi">:</span> <span class="m">128</span>
    <span class="na">maximumSize</span><span class="pi">:</span> <span class="m">1024</span>

<span class="na">props</span><span class="pi">:</span>
  <span class="na">max-connections-size-per-query</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">sql-show</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<ul>
  <li>è¿™é‡Œçš„ç”¨æˆ·é…ç½®å³æ˜¯ SharingSphere-Proxy æ¨¡æ‹Ÿçš„ MySQL å¼•æ“è´¦å·</li>
</ul>

<p>config-readwrite-splitting.yaml</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">databaseName</span><span class="pi">:</span> <span class="s">dbname</span>

<span class="na">dataSources</span><span class="pi">:</span>
  <span class="na">write_ds</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:mysql://xxxxxxxxx.rds.cn-northwest-1.amazonaws.com.cn:3306/dbname</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">admin</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">thisDBPwd</span>
    <span class="na">connectionTimeoutMilliseconds</span><span class="pi">:</span> <span class="m">30000</span>
    <span class="na">idleTimeoutMilliseconds</span><span class="pi">:</span> <span class="m">60000</span>
    <span class="na">maxLifetimeMilliseconds</span><span class="pi">:</span> <span class="m">1800000</span>
    <span class="na">maxPoolSize</span><span class="pi">:</span> <span class="m">50</span>
    <span class="na">minPoolSize</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">read_ds_0</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:mysql://xxxxxxxxxt.cluster-ro-xxxx.rds.cn-northwest-1.amazonaws.com.cn:3306/dbname</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">admin</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">thisDBPwd</span>
    <span class="na">connectionTimeoutMilliseconds</span><span class="pi">:</span> <span class="m">30000</span>
    <span class="na">idleTimeoutMilliseconds</span><span class="pi">:</span> <span class="m">60000</span>
    <span class="na">maxLifetimeMilliseconds</span><span class="pi">:</span> <span class="m">1800000</span>
    <span class="na">maxPoolSize</span><span class="pi">:</span> <span class="m">50</span>
    <span class="na">minPoolSize</span><span class="pi">:</span> <span class="m">1</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="kt">!READWRITE_SPLITTING</span>
    <span class="na">dataSources</span><span class="pi">:</span>
      <span class="na">readwrite_ds</span><span class="pi">:</span>
        <span class="na">staticStrategy</span><span class="pi">:</span>
          <span class="na">writeDataSourceName</span><span class="pi">:</span> <span class="s">write_ds</span>
          <span class="na">readDataSourceNames</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">read_ds_0</span>
        <span class="na">loadBalancerName</span><span class="pi">:</span> <span class="s">random</span>
    <span class="na">loadBalancers</span><span class="pi">:</span>
      <span class="na">random</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">RANDOM</span>

</code></pre></div></div>

<ul>
  <li>dbname url å¯†ç è¿™äº›éœ€è¦ä¿®æ”¹æˆä½ è‡ªå·±çš„ã€‚</li>
</ul>

<p>ä¸Šè¿°é…ç½®çš„å…·ä½“æ„æ€å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚</p>

<h2 id="å¯åŠ¨å¹¶éªŒè¯">å¯åŠ¨å¹¶éªŒè¯</h2>

<p>å¦‚æœæºæ•°æ®ä½¿ç”¨ MySQL å¼•æ“ï¼Œéœ€è¦ä¸‹è½½ MySQL çš„ JDBC çš„é©±åŠ¨åŒ…åˆ° ext-lib ä¸­ï¼Œå¦‚ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.47/mysql-connector-java-5.1.47.jar
</code></pre></div></div>

<p>ä½¿ç”¨ docker å‘½ä»¤å¯åŠ¨ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="nv">$PWD</span>/conf:/opt/shardingsphere-proxy/conf <span class="se">\</span>
    <span class="nt">-v</span> <span class="nv">$PWD</span>/ext-lib:/opt/shardingsphere-proxy/ext-lib <span class="se">\</span>
    <span class="nt">-e</span> <span class="nv">PORT</span><span class="o">=</span>3308 <span class="nt">-p</span> 3306:3308 apache/shardingsphere-proxy
</code></pre></div></div>

<ul>
  <li>ä¸Šè¿°å‘½ä»¤å¯åŠ¨äº† SharingSphere-Proxyï¼Œå¹¶æŠŠç«¯å£æ˜ å°„åˆ°äº†ä¸»æœºçš„ 3306 ç«¯å£ã€‚</li>
</ul>

<p>å¯åŠ¨ä¹‹åï¼Œåˆ™å¯ä»¥åœ¨å®¢æˆ·ç«¯é€æ˜è®¿é—® SharingSphere-Proxy äº†ã€‚</p>

<p>ä¸‹é¢ä½¿ç”¨ MySQL çš„æ ‡å‡†å®¢æˆ·ç«¯è¿›è¡Œæµ‹è¯•ï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-h</span> 172.31.14.22 <span class="nt">-uadmin</span> <span class="nt">-p</span>
</code></pre></div></div>

<p>è¾“å…¥å¯†ç åï¼Œå¯ä»¥ç›´è¾¾ MySQL:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@ip-172-31-8-115:~<span class="nv">$ </span>mysql <span class="nt">-h</span> 172.31.14.22 <span class="nt">-uadmin</span> <span class="nt">-p</span>
Enter password:
Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span><span class="nb">.</span>
Your MySQL connection <span class="nb">id </span>is 2
Server version: 5.7.22-ShardingSphere-Proxy 5.3.1 MySQL Community Server <span class="o">(</span>GPL<span class="o">)</span>

Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2023, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span class="s1">'help;'</span> or <span class="s1">'\h'</span> <span class="k">for </span>help. Type <span class="s1">'\c'</span> to clear the current input statement.

mysql&gt;
</code></pre></div></div>

<p>åˆ›å»ºæ•°æ®åº“ï¼Œuse ä¸€ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªè¡¨ã€‚</p>

<pre><code class="language-SQL">CREATE TABLE student 
( 
  id int NOT NULL AUTO_INCREMENT, 
  t varchar(50) NULL, 
  PRIMARY KEY (id) 
);
</code></pre>

<p>æµ‹è¯•ä¸€ä¸‹å¦‚ä¸‹çš„ SQL</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">student</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'1'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'2'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'3'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'4'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'5'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'6'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'7'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'8'</span><span class="p">);</span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">student</span><span class="p">;</span>
</code></pre></div></div>

<p>æœŸæœ›çš„ç»“æœæ˜¯ï¼Œä»–èƒ½æ­£ç¡®è·¯ç”±ã€‚SharingSphere-Proxy çš„ log æ˜¾ç¤ºå¦‚ä¸‹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="o">[</span>INFO <span class="o">]</span> 2023-02-17 03:52:50.643 <span class="o">[</span>Connection-2-ThreadExecutor] ShardingSphere-SQL - Logic SQL: INSERT INTO student <span class="o">(</span>t<span class="o">)</span> values <span class="o">(</span><span class="s1">'1'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'2'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'3'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'4'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'5'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'6'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'7'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'8'</span><span class="o">)</span>
<span class="o">[</span>INFO <span class="o">]</span> 2023-02-17 03:52:50.644 <span class="o">[</span>Connection-2-ThreadExecutor] ShardingSphere-SQL - Actual SQL: write_ds ::: INSERT INTO student <span class="o">(</span>t<span class="o">)</span> values <span class="o">(</span><span class="s1">'1'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'2'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'3'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'4'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'5'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'6'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'7'</span><span class="o">)</span>, <span class="o">(</span><span class="s1">'8'</span><span class="o">)</span>
<span class="o">[</span>INFO <span class="o">]</span> 2023-02-17 03:52:50.685 <span class="o">[</span>Connection-2-ThreadExecutor] ShardingSphere-SQL - Logic SQL: SELECT <span class="k">*</span> from student
<span class="o">[</span>INFO <span class="o">]</span> 2023-02-17 03:52:50.685 <span class="o">[</span>Connection-2-ThreadExecutor] ShardingSphere-SQL - Actual SQL: read_ds_0 ::: SELECT <span class="k">*</span> from student
...
</code></pre></div></div>

<p>ç”±äºåŒæ­¥æ•°æ®éœ€è¦ä¸€äº›æ—¶é—´ï¼Œæ‰€ä»¥ä¸Šè¿°æµ‹è¯•çš„ SQL æŠŠ INSERT å’Œ SELECT æ“ä½œå†™åœ¨äº†ä¸€å¥è¯é‡Œã€‚
å¯ä»¥çœ‹åˆ°ï¼Œæ’å…¥æˆåŠŸä¹‹åï¼Œå¹¶ä¸æ€»æ˜¯èƒ½ç›´æ¥æ‹¿åˆ°åˆšåˆšæ’å…¥çš„ç»“æœï¼Œè¿™ä¸ªä¹Ÿè¯å®äº†æŸ¥è¯¢æ“ä½œçš„ç¡®è·¯ç”±åˆ°äº† ro çš„ endpoint ä¸Šäº†ã€‚</p>

<p>å†™å®Œæ”¶å·¥ï¼</p>

<hr />

<p>å‚è€ƒï¼š</p>

<p><a href="https://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-proxy/startup/docker/">https://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-proxy/startup/docker/</a></p>

<p><a href="https://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-proxy/yaml-config/">https://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-proxy/yaml-config/</a></p>

<p><a href="https://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-jdbc/yaml-config/rules/readwrite-splitting/">https://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-jdbc/yaml-config/rules/readwrite-splitting/</a></p>]]></content><author><name>å•¤é…’äº‘</name></author><category term="data" /><category term="SharingSphere" /><summary type="html"><![CDATA[äº‘å‚å•†æä¾›çš„æ•°æ®åº“è¯»å†™åˆ†ç¦»ï¼Œé€šå¸¸ä¼šæä¾›å¤šä¸ª url/endpoint ä¾›å¼€å‘è€…ä½¿ç”¨ï¼Œä¸€èˆ¬éœ€è¦åº”ç”¨è‡ªå·±å»åŒºåˆ†è¯»å†™åœºæ™¯è¿›è¡Œç¨‹åºæ”¹é€ ã€‚ç°åœ¨æœ‰äº†è¿™ç§æ•°æ®è®¿é—®çš„åˆ†å¸ƒå¼ä¸­é—´ä»¶ï¼Œè‡ªåŠ¨å¯¹ SQL è¯­å¥è¿›è¡Œæ£€æµ‹å’Œè·¯ç”±ã€‚æœ¬æ–‡ä½“éªŒäº†ä¸€ä¸‹ SharingSphere-Proxyï¼Œå¹¶è®°å½•äº†ä¸€ä¸‹é…ç½®å’ŒéªŒè¯è¿‡ç¨‹ã€‚]]></summary></entry><entry><title type="html">ä¼ä¸šå¾®ä¿¡é›†æˆ ChatGPT å¼€å‘ç¬”è®°</title><link href="https://youbug.cn/2023/02/wecom-chatgpt.html" rel="alternate" type="text/html" title="ä¼ä¸šå¾®ä¿¡é›†æˆ ChatGPT å¼€å‘ç¬”è®°" /><published>2023-02-12T10:09:44+00:00</published><updated>2023-02-12T10:09:44+00:00</updated><id>https://youbug.cn/2023/02/wecom-chatgpt</id><content type="html" xml:base="https://youbug.cn/2023/02/wecom-chatgpt.html"><![CDATA[<p>åŸæ¥æ˜¯æƒ³ä½¿ç”¨ä¼ä¸šå¾®ä¿¡çš„æœºå™¨äººæ¥é›†æˆ ChatGPTï¼Œä½†â€¦ è¿™ç©æ„ä¸æ”¯æŒæ”¶æ¶ˆæ¯ï¼Œåªèƒ½æ¨é€æ¶ˆæ¯ï¼Œæ‰€ä»¥åªèƒ½å¦å¯»ä»–æ³•ã€‚</p>

<h2 id="æ€è·¯">æ€è·¯</h2>

<p>å¯ä»¥æ”¶æ¶ˆæ¯çš„é€”å¾„ï¼šä¼ä¸šåº”ç”¨ã€‚</p>

<p>å¯ä»¥å‘æ¶ˆæ¯çš„ï¼šä¼ä¸šåº”ç”¨çš„æ¨é€ï¼Œç¾¤æœºå™¨äººã€‚</p>

<h2 id="è¿‡ç¨‹åŠé‡ç‚¹ä»£ç ">è¿‡ç¨‹åŠé‡ç‚¹ä»£ç </h2>

<p>æ­¥éª¤å¦‚ä¸‹ï¼š</p>

<h3 id="æ–°å»ºä¼ä¸šåº”ç”¨">æ–°å»ºä¼ä¸šåº”ç”¨</h3>

<p>é™åˆ¶æ¡ä»¶ï¼šå¿…é¡»æ˜¯è®¤è¯çš„ä¼ä¸šï¼Œæœ‰è®¤è¯è¿‡çš„ç›¸å…³åŸŸåã€‚</p>

<p>æ–°å»ºä¸€ä¸ªä¼ä¸šå¾®ä¿¡çš„ä¼ä¸šå†…éƒ¨åº”ç”¨ï¼Œå¹¶å¯ç”¨æ¥æ”¶æ¶ˆæ¯çš„ API åŠŸèƒ½ã€‚</p>

<p>ç¬¬ä¸€æ­¥å¿…é¡»æœ‰ä¸€ä¸ªè®¤è¯çš„è¿‡ç¨‹ï¼Œéœ€è¦éªŒè¯æœ‰æ•ˆæ€§ï¼Œä½ å¿…é¡»æŠŠä»–çš„ç»“æœè§£å¯†å‡ºæ¥å‘ç»™ä»–ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ä»–å‘é€ GET è¯·æ±‚åˆ°ä½ é¢„å®šçš„ URL çš„ã€‚</p>

<p>ç›¸å…³çš„éªŒè¯ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">qiwei</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">//è®¡ç®—ç­¾åï¼Œå¦‚æœè®¡ç®—ç»“æœå’Œä»–ç»™çš„ç»“æœä¸€è‡´å°±æ˜¯æœ‰æ•ˆçš„</span>
  <span class="na">computeSign</span><span class="p">:</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">,</span> <span class="nx">msg_encrypt</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">tmpArr</span> <span class="o">=</span> <span class="p">[</span><span class="nx">token</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">,</span> <span class="nx">msg_encrypt</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">sha1</span><span class="p">(</span><span class="nx">tmpArr</span><span class="p">.</span><span class="nx">sort</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="dl">''</span><span class="p">));</span>
  <span class="p">},</span>
  <span class="na">decode</span><span class="p">:</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">encodingAESKey</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">aesKey</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">encodingAESKey</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">=</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">aesCipher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createDecipheriv</span><span class="p">(</span><span class="dl">"</span><span class="s2">aes-256-cbc</span><span class="dl">"</span><span class="p">,</span> <span class="nx">aesKey</span><span class="p">,</span> <span class="nx">aesKey</span><span class="p">.</span><span class="nx">subarray</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
    <span class="nx">aesCipher</span><span class="p">.</span><span class="nx">setAutoPadding</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">decipheredBuff</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">aesCipher</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">),</span> <span class="nx">aesCipher</span><span class="p">.</span><span class="nx">final</span><span class="p">()]);</span>
    <span class="nx">decipheredBuff</span> <span class="o">=</span> <span class="nx">PKCS7Decoder</span><span class="p">(</span><span class="nx">decipheredBuff</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">len_netOrder_corpid</span> <span class="o">=</span> <span class="nx">decipheredBuff</span><span class="p">.</span><span class="nx">subarray</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">msg_len</span> <span class="o">=</span> <span class="nx">len_netOrder_corpid</span><span class="p">.</span><span class="nx">subarray</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">).</span><span class="nx">readUInt32BE</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">len_netOrder_corpid</span><span class="p">.</span><span class="nx">subarray</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">msg_len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span> 
  <span class="p">},</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">sha1</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">md5sum</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="dl">'</span><span class="s1">sha1</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">md5sum</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">ciphertext</span> <span class="o">=</span> <span class="nx">md5sum</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="dl">'</span><span class="s1">hex</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">ciphertext</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">PKCS7Decoder</span><span class="p">(</span><span class="nx">buff</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">pad</span> <span class="o">=</span> <span class="nx">buff</span><span class="p">[</span><span class="nx">buff</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">pad</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">pad</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">buff</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">buff</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">pad</span><span class="p">);</span>
<span class="p">}</span>


<span class="kd">class</span> <span class="nx">QiWeiController</span> <span class="kd">extends</span> <span class="nx">Controller</span> <span class="p">{</span>

  <span class="k">async</span> <span class="nx">verifySignature</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">app</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">msg_signature</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">,</span> <span class="nx">echostr</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">QIWEI_TOKEN</span><span class="p">,</span> <span class="nx">QIWEI_ENCODING_AES_KEY</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">config</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">mySign</span> <span class="o">=</span> <span class="nx">computeSign</span><span class="p">(</span><span class="nx">QIWEI_TOKEN</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">,</span> <span class="nx">echostr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mySign</span> <span class="o">!=</span> <span class="nx">msg_signature</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Invalid signature.</span><span class="dl">"</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">decode</span><span class="p">(</span><span class="nx">echostr</span><span class="p">,</span> <span class="nx">QIWEI_ENCODING_AES_KEY</span><span class="p">);</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>è¯·æ³¨æ„ï¼Œä¸Šè¿°ä»£ç æœ‰å¯èƒ½å¹¶ä¸åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚</li>
</ul>

<h3 id="æ¥æ”¶æ¶ˆæ¯">æ¥æ”¶æ¶ˆæ¯</h3>

<p>è¿™ä¸ªåº”ç”¨åˆ›å»ºäº†ä¹‹åï¼Œåœ¨å®¢æˆ·ç«¯çš„å·¥ä½œå°èƒ½çœ‹åˆ°è¿™ä¸ªåº”ç”¨ï¼Œä½ å¯ä»¥å’Œè¿™ä¸ªåº”ç”¨èŠå¤©ï¼Œå‘ç»™è¿™ä¸ªåº”ç”¨çš„æ¶ˆæ¯éƒ½ä¼šè¢«æ¥å—ã€‚å‘é€çš„ä¿¡æ¯ä¼šè¢« Post åˆ°ä½ å®šä¹‰çš„ URLã€‚</p>

<p>æ¥æ”¶ä¿¡æ¯ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">qiwei</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">decodeIncomingMsg</span><span class="p">:</span> <span class="p">(</span><span class="nx">encMsg</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">ptToUserName</span> <span class="o">=</span> <span class="sr">/&lt;ToUserName&gt;&lt;!</span><span class="se">\[</span><span class="sr">CDATA</span><span class="se">\[(</span><span class="sr">.*</span><span class="se">?)\]\]</span><span class="sr">&gt;&lt;</span><span class="se">\/</span><span class="sr">ToUserName&gt;/</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">ptFromUserName</span> <span class="o">=</span> <span class="sr">/&lt;FromUserName&gt;&lt;!</span><span class="se">\[</span><span class="sr">CDATA</span><span class="se">\[(</span><span class="sr">.*</span><span class="se">?)\]\]</span><span class="sr">&gt;&lt;</span><span class="se">\/</span><span class="sr">FromUserName&gt;/</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">ptContent</span> <span class="o">=</span> <span class="sr">/&lt;Content&gt;&lt;!</span><span class="se">\[</span><span class="sr">CDATA</span><span class="se">\[(</span><span class="sr">.*</span><span class="se">?)\]\]</span><span class="sr">&gt;&lt;</span><span class="se">\/</span><span class="sr">Content&gt;/</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">realMsg</span> <span class="o">=</span> <span class="nx">qiwei</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">encMsg</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">resMsg</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">ToUserName</span><span class="p">:</span> <span class="nx">realMsg</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">ptToUserName</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
      <span class="na">FromUserName</span><span class="p">:</span> <span class="nx">realMsg</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">ptFromUserName</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
      <span class="na">Content</span><span class="p">:</span> <span class="nx">realMsg</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">ptContent</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">};</span>
    <span class="c1">//è¿™é‡Œå¯ä»¥ä¿®æ”¹åˆ° MQ ä¸­ï¼Œå¹¶æœ€ç»ˆè½ç›˜</span>
    <span class="nx">qiwei</span><span class="p">.</span><span class="nx">incomings</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">resMsg</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">resMsg</span><span class="p">;</span>
  <span class="p">},</span>
<span class="p">}</span>


<span class="kd">class</span> <span class="nx">QiWeiController</span> <span class="kd">extends</span> <span class="nx">Controller</span> <span class="p">{</span>

  <span class="k">async</span> <span class="nx">incoming</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">app</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">msg_signature</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">nonce</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">QIWEI_TOKEN</span><span class="p">,</span> <span class="nx">QIWEI_ENCODING_AES_KEY</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">config</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">ptEncMsg</span> <span class="o">=</span> <span class="sr">/&lt;Encrypt&gt;&lt;!</span><span class="se">\[</span><span class="sr">CDATA</span><span class="se">\[(</span><span class="sr">.*</span><span class="se">?)\]\]</span><span class="sr">&gt;&lt;</span><span class="se">\/</span><span class="sr">Encrypt&gt;/</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">ptEncMsg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">found</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">mySign</span> <span class="o">=</span> <span class="nx">computeSign</span><span class="p">(</span><span class="nx">QIWEI_TOKEN</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">nonce</span><span class="p">,</span> <span class="nx">found</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mySign</span> <span class="o">==</span> <span class="nx">msg_signature</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">decodeIncomingMsg</span><span class="p">(</span><span class="nx">found</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">QIWEI_ENCODING_AES_KEY</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">OK</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>æ¥æ”¶åˆ°ä¿¡æ¯ä¹‹åï¼Œå°†ä¿¡æ¯è§£ç å‡ºæ¥ï¼Œæ”¾åˆ°ä¸€ä¸ªæ•°ç»„(é˜Ÿåˆ—) ä¸­ï¼Œä¾›å…¶ä»– deamon æ–¹æ³•è°ƒç”¨ã€‚</li>
</ul>

<h3 id="è¯·æ±‚-chatgpt">è¯·æ±‚ ChatGPT</h3>

<p>ä½¿ç”¨äº† chatpgt è¿™ä¸ª npm åŒ…ï¼Œè°ƒç”¨éå¸¸ç®€å•ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">const</span> <span class="nx">qiwei</span><span class="o">=</span><span class="p">{</span>

  <span class="na">chatdeamon</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">paimon</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">tarMsg</span> <span class="o">=</span> <span class="nx">qiwei</span><span class="p">.</span><span class="nx">incomings</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="c1">// tarMsg &amp;&amp; console.log(tarMsg);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">tarMsg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">conversationId</span> <span class="o">=</span> <span class="nx">tarMsg</span><span class="p">.</span><span class="nx">ToUserName</span><span class="p">;</span>
        <span class="kd">let</span> <span class="nx">chatOpts</span> <span class="o">=</span> <span class="p">{</span>
          <span class="na">timeoutMs</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
          <span class="nx">conversationId</span>
        <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">qiwei</span><span class="p">.</span><span class="nx">parentMessageId</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">chatOpts</span><span class="p">.</span><span class="nx">parentMessageId</span> <span class="o">=</span> <span class="nx">parentMessageId</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">è¾“å…¥:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">tarMsg</span><span class="p">.</span><span class="nx">Content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">å †ç§¯é‡:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">qiwei</span><span class="p">.</span><span class="nx">incomings</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">paimon</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">tarMsg</span><span class="p">.</span><span class="nx">Content</span><span class="p">,</span> <span class="nx">chatOpts</span><span class="p">);</span>
        <span class="nx">parentMessageId</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">æŠ•é€ç»“æœï¼š</span><span class="dl">"</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
        <span class="k">await</span> <span class="nx">qiwei</span><span class="p">.</span><span class="nx">sendToPerson</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">tarMsg</span><span class="p">.</span><span class="nx">FromUserName</span><span class="p">);</span>
        <span class="k">await</span> <span class="nx">qiwei</span><span class="p">.</span><span class="nx">paimonSendToRoom</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">tarMsg</span><span class="p">.</span><span class="nx">Content</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">tarMsg</span><span class="p">.</span><span class="nx">FromUserName</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">sleep</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>å†™äº†æ­»å¾ªç¯å¤„ç†æ¶ˆæ¯ï¼Œè¿™é‡Œ çš„ app æ˜¯ eggjs çš„ä¸Šä¸‹æ–‡çš„ï¼Œç”¨äºå–é…ç½®ã€‚</li>
  <li>ChatGPT çš„ API ç»å¸¸é™æµï¼Œè¿™é‡Œå¤„ç†æˆäº†åŒæ­¥è°ƒç”¨ï¼Œä¸€æ¡ä¸€æ¡å¾€ä¸‹è¿›è¡Œã€‚</li>
  <li>ä»£ç ä¸­ paimon æ˜¯ä¸€ä¸ª ChatGPT å®ä¾‹ã€‚</li>
</ul>

<h3 id="åˆ†å‘æ¶ˆæ¯">åˆ†å‘æ¶ˆæ¯</h3>

<p>ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°æ‹¿åˆ°ç»“æœååˆ†åˆ«åˆ†å‘åˆ°äº†ä¸ªäººå’Œæœºå™¨äººã€‚</p>

<p>å‘é€åˆ°ä¸ªäººå¯ä»¥åœ¨ç›´æ¥åœ¨å•èŠå¯¹è¯ä¸­çœ‹åˆ°ç»“æœï¼ŒåŒæ—¶å¯ä»¥è®©ä¼ä¸šå¾®ä¿¡æœºå™¨äººåˆ†å‘åˆ°ç¾¤é‡Œã€‚</p>

<p>åˆ†å‘åˆ°ä¸ªäººçš„ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">qiwei</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">getAccessToken</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">qiwei</span><span class="p">.</span><span class="nx">access_token</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="dl">"</span><span class="s2">access_token</span><span class="dl">"</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">qiwei</span><span class="p">.</span><span class="nx">access_token</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="dl">"</span><span class="s2">expire_time</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">expire_time</span> <span class="o">=</span> <span class="nx">qiwei</span><span class="p">.</span><span class="nx">access_token</span><span class="p">.</span><span class="nx">expire_time</span><span class="p">;</span>
      <span class="kd">const</span> <span class="nx">current</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">isExpire</span> <span class="o">=</span> <span class="nx">expire_time</span> <span class="o">&lt;</span> <span class="nx">current</span> <span class="p">?</span> <span class="kc">true</span> <span class="p">:</span> <span class="kc">false</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isExpire</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">qiwei</span><span class="p">.</span><span class="nx">access_token</span><span class="p">.</span><span class="nx">access_token</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nx">access_response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">curl</span><span class="p">(</span><span class="s2">`https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=</span><span class="p">${</span><span class="nx">app</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">QIWEI_CORP_ID</span><span class="p">}</span><span class="s2">&amp;corpsecret=</span><span class="p">${</span><span class="nx">app</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">QIWEI_APP_SECRET</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">dataType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">json</span><span class="dl">'</span>
    <span class="p">});</span>
    <span class="kd">let</span> <span class="p">{</span> <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="nx">access_token</span><span class="p">,</span> <span class="nx">expires_in</span>
    <span class="p">}</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">access_response</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">access_token</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">qiwei</span><span class="p">.</span><span class="nx">access_token</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">access_token</span><span class="p">,</span>
        <span class="na">expire_time</span><span class="p">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="nx">expires_in</span>
      <span class="p">};</span>
      <span class="k">return</span> <span class="nx">access_token</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`è·å– access_token å¤±è´¥`</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">access_response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">sendToPerson</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">access_token</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">qiwei</span><span class="p">.</span><span class="nx">getAccessToken</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=</span><span class="p">${</span><span class="nx">access_token</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">msg</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">touser</span><span class="p">:</span> <span class="nx">to</span><span class="p">,</span>
      <span class="na">msgtype</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">agentid</span><span class="p">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">QIWEI_APP_AGENT_ID</span><span class="p">,</span>
      <span class="na">text</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">content</span><span class="p">:</span> <span class="nx">a</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">curl</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">contentType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="nx">msg</span><span class="p">,</span>
      <span class="na">dataType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">});</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">ä¸ªäººæŠ•é€å®Œæˆï¼</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">},</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>ç›´æ¥è°ƒç”¨ ä¿¡æ¯å‘é€ API å®Œæˆã€‚</li>
</ul>

<p>ä½¿ç”¨ç¾¤æœºå™¨äººå®Œæˆå‘é€</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">qiwei</span> <span class="o">=</span> <span class="p">{</span>

  <span class="na">paimonSendToRoom</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">q</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">msg</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">msgtype</span><span class="p">:</span> <span class="dl">"</span><span class="s2">markdown</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">markdown</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">content</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">to</span><span class="p">}</span><span class="s2">: **</span><span class="p">${</span><span class="nx">q</span><span class="p">}</span><span class="s2">**
---
&lt;font color="warning"&gt;</span><span class="p">${</span><span class="nx">a</span><span class="p">}</span><span class="s2">&lt;/font&gt;`</span><span class="p">,</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">curl</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">QIWEI_BOT_WEBHOOK</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">contentType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="nx">msg</span><span class="p">,</span>
      <span class="na">dataType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">});</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">æœºå™¨äººæŠ•é€å®Œæˆï¼</span><span class="dl">"</span><span class="p">);</span>

  <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>è¿™ä¸ª API å¾ˆç®€å•ï¼Œç›´æ¥æŠŠæ¶ˆæ¯ç»„è£…å¥½ä¸¢ç»™ webhook å°±è¡Œäº†ã€‚è¡¨æ‰¬ä¸€ä¸‹è¿™ä¸ª APIã€‚</li>
</ul>

<h2 id="æ€»ç»“ä¸€ä¸‹">æ€»ç»“ä¸€ä¸‹</h2>

<p>å°±ä¸ç”»æ—¶åºå›¾äº†ã€‚</p>

<p>æ•´ä½“çš„è¿‡ç¨‹æ˜¯ï¼š</p>

<ul>
  <li>ç”¨æˆ·ç»™ä¼ä¸šå¾®ä¿¡ APP å‘ä¿¡æ¯ã€‚</li>
  <li>APP æ”¶åˆ°ä¿¡æ¯ä¸¢å…¥é˜Ÿåˆ—ä¸­ï¼ŒåŒ…å«äº†æ–‡æœ¬ï¼Œå‘é€äººç­‰ä¿¡æ¯ã€‚</li>
  <li>å¦ä¸€ä¸ªè¿›ç¨‹è·å–ä»é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªè®°å½•ï¼Œè°ƒç”¨ openai API å¾—åˆ°ç»“æœã€‚</li>
  <li>ä½¿ç”¨ä¼ä¸šå¾®ä¿¡çš„æ¶ˆæ¯å‘é€ API å°†ç»“æœå‘ç»™é—®é—®é¢˜çš„äººã€‚</li>
  <li>ä½¿ç”¨ç¾¤æœºå™¨äººçš„ WebHook å°†ç»“æœå‘é€ç»™ç›¸åº”çš„ç¾¤ã€‚</li>
</ul>

<p>æ•ˆæœå›¾å¦‚ä¸‹ï¼šå·¦ä¾§æ˜¯å’Œ APP èŠå¤©ï¼Œå³ä¾§æ˜¯ä¸€ä¸ªç¾¤èŠæœºå™¨äººã€‚</p>

<p><img src="/assets/posts/tucao/wecom-chatgpt.jpg" alt="ä¼ä¸šå¾®ä¿¡æ•ˆæœå›¾" /></p>

<h2 id="åæ§½">åæ§½</h2>

<p>1 éš”å£çš„é’‰é’‰å’Œé£ä¹¦çš„æœºå™¨äººéƒ½èƒ½ç›´æ¥æ”¶å‘æ¶ˆæ¯ï¼Œä¸ºå•¥ä½ ä¸è¡Œã€‚</p>

<p>2 ä¼ä¸šå¾®ä¿¡çš„ API è®¾è®¡ï¼Œæœ‰ XML çš„ï¼Œæœ‰ Json çš„ï¼ŒAPI è°ƒç”¨æ–¹å¼ä¹Ÿæ˜¯åƒå¥‡ç™¾æ€ªã€‚æ”¶æ¶ˆæ¯çš„é‚£ä¸ªç­¾åéªŒè¯æé‚£ä¹ˆå¤æ‚ï¼Œç¤ºä¾‹å’Œ SDK è¿˜ä¸å…¨ã€‚</p>

<p>3 æ–‡æ¡£çœŸä¹±ï¼Œè¦åˆ°å¤„å»æ‰¾ã€‚</p>

<p>4 å“ˆå“ˆï¼Œæˆ‘çš„æœºå™¨äººåå­—å« æ´¾èŒ/pimonã€‚</p>

<hr />

<p>å‚è€ƒé“¾æ¥ï¼š</p>

<p><a href="https://developer.work.weixin.qq.com/document/path/91770">https://developer.work.weixin.qq.com/document/path/91770</a></p>

<p><a href="https://developer.work.weixin.qq.com/document/10514">https://developer.work.weixin.qq.com/document/10514</a></p>

<p><a href="https://www.npmjs.com/package/chatgpt">https://www.npmjs.com/package/chatgpt</a></p>

<p><a href="https://developer.work.weixin.qq.com/document/path/90236">https://developer.work.weixin.qq.com/document/path/90236</a></p>

<p><a href="https://github.com/WecomTeam/InnerAppCodeSample/tree/main/server">https://github.com/WecomTeam/InnerAppCodeSample/tree/main/server</a></p>]]></content><author><name>å•¤é…’äº‘</name></author><category term="tucao" /><summary type="html"><![CDATA[åŸæ¥æ˜¯æƒ³ä½¿ç”¨ä¼ä¸šå¾®ä¿¡çš„æœºå™¨äººæ¥é›†æˆ ChatGPTï¼Œä½†â€¦ è¿™ç©æ„ä¸æ”¯æŒæ”¶æ¶ˆæ¯ï¼Œåªèƒ½æ¨é€æ¶ˆæ¯ï¼Œæ‰€ä»¥åªèƒ½å¦å¯»ä»–æ³•ã€‚]]></summary></entry><entry><title type="html">ä¸€ä¸ªç°æˆçš„ ChatGPT å¾®ä¿¡æœºå™¨äºº</title><link href="https://youbug.cn/2023/02/chatgpt-wechat-bot.html" rel="alternate" type="text/html" title="ä¸€ä¸ªç°æˆçš„ ChatGPT å¾®ä¿¡æœºå™¨äºº" /><published>2023-02-09T11:09:00+00:00</published><updated>2023-02-09T11:09:00+00:00</updated><id>https://youbug.cn/2023/02/chatgpt-wechat-bot</id><content type="html" xml:base="https://youbug.cn/2023/02/chatgpt-wechat-bot.html"><![CDATA[<p>æœ¬æ–‡æ˜¯ä¸€ä¸ªé›†æˆäº† ChatGPT çš„ç®€å•å¾®ä¿¡æœºå™¨äººçš„éƒ¨ç½²æ–‡æ¡£ï¼Œä½¿ç”¨äº†ç°æœ‰çš„ github ä»“åº“ï¼Œå¹¶è¿›è¡Œé€‚å½“ä¿®æ”¹ï¼Œå¹¶å‘å¸ƒæˆå…¬å…±é•œåƒåŒ…ã€‚å½“å‰æ–‡æ¡£è¯´æ˜ä¸º 2.0 é•œåƒåŒ…ã€‚</p>

<h2 id="è¯´æ˜">è¯´æ˜</h2>

<p>åœ¨è¿™ä¸ªé¡¹ç›®ï¼ˆ<a href="https://github.com/wangrongding/wechat-bot">https://github.com/wangrongding/wechat-bot</a>ï¼‰çš„åŸºç¡€ä¸Šè¿›è¡Œçš„ä¿®æ”¹ï¼š</p>

<ul>
  <li>ä» openai æ”¹å›äº† chatgpt çš„è°ƒç”¨ã€‚</li>
  <li>ä¿®æ”¹äº† chatgpt çš„å¯¹è¯æ¨¡å‹ï¼Œç°åœ¨æœ‰ä¸¤ç§æœºå™¨äºº: ç¾¤æœºå™¨äººå’Œç§äººæœºå™¨äººã€‚</li>
  <li>åœ¨ç¾¤é‡Œï¼Œç”¨ç¾¤æœºå™¨äººå¼€å¤´çš„æ–‡å­—ä¼šè®­ç»ƒç¾¤æœºå™¨äººï¼Œç”¨ç§äººæœºå™¨äººåå­—å¼€å¤´çš„å¯ä»¥è®­ç»ƒç§æœ‰æœºå™¨äººã€‚</li>
  <li>ä¸æœºå™¨äººç§èŠä¹Ÿè¦ä»¥æœºå™¨äººçš„åå­—å¼€å¤´ï¼Œç§èŠçš„æ—¶å€™ç”¨ä¸¤ç§æœºå™¨äººåå­—å¼€å¤´éƒ½ä¼šè®­ç»ƒç§æœ‰æœºå™¨äººã€‚</li>
  <li>å¢åŠ äº†é”™è¯¯å¤„ç†ï¼Œå½“å‡ºé”™çš„æ—¶å€™ï¼Œç°åœ¨æœºå™¨äººèƒ½åšå‡ºå“åº”äº†ã€‚</li>
</ul>

<p>é•œåƒåœ°å€ï¼š</p>

<p><a href="https://hub.docker.com/r/cloudbeer/wx-chatbot/tags">https://hub.docker.com/r/cloudbeer/wx-chatbot/tags</a></p>

<h2 id="éƒ¨ç½²">éƒ¨ç½²</h2>

<h3 id="åœ¨-k8s-ä¸­éƒ¨ç½²">åœ¨ K8S ä¸­éƒ¨ç½²</h3>

<p>éƒ¨ç½² YAML å‚è€ƒå¦‚ä¸‹ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">wx-chatbot</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">wx-chatbot</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">wx-chatbot</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">wx-chatbot</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">wx-chatbot</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">cloudbeer/wx-chatbot:2.0</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OPENAI_API_KEY</span>
              <span class="na">value</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">your-api-key</span><span class="pi">]</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">BOT_NAME</span>
              <span class="na">value</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">your-bot-name</span><span class="pi">]</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ROOM_BOT_NAME</span>
              <span class="na">value</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">your-room-bot-name</span><span class="pi">]</span>
          <span class="na">command</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">node</span>
            <span class="pi">-</span> <span class="s">index.js</span>
</code></pre></div></div>

<p>ä¿®æ”¹ä¸Šé¢ä»£ç ä¸­çš„ç¯å¢ƒå˜é‡ <code class="language-plaintext highlighter-rouge">[your-api-key]</code>, <code class="language-plaintext highlighter-rouge">[your-bot-name]</code>ï¼Œ<code class="language-plaintext highlighter-rouge">[your-room-bot-name]</code>ï¼š</p>

<ul>
  <li>
    <p>OPENAI_API_KEY: åœ¨ openai ç½‘ç«™ç”³è¯·çš„ API_KEYï¼Œå½“å‰ç”³è¯·åœ°å€æ˜¯ï¼š <a href="https://platform.openai.com/account/api-keys">https://platform.openai.com/account/api-keys</a></p>
  </li>
  <li>
    <p>BOT_NAME: ç§äººæœºå™¨äººçš„åå­—ï¼Œå½“å‘é€ä»¥è¿™ä¸ªåå­—å¼€å¤´çš„æ–‡å­—çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ chatgptï¼Œå¦‚ BOT_NAME ä¸º <code class="language-plaintext highlighter-rouge">hisiri</code> çš„æ—¶å€™ï¼Œå‘é€ï¼š<code class="language-plaintext highlighter-rouge">hisiri ä½ å¥½</code> ä¼šå¾—åˆ° ChatGPT çš„å“åº”ã€‚</p>
  </li>
  <li>
    <p>ROOM_BOT_NAME: ç¾¤æœºå™¨äººåå­—ï¼Œè¿™ä¸ªæœºå™¨äººçš„ä¼šè¯æ˜¯åŸºäºç¾¤çš„ï¼Œç¾¤å†…çš„æ‰€æœ‰äººéƒ½å¯ä»¥è®­ç»ƒåŒä¸€ä¸ªæœºå™¨äººã€‚</p>
  </li>
  <li>
    <p>ä½ å¯ä»¥åœ¨ç¾¤é‡Œåˆ†åˆ«å’Œä¸¤ä¸ªæœºå™¨äººå¯¹è¯ã€‚</p>
  </li>
</ul>

<p>éƒ¨ç½²å®Œæˆä¹‹åï¼Œä½¿ç”¨ logs å‘½ä»¤æŸ¥çœ‹äºŒç»´ç ï¼Œç›¸å…³çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs wx-chatbot-xxxxxxx <span class="nt">-f</span>
</code></pre></div></div>

<ul>
  <li>-f å¯ä»¥æŒç»­æ‰“å°æ—¥å¿—ï¼ŒæŸ¥çœ‹æ§åˆ¶å°ä¿¡æ¯ã€‚</li>
  <li>ä½¿ç”¨å¾®ä¿¡æ‰«ç ä¹‹åï¼Œå½“å‰æ‰«ç çš„å¾®ä¿¡ä¼šæˆä¸º ChatGPT æœºå™¨äººã€‚ä½ å¯ä»¥å’Œä»–ç§èŠæˆ–è€…æ‹‰åˆ°ç¾¤é‡Œã€‚</li>
  <li>èŠå¤©çš„æ—¶å€™éœ€è¦åˆ†åˆ«ä»¥ 2 ä¸ªæœºå™¨äººçš„åå­—å¼€å¤´æ‰èƒ½åšå‡ºå“åº”ã€‚</li>
</ul>

<h2 id="docker-å¯åŠ¨">Docker å¯åŠ¨</h2>

<p>Docker å¯åŠ¨ä¸å†èµ˜è¿°ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-it</span> <span class="nt">--name</span> wx-chatgpt-bot <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">OPENAI_API_KEY</span><span class="o">=</span>abc <span class="nt">-e</span> <span class="nv">BOT_NAME</span><span class="o">=</span>å°ç±³ <span class="nt">-e</span> <span class="nv">ROOM_BOT_NAME</span><span class="o">=</span>å¤§ç±³ <span class="se">\</span>
  cloudbeer/wx-chatbot:2.0 node index.js
</code></pre></div></div>

<ul>
  <li>è®°å¾—ä¿®æ”¹ä¸‰ä¸ªç¯å¢ƒå˜é‡ï¼š<code class="language-plaintext highlighter-rouge">-e OPENAI_API_KEY=abc -e BOT_NAME=@siri</code>ã€‚</li>
  <li>æ³¨æ„ï¼šæ­¤å‘½ä»¤åœ¨ MAC å¯åŠ¨æœ‰bugã€‚ç”¨ linux ç³»ç»Ÿæ— è™ã€‚</li>
</ul>

<h2 id="é—®é¢˜å’Œæ”¹è¿›ç‚¹">é—®é¢˜å’Œæ”¹è¿›ç‚¹</h2>

<ul>
  <li>å…è´¹è´¦å· ChatGPT æµ‹ä¼šç»å¸¸æŠ¥ 429 Too Many Requests çš„é”™è¯¯ã€‚</li>
  <li>å¾®ä¿¡å¯èƒ½ä¼šè¢«å°ï¼Œå»ºè®®ä½¿ç”¨æ–°æ³¨å†Œçš„å¾®ä¿¡å°å·ä½œä¸ºæœºå™¨äººã€‚ï¼ˆæš‚ä¸”ä¸æ¸…æ¥šå¾®ä¿¡ä¾§è§¦å‘æœºåˆ¶ï¼‰</li>
  <li>é‡å¯åº”ç”¨ä¼šé‡æ–°åŠ è½½å¾®ä¿¡çš„ä¼šè¯ï¼Œå¯¼è‡´é‡å¤è°ƒç”¨ ChatGPT APIï¼Œå¹¶ç”±å¯èƒ½å¯¼è‡´å¾®ä¿¡è¢«å°ï¼Œé‡å¯åº”ç”¨çš„æ—¶å€™å¤šç­‰ä¸€ä¼šå„¿ï¼Œè®©ä¼šè¯è¿‡æœŸï¼Œæˆ–è€…ä¿®æ”¹ä¸¤ä¸ªbot çš„åå­—åé‡å¯ã€‚</li>
</ul>]]></content><author><name>å•¤é…’äº‘</name></author><category term="container" /><category term="å®¹å™¨" /><summary type="html"><![CDATA[æœ¬æ–‡æ˜¯ä¸€ä¸ªé›†æˆäº† ChatGPT çš„ç®€å•å¾®ä¿¡æœºå™¨äººçš„éƒ¨ç½²æ–‡æ¡£ï¼Œä½¿ç”¨äº†ç°æœ‰çš„ github ä»“åº“ï¼Œå¹¶è¿›è¡Œé€‚å½“ä¿®æ”¹ï¼Œå¹¶å‘å¸ƒæˆå…¬å…±é•œåƒåŒ…ã€‚å½“å‰æ–‡æ¡£è¯´æ˜ä¸º 2.0 é•œåƒåŒ…ã€‚]]></summary></entry><entry><title type="html">è°ƒåº¦ Jenkins ä»»åŠ¡åˆ° Karpenter èŠ‚ç‚¹æ± </title><link href="https://youbug.cn/2023/01/jenkins-job-with-karpenter.html" rel="alternate" type="text/html" title="è°ƒåº¦ Jenkins ä»»åŠ¡åˆ° Karpenter èŠ‚ç‚¹æ± " /><published>2023-01-02T07:12:33+00:00</published><updated>2023-01-02T07:12:33+00:00</updated><id>https://youbug.cn/2023/01/jenkins-job-with-karpenter</id><content type="html" xml:base="https://youbug.cn/2023/01/jenkins-job-with-karpenter.html"><![CDATA[<p>æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•è°ƒåº¦ Jenkins ä»»åŠ¡åˆ° EKS é›†ç¾¤çš„ Karpenter è™šæ‹ŸèŠ‚ç‚¹ã€‚Karpenter å¼ºå¤§çš„ Node ç»„ç»‡èƒ½åŠ›ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦èŠ‚çº¦ä»»åŠ¡è¿è¡Œçš„æˆæœ¬ã€‚</p>

<h2 id="æ’ä»¶é…ç½®">æ’ä»¶é…ç½®</h2>

<p>é¦–å…ˆç¡®è®¤ Jenkins çš„ Kubernetes æ’ä»¶å·²ç»å®‰è£…:</p>

<p>ä»¥ç®¡ç†å‘˜èº«ä»½è¿›å…¥ Manage Jenkins -&gt; Manage Plugins, æœç´¢ Kubernetesï¼Œç¡®è®¤æ’ä»¶å·²ç»å®‰è£…ã€‚</p>

<p>ç„¶åï¼Œè¿›è¡Œ Node é…ç½®:</p>

<p>è¿›å…¥ Manage Jenkins -&gt; Manage Nodes and Clouds -&gt; Config Clouds, å±•å¼€ Kubernetes Cloud detailsâ€¦</p>

<p>å¦‚æœæ‚¨çš„ Jenkins å®‰è£…åœ¨ EKS é›†ç¾¤é‡Œï¼Œå¹¶ä¸”å·¥ä½œä»»åŠ¡ä¹Ÿè¦è°ƒåº¦åˆ°è¿™ä¸ªé›†ç¾¤ï¼Œå¯ä»¥æŒ‰ç…§å¦‚ä¸‹é…ç½®ï¼š</p>

<ul>
  <li>Kubernetes åœ°å€: <a href="https://kubernetes.default">https://kubernetes.default</a></li>
  <li>Kubernetes å‘½åç©ºé—´: jenkins</li>
  <li>Jenkins åœ°å€: <a href="http://jenkins.jenkins.svc.cluster.local:8080">http://jenkins.jenkins.svc.cluster.local:8080</a></li>
  <li>Jenkins é€šé“: jenkins-agent.jenkins.svc.cluster.local:50000</li>
</ul>

<p>å¦‚æœæ˜¯éæœ¬åœ°é›†ç¾¤ï¼Œè¿˜éœ€è¦é…ç½®åˆé€‚çš„åœ°å€å’Œæƒé™ã€‚</p>

<h2 id="ä»»åŠ¡é…ç½®">ä»»åŠ¡é…ç½®</h2>

<p>ç°åœ¨åœ¨é¡¹ç›®ï¼ˆä¸šåŠ¡ï¼‰æ ¹ç›®å½•ç¼–å†™å¦‚ä¸‹çš„ä¸€ä¸ª Jenkinsfileï¼š</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">podTemplate</span><span class="o">(</span><span class="nl">yaml:</span> <span class="s1">'''
    apiVersion: v1
    kind: Pod
    spec:
      nodeSelector:
        karpenter-arch: arm64
      containers:
      - name: maven
        image: maven
        command:
        - sleep
        args:
        - 99d
      - name: golang
        image: golang
        command:
        - sleep
        args:
        - 99d
'''</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">node</span><span class="o">(</span><span class="n">POD_LABEL</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">stage</span><span class="o">(</span><span class="s1">'Get a Maven project'</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">container</span><span class="o">(</span><span class="s1">'maven'</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">stage</span><span class="o">(</span><span class="s1">'Build a Maven project'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sh</span> <span class="s1">'mvn --version'</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="n">stage</span><span class="o">(</span><span class="s1">'Get a Golang project'</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">git</span> <span class="nl">url:</span> <span class="s1">'https://github.com/aws-code-sample/demo-jenkins.git'</span><span class="o">,</span> <span class="nl">branch:</span> <span class="s1">'main'</span>
        <span class="n">container</span><span class="o">(</span><span class="s1">'golang'</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">stage</span><span class="o">(</span><span class="s1">'Build a Go project'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sh</span> <span class="s1">'''
            go version
            ls
          '''</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ Pod çš„æè¿°ä¸­ï¼Œæœ‰ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">nodeSelector: {karpenter-arch: 'arm64'}</code> çš„é€‰æ‹©å™¨ï¼Œè¡¨ç¤ºè¿™ä¸ª Pod è¦éƒ¨ç½²åˆ°æœ‰ karpenter-arch: â€˜arm64â€™ æ ‡ç­¾çš„èŠ‚ç‚¹ã€‚è¿™ä¸ªèŠ‚ç‚¹æ˜¯é€šè¿‡ Karpenter æ¥å®šä¹‰çš„ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">karpenter.sh/v1alpha5</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Provisioner</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">arm-builder</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">requirements</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">karpenter.sh/capacity-type</span>
      <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
      <span class="na">values</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">spot"</span><span class="pi">]</span>
    <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">kubernetes.io/arch"</span>
      <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
      <span class="na">values</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">arm64"</span><span class="pi">]</span>
  <span class="na">limits</span><span class="pi">:</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="na">cpu</span><span class="pi">:</span> <span class="m">1000</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">karpenter-arch</span><span class="pi">:</span> <span class="s">arm64</span>
  <span class="na">providerRef</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">ttlSecondsAfterEmpty</span><span class="pi">:</span> <span class="m">90</span>

<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">karpenter.k8s.aws/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">AWSNodeTemplate</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">amiFamily</span><span class="pi">:</span> <span class="s">Bottlerocket</span>
  <span class="na">subnetSelector</span><span class="pi">:</span>
    <span class="s2">"</span><span class="s">aws:cloudformation:stack-name"</span><span class="err">:</span> <span class="s">CdkEksPocStack</span>
    <span class="s">"aws-cdk:subnet-type": Private</span>
  <span class="na">securityGroupSelector</span><span class="pi">:</span>
    <span class="s2">"</span><span class="s">kubernetes.io/cluster/poc-eks"</span><span class="err">:</span> <span class="s">owned</span>
</code></pre></div></div>

<p>é€šè¿‡ Karpenterï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€å»è´­ä¹° ARM + Spot çš„å®ä¾‹ã€‚</p>

<p>ç°åœ¨åœ¨ Jenkins çš„ Web UI ä¸Šæ–°å»ºä¸€ä¸ª Jenkins ä»»åŠ¡ã€‚</p>

<p>é€‰æ‹© â€œå¤šåˆ†æ”¯æµæ°´çº¿â€ï¼Œæˆ‘çš„ demo ä¸­ä¸»è¦å­—æ®µé…ç½®å¦‚ä¸‹ï¼š</p>

<p>åˆ†æ”¯æº</p>

<ul>
  <li>é¡¹ç›®ä»“åº“åœ°å€ï¼š<a href="https://github.com/aws-code-sample/demo-jenkins">https://github.com/aws-code-sample/demo-jenkins</a></li>
</ul>

<p>Build Configuration</p>

<ul>
  <li>
    <p>Mode: By Jenkinsfile</p>
  </li>
  <li>
    <p>è„šæœ¬è·¯å¾„: Jenkinsfile</p>
  </li>
</ul>

<h2 id="è¿è¡Œç»“æœ">è¿è¡Œç»“æœ</h2>

<p>ç‚¹å‡» â€œç«‹å³æ„å»ºâ€ åï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ—¥å¿—ï¼ˆéƒ¨åˆ†ï¼‰ï¼š</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Started by user Jenkins Admin
 &gt; git rev-parse --resolve-git-dir /var/jenkins_home/caches/git-cfff1181f69195f8b158693b85c23bf9/.git # timeout=10
Setting origin to https://github.com/aws-code-sample/demo-jenkins
...
Seen branch in repository origin/main
Seen 1 remote branch
Obtained Jenkinsfile from b7f6d7cb4db0b89577a60faf5023d710798311e9
[Pipeline] Start of Pipeline
[Pipeline] podTemplate
[Pipeline] {
[Pipeline] node
Created Pod: kubernetes jenkins/demo-jenkins-main-10-1kw6t-mzbkc-6r4qk
Still waiting to schedule task
â€˜demo-jenkins-main-10-1kw6t-mzbkc-6r4qkâ€™ is offline

Running on demo-jenkins-main-10-1kw6t-mzbkc-6r4qk in /home/jenkins/agent/workspace/demo-jenkins_main
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Get a Maven project)
[Pipeline] container
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Build a Maven project)
[Pipeline] sh
+ mvn --version
Apache Maven 3.8.7 (b89d5959fcde851dcb1c8946a785a163f14e1e29)
Maven home: /usr/share/maven
Java version: 17.0.6, vendor: Eclipse Adoptium, runtime: /opt/java/openjdk
Default locale: en_US, platform encoding: UTF-8
OS name: "linux", version: "5.15.79", arch: "aarch64", family: "unix"
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // container
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Get a Golang project)
[Pipeline] git
Selected Git installation does not exist. Using Default
The recommended git tool is: NONE
No credentials specified
Cloning the remote Git repository
Cloning repository https://github.com/aws-code-sample/demo-jenkins.git
 &gt; git init /home/jenkins/agent/workspace/demo-jenkins_main # timeout=10
Fetching upstream changes from https://github.com/aws-code-sample/demo-jenkins.git
 &gt; git --version # timeout=10
 &gt; git --version # 'git version 2.30.2'
 &gt; git fetch --tags --force --progress -- https://github.com/aws-code-sample/demo-jenkins.git +refs/heads/*:refs/remotes/origin/* # timeout=10
Avoid second fetch
Checking out Revision b7f6d7cb4db0b89577a60faf5023d710798311e9 (refs/remotes/origin/main)
 &gt; git config remote.origin.url https://github.com/aws-code-sample/demo-jenkins.git # timeout=10
 &gt; git config --add remote.origin.fetch +refs/heads/*:refs/remotes/origin/* # timeout=10
 &gt; git rev-parse refs/remotes/origin/main^{commit} # timeout=10
 &gt; git config core.sparsecheckout # timeout=10
 &gt; git checkout -f b7f6d7cb4db0b89577a60faf5023d710798311e9 # timeout=10
 &gt; git branch -a -v --no-abbrev # timeout=10
 &gt; git checkout -b main b7f6d7cb4db0b89577a60faf5023d710798311e9 # timeout=10
Commit message: "sh"
 &gt; git rev-list --no-walk b7f6d7cb4db0b89577a60faf5023d710798311e9 # timeout=10
[Pipeline] container
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Build a Go project)
[Pipeline] sh
+ go version
go version go1.19.5 linux/arm64
+ ls
Jenkinsfile
readme.md
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // container
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // node
[Pipeline] }
[Pipeline] // podTemplate
[Pipeline] End of Pipeline
Finished: SUCCESS
</code></pre></div></div>

<p>ä»ä¸Šè¿° log ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è¿è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<ul>
  <li>ä»»åŠ¡å¯åŠ¨åï¼Œç”±äºæ²¡æœ‰åˆé€‚çš„ Node å¯ä»¥é€‰æ‹©ï¼Œpod offlineã€‚</li>
  <li>æ­¤æ—¶ Karpenter è´­ä¹° EC2 å¹¶å®‰è£… OS å’Œå¿…è¦ podï¼Œæ­¤è¿‡ç¨‹å¤§çº¦ 90 ç§’å·¦å³ã€‚</li>
  <li>ç„¶åå¯åŠ¨ä»»åŠ¡ï¼Œä»è¾“å‡ºç»“æœä¸­å¯ä»¥çœ‹åˆ° ä½¿ç”¨äº† arm æ¶æ„ï¼ˆaarch64 æˆ– arm64ï¼‰</li>
  <li>æè¿° nodeï¼ˆæˆ–åœ¨ AWS æ§åˆ¶å°ï¼‰å¯æ˜¾ç¤ºç›¸åº”çš„ EC2 ä¸º Spot å®ä¾‹ã€‚</li>
</ul>

<hr />

<p>ç›¸å…³é˜…è¯»ï¼š</p>

<p><a href="https://plugins.jenkins.io/kubernetes/">Jenkins çš„ Kubernetes æ’ä»¶</a></p>

<p><a href="https://karpenter.sh/">Karpenter å®˜ç½‘</a></p>

<p><a href="https://youbug.cn/2022/12/the-cheapest-way-to-ci-cn.html">åœ¨ AWS æ„å»ºåº”ç”¨ (Gitlab CI) æœ€ä¾¿å®œçš„å§¿åŠ¿</a></p>

<p><a href="https://youbug.cn/2022/11/cdk-install-karpenter-1.9.2.html">ä½¿ç”¨ CDK å®‰è£… Karpenter æ–°ç‰ˆ</a></p>]]></content><author><name>å•¤é…’äº‘</name></author><category term="devops," /><category term="container" /><summary type="html"><![CDATA[æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•è°ƒåº¦ Jenkins ä»»åŠ¡åˆ° EKS é›†ç¾¤çš„ Karpenter è™šæ‹ŸèŠ‚ç‚¹ã€‚Karpenter å¼ºå¤§çš„ Node ç»„ç»‡èƒ½åŠ›ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦èŠ‚çº¦ä»»åŠ¡è¿è¡Œçš„æˆæœ¬ã€‚]]></summary></entry><entry><title type="html">ç¼–å†™ Argo CD äººå·¥éƒ¨ç½² API</title><link href="https://youbug.cn/2022/12/argocd-manual-sync-api.html" rel="alternate" type="text/html" title="ç¼–å†™ Argo CD äººå·¥éƒ¨ç½² API" /><published>2022-12-23T09:53:33+00:00</published><updated>2022-12-23T09:53:33+00:00</updated><id>https://youbug.cn/2022/12/argocd-manual-sync-api</id><content type="html" xml:base="https://youbug.cn/2022/12/argocd-manual-sync-api.html"><![CDATA[<p>ä½¿ç”¨ ArgoCD å¯ä»¥æœ‰æ•ˆè§£è€¦ CI å’Œ CDã€‚
æƒ³è±¡è¿™ä¸ªåœºæ™¯ï¼šå½“ CI æµç¨‹å°†æ„å»ºç‰©æ‰“åŒ…å®Œæˆï¼Œå¹¶æ›´æ–°äº† Git éƒ¨ç½²ä»“åº“ï¼Œæ­¤æ—¶ CI æµç¨‹å‘é€šçŸ¥ç»™ç›¸å…³æœ‰å®¡æ‰¹äººå‘˜ï¼Œå®¡æ‰¹è€…é€šè¿‡ç‚¹å‡»é“¾æ¥å°±å¯ä»¥å®Œæˆéƒ¨ç½²ã€‚
è™½ç„¶å¯ä»¥é€šè¿‡ç™»å½• Argo CD çš„ UI ç•Œé¢å¯ä»¥å®Œæˆæ­¤æ“ä½œï¼Œä½†æ„Ÿè§‰è¿˜ä¸å¤Ÿä¸æ»‘ã€‚</p>

<h2 id="æƒ³æ³•">æƒ³æ³•</h2>

<p>æˆ‘çš„æƒ³æ³•æ˜¯ï¼š</p>

<p>ç¼–å†™ 2 ä¸ª API æš´éœ²å‡ºæ¥ï¼š</p>

<ul>
  <li>å‘é‚®ä»¶(æˆ–è€…å‘å¾®ä¿¡ï¼Œslack å•¥çš„) çš„ API</li>
  <li>å°è£… argocd sync çš„ API</li>
</ul>

<p>è¿‡ç¨‹æ˜¯ï¼š</p>

<p>CI ç»“æŸå -&gt; è°ƒç”¨ API å‘é‚®ä»¶ï¼Œé‚®ä»¶çš„å†…å®¹ï¼Œæ˜¯ä¸€ä¸ªå¸¦æœ‰æ—¶é—´æˆ³ç­¾åçš„ Url -&gt; æ”¶åˆ°é‚®ä»¶çš„äººï¼Œç›´æ¥åœ¨é‚®ä»¶é‡Œç‚¹å‡»æ­¤é“¾æ¥è§¦å‘ argocd syncã€‚
ä¸‹é¢æˆ‘æ¥åˆ†è§£è¿™ä¸€è¿‡ç¨‹ï¼Œå¹¶æœ€åç»™å‡ºæ•´ä½“çš„ä»£ç ã€‚</p>

<p>æœ¬æ–‡çš„ä»£ç ä½¿ç”¨ C# ç¼–å†™ï¼Œä¸ºå•¥ç”¨ C#ï¼Ÿå› ä¸ºå¥½ä¹…æ²¡ç”¨è¿‡äº†ã€‚è¿™ä¸ªè¯­è¨€æˆ‘ä¸æƒ³å¿˜è®°ï¼Œä»–æ˜¯æœ€å¥½çš„é¢å¯¹å¯¹è±¡è¯­è¨€ã€‚</p>

<h2 id="å…ˆçœ‹çœ‹-argo-cd-api">å…ˆçœ‹çœ‹ Argo CD API</h2>

<p>é€šè¿‡è¿™ä¸ªåœ°å€é˜…è¯» Argo CD API æ–‡æ¡£ï¼š<code class="language-plaintext highlighter-rouge">&lt;argocd_server_url&gt;/swagger-ui</code></p>

<p>æˆ‘ä»¬æ‰¾åˆ°äº†æˆ‘ä»¬éœ€è¦çš„ API æœ‰ä¸¤ä¸ªï¼š</p>

<ul>
  <li>SessionService_Create: <code class="language-plaintext highlighter-rouge">&lt;argocd_server_url&gt;/api/v1/session</code>ï¼Œè·å– Authorization tokenã€‚</li>
  <li>ApplicationService_Sync: <code class="language-plaintext highlighter-rouge">&lt;argocd_server_url&gt;/api/v1/applications/{name}/sync</code>ï¼ŒåŒæ­¥åº”ç”¨ã€‚</li>
</ul>

<p>è¯·å°† <code class="language-plaintext highlighter-rouge">&lt;argocd_server_url&gt;</code> æ›´æ¢ä¸ºæ‚¨çš„ Argo CD å¯¹å¤–å‘å¸ƒåœ°å€ (åœ¨ K8S é›†ç¾¤å†…å¯¹åº”çš„æœåŠ¡ä¸ºï¼šargocd-server)ã€‚</p>

<p>è°ƒç”¨æ–¹æ³•å¤§çº¦ä¸ºï¼š</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /api/v1/session

{
  "username": "admin",
  "password": "argocd-secret"
}
</code></pre></div></div>

<ul>
  <li>è¿™é‡Œéœ€è¦ä¼ å…¥æ‚¨çš„ Argo CD çš„ç”¨æˆ·åå’Œå¯†ç ã€‚</li>
</ul>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /api/v1/applications/{name}/sync
Authorization: Bearer ${token}

{
  "appNamespace": "argocd"
}
</code></pre></div></div>

<ul>
  <li>å…¶ä¸­å¿…é¡»çš„å‚æ•° url ä¸­é—´çš„ nameï¼Œè¿™ä¸ªå°±æ˜¯åˆ›å»ºçš„ ArgoCD åº”ç”¨çš„åå­—ã€‚</li>
  <li>æ³¨æ„ appNamespace æ˜¯ ArgoCD åº”ç”¨çš„å‘½åç©ºé—´ï¼Œä¸æ˜¯ä½ çš„ä¸šåŠ¡åº”ç”¨çš„å‘½åç©ºé—´ã€‚</li>
</ul>

<p>æœ‰äº†è¿™ 2 ä¸ª APIï¼Œä¸‹é¢çš„æ“ä½œå°±ç®€å•äº†ã€‚</p>

<h2 id="å‘é€æ›´æ–°é‚®ä»¶">å‘é€æ›´æ–°é‚®ä»¶</h2>

<p>ä¸‹é¢è¿™ä¸ªæ–¹æ³•æ˜ å°„äº†ä¸€ä¸ª URL ç”¨äºå‘é€é‚®ä»¶ï¼š</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">public</span> <span class="kt">string</span> <span class="nf">sendEmail</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">,</span> <span class="kt">string</span> <span class="n">appName</span><span class="p">){</span>

    <span class="kt">var</span> <span class="n">email</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MimeMessage</span><span class="p">();</span>

    <span class="n">email</span><span class="p">.</span><span class="n">Sender</span> <span class="p">=</span> <span class="n">MailboxAddress</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="s">"cloudbeer@gmail.com"</span><span class="p">);</span>
    <span class="n">email</span><span class="p">.</span><span class="n">Sender</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"CD Bot"</span><span class="p">;</span>

    <span class="n">email</span><span class="p">.</span><span class="n">From</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">email</span><span class="p">.</span><span class="n">Sender</span><span class="p">);</span>
    <span class="n">email</span><span class="p">.</span><span class="n">To</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">MailboxAddress</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">emails</span><span class="p">));</span>
    <span class="n">email</span><span class="p">.</span><span class="n">Subject</span> <span class="p">=</span> <span class="s">$"Application </span><span class="p">{</span><span class="n">appName</span><span class="p">}</span><span class="s"> is ready for deployment."</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">sign</span> <span class="p">=</span> <span class="nf">signApi</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="m">7200</span><span class="p">);</span> 
    <span class="n">email</span><span class="p">.</span><span class="n">Body</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TextPart</span><span class="p">(</span><span class="n">TextFormat</span><span class="p">.</span><span class="n">Html</span><span class="p">)</span> <span class="p">{</span> 
      <span class="n">Text</span> <span class="p">=</span>  <span class="s">$@"</span><span class="err">
</span><span class="s">        Application Name: </span><span class="p">{</span><span class="n">appName</span><span class="p">}</span><span class="s">&lt;br&gt;</span><span class="err">
</span><span class="s">        Updated Date: </span><span class="p">{</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">}</span><span class="s">&lt;br&gt;</span><span class="err">
</span><span class="s">        &lt;br&gt;</span><span class="err">
</span><span class="s">        Click this link to approve the deployment in 2 hours.&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><span class="err">
</span><span class="s">        &lt;a href='http://localhost:9999/argo/deploy?name=</span><span class="p">{</span><span class="n">appName</span><span class="p">}</span><span class="s">&amp;sign=</span><span class="p">{</span><span class="n">sign</span><span class="p">}</span><span class="s">' </span><span class="err">
</span><span class="s">          style='padding:10px 30px;border:1px solid #ccc;border-radius:5px;'&gt;</span><span class="err">
</span><span class="s">        Deploy Now</span><span class="err">
</span><span class="s">        &lt;/a&gt;</span><span class="err">
</span><span class="s">        &lt;br /&gt;&lt;br&gt;&lt;br&gt;</span><span class="err">
</span><span class="s">        &lt;br /&gt;è¯·æ³¨æ„ï¼šä¸Šè¿°é“¾æ¥ 2 å°æ—¶å€™æœ‰æ•ˆã€‚"</span>
    <span class="p">};</span>

    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">smtp</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SmtpClient</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">smtp</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="s">"smtp.gmail.com"</span><span class="p">,</span> <span class="m">465</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
        <span class="n">smtp</span><span class="p">.</span><span class="nf">Authenticate</span><span class="p">(</span><span class="s">"cloudbeer@gmail.com"</span><span class="p">,</span> <span class="n">gmailPassword</span><span class="p">);</span>
        <span class="n">smtp</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="n">email</span><span class="p">);</span>
        <span class="n">smtp</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s">"OK"</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>ä½¿ç”¨äº† MailKit å‘é€é‚®ä»¶ã€‚</li>
  <li>æ­¤ API æ¥å—å‚æ•°: email å’Œ appName</li>
  <li>è®¡ç®—åŒ…å«æ—¶é—´æˆ³(2å°æ—¶è¿‡æœŸæ—¶é—´)çš„ç­¾åï¼Œ å°†éƒ¨ç½²é“¾æ¥ (http://localhost:9999/argo/deploy?name=?) å’Œç­¾åä½œä¸ºé‚®ä»¶æ­£æ–‡å‘é€åˆ°ç›®æ ‡é‚®ç®±ã€‚</li>
  <li>æ­¤ api åº”è¯¥ç”± CI æ¥è°ƒç”¨ã€‚</li>
  <li>ç‚¹å‡»é‚®ä»¶é‡Œé¢çš„é“¾æ¥ï¼Œåˆ™ä¼šè§¦å‘éƒ¨ç½²æ“ä½œã€‚</li>
</ul>

<h2 id="è§¦å‘éƒ¨ç½²æ“ä½œ">è§¦å‘éƒ¨ç½²æ“ä½œ</h2>

<p>å…ˆçœ‹ä»£ç ï¼š</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">deploy</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">sign</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="nf">verifyApi</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sign</span><span class="p">)){</span>
      <span class="k">return</span> <span class="s">"ç­¾åéªŒè¯å¤±è´¥ï¼Œæˆ–è€…é“¾æ¥è¿‡æœŸäº†"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">map</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;();</span>
    <span class="n">map</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"username"</span><span class="p">,</span> <span class="n">argoUsername</span><span class="p">);</span>
    <span class="n">map</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"password"</span><span class="p">,</span> <span class="n">argoPassword</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">pContent</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>


    <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpRequestMessage</span><span class="p">(</span><span class="n">HttpMethod</span><span class="p">.</span><span class="n">Post</span><span class="p">,</span> <span class="n">argoUrl</span> <span class="p">+</span> <span class="s">"/api/v1/session"</span><span class="p">);</span>
    <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Accept</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">MediaTypeWithQualityHeaderValue</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">));</span>
    <span class="n">request</span><span class="p">.</span><span class="n">Content</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringContent</span><span class="p">(</span><span class="n">pContent</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">);</span>
    <span class="n">request</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MediaTypeHeaderValue</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">);</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">httpClientHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClientHandler</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">httpClientHandler</span><span class="p">.</span><span class="n">ServerCertificateCustomValidationCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span> <span class="p">};</span>
      <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">(</span><span class="n">httpClientHandler</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">SendAsync</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">EnsureSuccessStatusCode</span><span class="p">();</span>
        <span class="kt">string</span> <span class="n">responseBody</span> <span class="p">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">string</span><span class="p">&gt;&gt;(</span><span class="n">responseBody</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nf">syncApp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">token</span><span class="p">[</span><span class="s">"token"</span><span class="p">],</span> <span class="s">"gateway"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>é¦–å…ˆéªŒè¯ç­¾åã€‚</li>
  <li>é€šè¿‡è°ƒç”¨ ArgoCD çš„ <code class="language-plaintext highlighter-rouge">/api/v1/session</code> å»è·å– Argo CD çš„ ä¸´æ—¶ Authorization tokenã€‚</li>
  <li>è°ƒç”¨åº”ç”¨åŒæ­¥ APIã€‚</li>
  <li>è°ƒç”¨æˆåŠŸåˆ™å®Œæˆè§¦å‘åº”ç”¨åŒæ­¥ã€‚</li>
</ul>

<h2 id="æµ‹è¯•è¿‡ç¨‹">æµ‹è¯•è¿‡ç¨‹</h2>

<p>1 é‚®ä»¶å‘é€</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://localhost:9999/argo/sendemail?email<span class="o">=</span>cloudbeer@gmail.com&amp;appName<span class="o">=</span>product
</code></pre></div></div>

<p>2 gmail é‚®ç®±æ”¶é‚®ä»¶ï¼Œç‚¹å‡» Deploy Now é“¾æ¥ã€‚è¿™ä¸ªé“¾æ¥ç±»ä¼¼è¿™æ ·ï¼š</p>

<p><a href="http://localhost:9999/argo/deploy?name=product&amp;sign=eyJl...1In0=">http://localhost:9999/argo/deploy?name=product&amp;sign=eyJl...1In0=</a></p>

<p>3 ç‚¹å‡»ä¸Šé¢çš„é“¾æ¥å®Œæˆåº”ç”¨éƒ¨ç½²ã€‚</p>

<h2 id="å®Œæ•´çš„ä»£ç ">å®Œæ•´çš„ä»£ç </h2>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http.Headers</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.Json</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">MailKit.Net.Smtp</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">MimeKit</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">MimeKit.Text</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Cryptography</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ArgoTrigger.Controllers</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">ArgoController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="kt">string</span> <span class="n">argoUrl</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"ARGO_URL"</span><span class="p">)</span> <span class="p">??</span> <span class="s">"http://host.docker.internal:8080"</span><span class="p">;</span>
  <span class="k">private</span> <span class="kt">string</span> <span class="n">argoUsername</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"ARGO_USERNAME"</span><span class="p">)??</span> <span class="s">"admin"</span><span class="p">;</span>
  <span class="k">private</span> <span class="kt">string</span> <span class="n">argoPassword</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"ARGO_PASSWORD"</span><span class="p">)??</span><span class="s">"uBGroHnh9TjSa7ud"</span><span class="p">;</span>
  <span class="k">private</span> <span class="kt">string</span> <span class="n">gmailPassword</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"GMAIL_PASSWORD"</span><span class="p">);</span>
  
  <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">deploy</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">sign</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="nf">verifyApi</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sign</span><span class="p">)){</span>
      <span class="k">return</span> <span class="s">"ç­¾åéªŒè¯å¤±è´¥ï¼Œæˆ–è€…é“¾æ¥è¿‡æœŸäº†"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">map</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;();</span>
    <span class="n">map</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"username"</span><span class="p">,</span> <span class="n">argoUsername</span><span class="p">);</span>
    <span class="n">map</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"password"</span><span class="p">,</span> <span class="n">argoPassword</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">pContent</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>


    <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpRequestMessage</span><span class="p">(</span><span class="n">HttpMethod</span><span class="p">.</span><span class="n">Post</span><span class="p">,</span> <span class="n">argoUrl</span> <span class="p">+</span> <span class="s">"/api/v1/session"</span><span class="p">);</span>
    <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Accept</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">MediaTypeWithQualityHeaderValue</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">));</span>
    <span class="n">request</span><span class="p">.</span><span class="n">Content</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringContent</span><span class="p">(</span><span class="n">pContent</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">);</span>
    <span class="n">request</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MediaTypeHeaderValue</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">);</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">httpClientHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClientHandler</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">httpClientHandler</span><span class="p">.</span><span class="n">ServerCertificateCustomValidationCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span> <span class="p">};</span>
      <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">(</span><span class="n">httpClientHandler</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">SendAsync</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">EnsureSuccessStatusCode</span><span class="p">();</span>
        <span class="kt">string</span> <span class="n">responseBody</span> <span class="p">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">string</span><span class="p">&gt;&gt;(</span><span class="n">responseBody</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nf">syncApp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">token</span><span class="p">[</span><span class="s">"token"</span><span class="p">],</span> <span class="s">"gateway"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">syncApp</span><span class="p">(</span><span class="n">HttpClient</span> <span class="n">client</span><span class="p">,</span> <span class="kt">string</span> <span class="n">token</span><span class="p">,</span> <span class="kt">string</span> <span class="n">appName</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">map</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;();</span>
    <span class="n">map</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"appNamespace"</span><span class="p">,</span> <span class="s">"argocd"</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">pContent</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpRequestMessage</span><span class="p">(</span><span class="n">HttpMethod</span><span class="p">.</span><span class="n">Post</span><span class="p">,</span> <span class="n">argoUrl</span> <span class="p">+</span> <span class="s">"/api/v1/applications/"</span> <span class="p">+</span> <span class="n">appName</span> <span class="p">+</span> <span class="s">"/sync"</span><span class="p">);</span>


    <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Accept</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">MediaTypeWithQualityHeaderValue</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">));</span>
    <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Authorization</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AuthenticationHeaderValue</span><span class="p">(</span><span class="s">"Bearer"</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
    <span class="n">request</span><span class="p">.</span><span class="n">Content</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringContent</span><span class="p">(</span><span class="n">pContent</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">);</span>
    <span class="n">request</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MediaTypeHeaderValue</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">SendAsync</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">EnsureSuccessStatusCode</span><span class="p">();</span>
    <span class="kt">string</span> <span class="n">responseBody</span> <span class="p">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">responseBody</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="kt">string</span> <span class="nf">sendEmail</span><span class="p">(</span><span class="kt">string</span> <span class="n">emails</span><span class="p">,</span> <span class="kt">string</span> <span class="n">appName</span><span class="p">){</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">emails</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">gmailPassword</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">email</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MimeMessage</span><span class="p">();</span>

    <span class="n">email</span><span class="p">.</span><span class="n">Sender</span> <span class="p">=</span> <span class="n">MailboxAddress</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="s">"cloudbeer@gmail.com"</span><span class="p">);</span>
    <span class="n">email</span><span class="p">.</span><span class="n">Sender</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"CD Bot"</span><span class="p">;</span>

    <span class="n">email</span><span class="p">.</span><span class="n">From</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">email</span><span class="p">.</span><span class="n">Sender</span><span class="p">);</span>
    <span class="n">email</span><span class="p">.</span><span class="n">To</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">MailboxAddress</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">emails</span><span class="p">));</span>
    <span class="n">email</span><span class="p">.</span><span class="n">Subject</span> <span class="p">=</span> <span class="s">$"Application </span><span class="p">{</span><span class="n">appName</span><span class="p">}</span><span class="s"> is ready for deployment."</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">sign</span> <span class="p">=</span> <span class="nf">signApi</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="m">7200</span><span class="p">);</span> 
    <span class="n">email</span><span class="p">.</span><span class="n">Body</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TextPart</span><span class="p">(</span><span class="n">TextFormat</span><span class="p">.</span><span class="n">Html</span><span class="p">)</span> <span class="p">{</span> 
      <span class="n">Text</span> <span class="p">=</span>  <span class="s">$@"</span><span class="err">
</span><span class="s">        Application Name: </span><span class="p">{</span><span class="n">appName</span><span class="p">}</span><span class="s">&lt;br&gt;</span><span class="err">
</span><span class="s">        Updated Date: </span><span class="p">{</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">}</span><span class="s">&lt;br&gt;</span><span class="err">
</span><span class="s">        &lt;br&gt;</span><span class="err">
</span><span class="s">        Click this link to approve the deployment in 2 hours.&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><span class="err">
</span><span class="s">        &lt;a href='http://localhost:9999/argo/deploy?name=</span><span class="p">{</span><span class="n">appName</span><span class="p">}</span><span class="s">&amp;sign=</span><span class="p">{</span><span class="n">sign</span><span class="p">}</span><span class="s">' </span><span class="err">
</span><span class="s">          style='padding:10px 30px;border:1px solid #ccc;border-radius:5px;'&gt;</span><span class="err">
</span><span class="s">        Deploy Now</span><span class="err">
</span><span class="s">        &lt;/a&gt;</span><span class="err">
</span><span class="s">        &lt;br /&gt;&lt;br&gt;&lt;br&gt;</span><span class="err">
</span><span class="s">        &lt;br /&gt;è¯·æ³¨æ„ï¼šä¸Šè¿°é“¾æ¥ 2 å°æ—¶å€™æœ‰æ•ˆã€‚"</span>
    <span class="p">};</span>

    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">smtp</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SmtpClient</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">smtp</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="s">"smtp.gmail.com"</span><span class="p">,</span> <span class="m">465</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
        <span class="n">smtp</span><span class="p">.</span><span class="nf">Authenticate</span><span class="p">(</span><span class="s">"cloudbeer@gmail.com"</span><span class="p">,</span> <span class="n">gmailPassword</span><span class="p">);</span>
        <span class="n">smtp</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="n">email</span><span class="p">);</span>
        <span class="n">smtp</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s">"OK"</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="kt">string</span> <span class="nf">signApi</span><span class="p">(</span><span class="kt">string</span> <span class="n">appName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">expireSecond</span><span class="p">){</span>
    <span class="kt">string</span> <span class="n">cachedKey</span> <span class="p">=</span> <span class="s">"abcdefghijklmnop"</span><span class="p">;</span>
    <span class="n">DateTime</span> <span class="n">expireAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">AddSeconds</span><span class="p">(</span><span class="n">expireSecond</span><span class="p">);</span>
    <span class="kt">string</span> <span class="n">sign</span> <span class="p">=</span> <span class="nf">sha256</span><span class="p">(</span><span class="n">cachedKey</span> <span class="p">+</span> <span class="n">appName</span> <span class="p">+</span> <span class="n">expireAt</span><span class="p">.</span><span class="n">Ticks</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">signJson</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;();</span>
    <span class="n">signJson</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"expireAt"</span><span class="p">,</span> <span class="n">expireAt</span><span class="p">.</span><span class="n">Ticks</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
    <span class="n">signJson</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"sign"</span><span class="p">,</span> <span class="n">sign</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">jStrSign</span> <span class="p">=</span>  <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">signJson</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">jStrSign</span><span class="p">);</span>

    <span class="k">return</span> <span class="nf">base64Encode</span><span class="p">(</span><span class="n">jStrSign</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">private</span> <span class="kt">bool</span> <span class="nf">verifyApi</span><span class="p">(</span><span class="kt">string</span> <span class="n">appName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">sign</span><span class="p">){</span>
    <span class="kt">string</span> <span class="n">cachedKey</span> <span class="p">=</span> <span class="s">"abcdefghijklmnop"</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">jStrSign</span> <span class="p">=</span> <span class="nf">base64Decode</span><span class="p">(</span><span class="n">sign</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">signJson</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;(</span><span class="n">jStrSign</span><span class="p">);</span>
    <span class="kt">long</span> <span class="n">expireAt</span> <span class="p">=</span> <span class="kt">long</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">signJson</span><span class="p">[</span><span class="s">"expireAt"</span><span class="p">]);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Ticks</span> <span class="p">&gt;</span> <span class="n">expireAt</span><span class="p">){</span>
      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">string</span> <span class="n">signFromApi</span> <span class="p">=</span> <span class="n">signJson</span><span class="p">[</span><span class="s">"sign"</span><span class="p">];</span>
    <span class="kt">string</span> <span class="n">signFromCache</span> <span class="p">=</span> <span class="nf">sha256</span><span class="p">(</span><span class="n">cachedKey</span> <span class="p">+</span> <span class="n">appName</span> <span class="p">+</span> <span class="n">signJson</span><span class="p">[</span><span class="s">"expireAt"</span><span class="p">]);</span>
    <span class="k">return</span> <span class="n">signFromCache</span> <span class="p">==</span> <span class="n">signFromApi</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">string</span> <span class="nf">sha256</span><span class="p">(</span><span class="kt">string</span> <span class="n">randomString</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">SHA256</span> <span class="n">mySHA256</span> <span class="p">=</span> <span class="n">SHA256</span><span class="p">.</span><span class="nf">Create</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="kt">byte</span><span class="p">[]</span> <span class="n">crypto</span> <span class="p">=</span> <span class="n">mySHA256</span><span class="p">.</span><span class="nf">ComputeHash</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">randomString</span><span class="p">));</span>
      <span class="kt">string</span> <span class="n">hash</span> <span class="p">=</span> <span class="n">String</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="kt">byte</span> <span class="n">theByte</span> <span class="k">in</span> <span class="n">crypto</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">hash</span> <span class="p">+=</span> <span class="n">theByte</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"x2"</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="n">hash</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kt">string</span> <span class="nf">base64Encode</span><span class="p">(</span><span class="kt">string</span> <span class="n">plainText</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">plainTextBytes</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">plainText</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">System</span><span class="p">.</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToBase64String</span><span class="p">(</span><span class="n">plainTextBytes</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">string</span> <span class="nf">base64Decode</span><span class="p">(</span><span class="kt">string</span> <span class="n">base64EncodedData</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">base64EncodedBytes</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Convert</span><span class="p">.</span><span class="nf">FromBase64String</span><span class="p">(</span><span class="n">base64EncodedData</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">base64EncodedBytes</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h2 id="é™„net-core-é¡¹ç›®å…¥é—¨">é™„ï¼š.NET Core é¡¹ç›®å…¥é—¨</h2>

<p>ä¸‹é¢è®°å½•äº†ä»£ç å¼€å§‹ä¹‹å‰çš„å·¥ä½œï¼ŒåŒ…æ‹¬ .NET è¿è¡Œç¯å¢ƒé…ç½®ï¼Œåˆ›å»ºé¡¹ç›®ï¼Œå¼€å‘é…ç½®ç­‰å·¥ä½œã€‚æˆ‘å¼€å§‹å†™è¿™ä¸ªæ–‡ç« çš„æ—¶å€™ç”µè„‘è¿˜æ²¡æœ‰ .NET ç¯å¢ƒã€‚</p>

<p>æˆ‘å‡†å¤‡ä½¿ç”¨ .NET é•œåƒä½œä¸ºæˆ‘çš„å¼€å‘ç¯å¢ƒï¼Œå…ˆæ‹‰ä¸€ä¸‹é•œåƒï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull mcr.microsoft.com/dotnet/sdk:7.0
</code></pre></div></div>

<h3 id="åˆ›å»ºä¸€ä¸ªé¡¹ç›®">åˆ›å»ºä¸€ä¸ªé¡¹ç›®</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">-v</span> ~/projects/cloudbeer:/app <span class="se">\</span>
  mcr.microsoft.com/dotnet/sdk:7.0 <span class="se">\</span>
  dotnet new webapp <span class="nt">-o</span> /app/ArgoTrigger <span class="nt">--no-https</span> <span class="nt">-f</span> net7.0
</code></pre></div></div>

<p>è¿™ä¸ªå‘½ä»¤å«ä¹‰å¦‚ä¸‹ï¼š</p>

<ul>
  <li>å®¶ç›®å½•çš„ /projects/cloudbeer æ˜ å°„åˆ°å®¹å™¨çš„ /app</li>
  <li>é€šè¿‡ dotnet å‘½ä»¤åœ¨å­ç›®å½• ArgoTrigger é‡Œç”Ÿäº§ä¸€ä¸ª asp.net core é¡¹ç›®ã€‚</li>
</ul>

<h3 id="å®‰è£…ä¾èµ–åŒ…">å®‰è£…ä¾èµ–åŒ…</h3>

<p>å®‰è£… 2 ä¸ªä¾èµ–åŒ…ï¼ŒMailKit å’Œ MimeKitï¼Œç”¨æ¥å‘é€é€šçŸ¥é‚®ä»¶ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">-v</span> ~/projects/cloudbeer:/app <span class="se">\</span>
  mcr.microsoft.com/dotnet/sdk:7.0 <span class="se">\</span>
  sh <span class="nt">-c</span> <span class="s2">"cd /app/ArgoTrigger &amp;&amp; dotnet add package MailKit"</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">-v</span> ~/projects/cloudbeer:/app <span class="se">\</span>
  mcr.microsoft.com/dotnet/sdk:7.0 <span class="se">\</span>
  sh <span class="nt">-c</span> <span class="s2">"cd /app/ArgoTrigger &amp;&amp; dotnet add package MimeKit"</span>
</code></pre></div></div>

<h3 id="å¯åŠ¨é¡¹ç›®">å¯åŠ¨é¡¹ç›®</h3>

<p>ç°åœ¨é¡¹ç›®å·²ç»äº§ç”Ÿï¼Œå¯ä»¥æ‰“å¼€ vscode è¿›è¡Œç¼–è¾‘äº†ã€‚</p>

<p>é»˜è®¤çš„ Web å¼€å‘ Url æ˜¯ localhost + éšæœºç«¯å£ï¼Œä½†æˆ‘ä»¬éœ€è¦å°† å®¹å™¨çš„ ç«¯å£æ˜ å°„å‡ºæ¥ï¼Œéœ€è¦ä¸€ä¸ª 0.0.0.0 çš„å›ºå®šç«¯å£ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ appsettings.jsonï¼ŒåŠ å…¥ï¼š<code class="language-plaintext highlighter-rouge">"Urls": "http://0.0.0.0:9999"</code></p>

<p>appsettings.json è¿™ä¸ªæ–‡ä»¶ç°åœ¨çœ‹èµ·æ¥åº”è¯¥æ˜¯è¿™æ ·ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Urls"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://0.0.0.0:9999"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Logging"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"LogLevel"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Information"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Microsoft.AspNetCore"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"AllowedHosts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>ç„¶åå¯åŠ¨é¡¹ç›®çš„å¼€å‘æ¨¡å¼ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">-p</span> 9999:9999 <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">DOTNET_WATCH_RESTART_ON_RUDE_EDIT</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">GMAIL_PASSWORD</span><span class="o">=</span><span class="nv">$GMAIL_PASSWORD</span> <span class="se">\</span>
  <span class="nt">-v</span> ~/projects/cloudbeer:/app <span class="se">\</span>
  mcr.microsoft.com/dotnet/sdk:7.0 <span class="se">\</span>
  sh <span class="nt">-c</span> <span class="s2">"cd /app/ArgoTrigger &amp;&amp; dotnet watch -v"</span>
</code></pre></div></div>

<ul>
  <li>GMAIL_PASSWORD æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œæ˜¯ Gmail çš„ä¸´æ—¶ç™»å½• tokenï¼Œè¿™ä¸ªå˜é‡é€šè¿‡æœ¬æœºåˆ°å®¹å™¨ï¼Œæœ€ç»ˆä¼ å…¥å‘é€é‚®ä»¶çš„ä»£ç ä¸­ã€‚</li>
</ul>

<p>ç°åœ¨å¯ä»¥æ‰“å¼€ <a href="http://localhost:9999/">http://localhost:9999/</a> äº†ã€‚</p>

<blockquote>
  <p>æ²¡æœ‰ IDE çš„ä»£ç æç¤ºï¼Œæ¯”è¾ƒç—›è‹¦ã€‚ä¸è¿‡ï¼Œè€å¤«æ˜¯ä¸€æŠŠæ¢­ï¼Œä¸€è°·æ­Œï¼Œä¸€å‰ªåˆ€æå®šä¸€åˆ‡ã€‚</p>
</blockquote>]]></content><author><name>å•¤é…’äº‘</name></author><category term="devops," /><category term="container," /><category term="argocd" /><summary type="html"><![CDATA[ä½¿ç”¨ ArgoCD å¯ä»¥æœ‰æ•ˆè§£è€¦ CI å’Œ CDã€‚ æƒ³è±¡è¿™ä¸ªåœºæ™¯ï¼šå½“ CI æµç¨‹å°†æ„å»ºç‰©æ‰“åŒ…å®Œæˆï¼Œå¹¶æ›´æ–°äº† Git éƒ¨ç½²ä»“åº“ï¼Œæ­¤æ—¶ CI æµç¨‹å‘é€šçŸ¥ç»™ç›¸å…³æœ‰å®¡æ‰¹äººå‘˜ï¼Œå®¡æ‰¹è€…é€šè¿‡ç‚¹å‡»é“¾æ¥å°±å¯ä»¥å®Œæˆéƒ¨ç½²ã€‚ è™½ç„¶å¯ä»¥é€šè¿‡ç™»å½• Argo CD çš„ UI ç•Œé¢å¯ä»¥å®Œæˆæ­¤æ“ä½œï¼Œä½†æ„Ÿè§‰è¿˜ä¸å¤Ÿä¸æ»‘ã€‚]]></summary></entry><entry><title type="html">è‡ªåŠ¨åŒ–æ„å»ºå¤šæ¶æ„(amd, arm)é•œåƒ</title><link href="https://youbug.cn/2022/12/buildx-multi-arch-images.html" rel="alternate" type="text/html" title="è‡ªåŠ¨åŒ–æ„å»ºå¤šæ¶æ„(amd, arm)é•œåƒ" /><published>2022-12-20T09:40:33+00:00</published><updated>2022-12-20T09:40:33+00:00</updated><id>https://youbug.cn/2022/12/buildx-multi-arch-images</id><content type="html" xml:base="https://youbug.cn/2022/12/buildx-multi-arch-images.html"><![CDATA[<p>ç°åœ¨å¾ˆå¤šè½¯ä»¶å‘è¡Œçš„ Docker é•œåƒéƒ½ä¼šæ”¯æŒå¤šæ¶æ„ï¼ŒDocker å®˜æ–¹ä¹Ÿæœ‰æ•™ç¨‹æ•™å¤§å®¶å¦‚ä½•å®ç°ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ª buildx æ’ä»¶æ–¹ä¾¿å¤§å®¶å®ç°ã€‚æœ¬æ–‡ä½¿ç”¨ Gitlab CI è¯•äº†ä¸€ä¸‹æ­¤æ’ä»¶ï¼Œä¸»è¦å‘½ä»¤æ˜¯ <code class="language-plaintext highlighter-rouge">docker buildx build --platform...</code>ã€‚</p>

<h2 id="æ£€æŸ¥-docker-ç¯å¢ƒ">æ£€æŸ¥ docker ç¯å¢ƒ</h2>

<p>æ£€æŸ¥å®˜æ–¹çš„ docker 20 çš„é•œåƒï¼Œè¿è¡Œ docker info æŸ¥çœ‹ Pluginsï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker info
Client:
 Context:    default
 Debug Mode: <span class="nb">false
 </span>Plugins:
  buildx: Docker Buildx <span class="o">(</span>Docker Inc., v0.9.1<span class="o">)</span>
  compose: Docker Compose <span class="o">(</span>Docker Inc., v2.14.1<span class="o">)</span>
...
</code></pre></div></div>

<p>å·²ç»å†…ç½®äº† buildx æ’ä»¶ã€‚</p>

<h2 id="gitlab-ci-è„šæœ¬">Gitlab CI è„šæœ¬</h2>

<h3 id="æ„å»ºåˆ°å®˜æ–¹ä»“åº“-docker-hub">æ„å»ºåˆ°å®˜æ–¹ä»“åº“ docker hub</h3>

<p>ä¸‹é¢çš„ç¤ºä¾‹ build äº†ä¸€ä¸ª arm64 + amd64 çš„è£¸ JDKã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">dockerx</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">docker:20</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">DOCKER_DRIVER</span><span class="pi">:</span> <span class="s">overlay2</span>
    <span class="na">DOCKER_HOST</span><span class="pi">:</span> <span class="s">tcp://docker:2376</span>
    <span class="na">DOCKER_TLS_CERTDIR</span><span class="pi">:</span> <span class="s">/certs</span>
    <span class="na">DOCKER_TLS_VERIFY</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">DOCKER_CERT_PATH</span><span class="pi">:</span> <span class="s">/certs/client</span>
  <span class="na">services</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker:20-dind</span>
  <span class="na">before_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">until docker version &gt; /dev/null; do sleep 1; done</span>
    <span class="pi">-</span> <span class="s">echo "FROM amazoncorretto:11" &gt; Dockerfile</span>
    <span class="pi">-</span> <span class="s">docker context create xbuilder-ctx</span>
    <span class="pi">-</span> <span class="s">docker buildx create --name xbuilder --use xbuilder-ctx</span>
    <span class="pi">-</span> <span class="s">docker buildx use xbuilder</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">echo $DOCKER_PASS | docker login -u$DOCKER_USER --password-stdin</span>
    <span class="pi">-</span> <span class="s">docker buildx build --platform linux/arm64,linux/amd64 -t cloudbeer/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA --push .</span>

</code></pre></div></div>

<ul>
  <li>ä¸»è¦çš„å‘½ä»¤ä¸º <code class="language-plaintext highlighter-rouge">docker buildx build --platform linux/arm64,linux/amd64</code>ï¼Œå¯ä»¥ç›´æ¥æŒ‡å®šå¹³å°æ¶æ„ã€‚</li>
  <li>åœ¨ 19+ ç‰ˆæœ¬çš„ docker é‡Œï¼Œdocker ç”Ÿäº§çš„è¯ä¹¦éœ€è¦æ—¶é—´ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œéœ€è¦æ£€æµ‹ docker çŠ¶æ€ï¼š<code class="language-plaintext highlighter-rouge">until docker version &gt; /dev/null; do sleep 1; done</code>ï¼Œç­‰ä»–æ²¡é—®é¢˜å†è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œå¦åˆ™ä»»åŠ¡ä¼šä¸­æ–­ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">docker context, docker buildx create, docker buildx use</code> è¿™äº›è§£å†³äº† â€œ
ERROR: multiple platforms feature is currently not supported for docker driver.â€, â€œDocker buildx - could not create a builder instance with TLS data loaded from environmentâ€ è¿™äº›ä¸ªé”™è¯¯ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">docker buildx build... --push</code> ä¼šç›´æ¥æŠŠé•œåƒæ„å»ºç»“æœæ¨é€åˆ° docker hubã€‚</li>
</ul>

<p>æ„å»ºç»“æœï¼š<a href="https://hub.docker.com/r/cloudbeer/pure-ci/tags">https://hub.docker.com/r/cloudbeer/pure-ci/tags</a></p>

<p><img src="/assets/posts/devops/docker-hub-multi.png" alt="Buildx result" /></p>

<h3 id="æ¨é€åˆ°-aws-ecr">æ¨é€åˆ° AWS ECR</h3>

<p>ä½¿ç”¨ AWS çš„æœåŠ¡ï¼Œä¸€èˆ¬ç¦»ä¸å¼€ aws cliï¼Œåœ¨æœ¬åœºæ™¯ä¸­ï¼Œè¦ä¹ˆåœ¨ aws cli é•œåƒä¸­å®‰è£… dockerï¼Œè¦ä¹ˆåœ¨ docker é‡Œå®‰è£… aws cliï¼Œä¸‹é¢æ˜¯æˆ‘çš„æµ‹è¯•è„šæœ¬ï¼Œæ­¤è„šæœ¬å¯ä»¥ run åˆ°æœ€åï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">dockerx-ecr</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">amazon/aws-cli</span>
  <span class="na">variables</span><span class="pi">:</span>
    <span class="na">DOCKER_DRIVER</span><span class="pi">:</span> <span class="s">overlay2</span>
    <span class="na">DOCKER_HOST</span><span class="pi">:</span> <span class="s">tcp://docker:2376</span>
    <span class="na">DOCKER_TLS_CERTDIR</span><span class="pi">:</span> <span class="s">/certs</span>
    <span class="na">DOCKER_TLS_VERIFY</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">DOCKER_CERT_PATH</span><span class="pi">:</span> <span class="s">/certs/client</span>
  <span class="na">services</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker:dind</span>
  <span class="na">before_script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">amazon-linux-extras install docker</span>
    <span class="pi">-</span> <span class="s">mkdir -p ~/.docker/cli-plugins/</span>
    <span class="pi">-</span> <span class="s">until docker version &gt; /dev/null; do sleep 1; done</span>
    <span class="pi">-</span> <span class="s">docker container create --name buildx docker/buildx-bin sh</span>
    <span class="pi">-</span> <span class="s">docker cp buildx:/buildx ~/.docker/cli-plugins/docker-buildx</span>
    <span class="pi">-</span> <span class="s">echo "FROM amazoncorretto:11" &gt; Dockerfile</span>
    <span class="pi">-</span> <span class="s">docker context create xbuilder-ctx</span>
    <span class="pi">-</span> <span class="s">docker buildx create --name xbuilder --use xbuilder-ctx</span>
    <span class="pi">-</span> <span class="s">docker buildx use xbuilder</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $DOCKER_REGISTRY</span>
    <span class="pi">-</span> <span class="s">docker buildx build --platform linux/arm64,linux/amd64 -t $DOCKER_REGISTRY/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA --push .</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„è„šæœ¬æˆåŠŸè¿è¡Œã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€äº›å‘æ€»ç»“ï¼ˆåæ§½æ¨¡å¼å¼€å¯ï¼‰ï¼š</p>

<ul>
  <li>ä½¿ç”¨ å®˜æ–¹ docker é•œåƒä½œä¸ºåŸºç¡€é•œåƒæ„å»ºï¼Œä¼šå‘ç° awscli v2 è£…ä¸ä¸Šï¼Œ awscli v2 å®‰è£…åˆ° alpine éœ€è¦ç¼–è¯‘ï¼Œä¸æ˜¯ç®€å•åŠ å‡ ä¸ªä¾èµ–åŒ…å°±è¡Œçš„ï¼Œè¿™ä¸ªæ‡’å¾—æŠ˜è…¾äº†ã€‚</li>
  <li>ä½¿ç”¨ pip å®˜æ–¹å®‰è£…çš„ awscli v2 å±…ç„¶æ˜¯åœ¨ docker é‡Œè¿è¡Œçš„ï¼Œè¿™æ˜¯åœ¨æç¬‘å—ï¼Ÿæˆ‘æœ¬æ¥å°±æ˜¯ä¸ª dindï¼Œå¥—å¨ƒäº†å•Šã€‚</li>
  <li>ä½¿ç”¨ aws-cli é•œåƒä½œä¸ºåº•åŒ…ï¼Œ<code class="language-plaintext highlighter-rouge">amazon-linux-extras install docker</code> è¿™ä¸ªå®‰è£…çš„ docker å±…ç„¶æŠŠ plugins éƒ½å¹²æ‰äº†ã€‚å¹²æ‰ compose å¯ä»¥ç†è§£ï¼Œä¸ºå•¥æŠŠ buildx è¿™ä¹ˆå¥½çš„å·¥å…·å¹²æ‰äº†ã€‚</li>
  <li>å®‰è£… buildx æ’ä»¶ï¼Œå¯ä»¥ç›´æ¥ä» buildx é•œåƒåŒ…ä¸­æ‹·è´ï¼Œå‘½ä»¤æ˜¯ <code class="language-plaintext highlighter-rouge">docker container create</code> å’Œ <code class="language-plaintext highlighter-rouge">docker cp</code>ã€‚</li>
  <li>ä½¿ç”¨ AWS ECR åˆ«å¿˜è®°è¦å…ˆå»ºåº“ã€‚</li>
  <li>ä½¿ç”¨ AWS ECR åˆ«å¿˜è®°è¦å…ˆå»ºåº“ã€‚</li>
  <li>ä½¿ç”¨ AWS ECR åˆ«å¿˜è®°è¦å…ˆå»ºåº“ã€‚</li>
  <li><strong>æˆ‘åˆå¿˜è®°äº†ã€‚</strong></li>
</ul>

<p>æœ€ç»ˆçš„éƒ¨åˆ† log è´´åœ¨ä¸‹é¢ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nv">$ </span>aws ecr get-login-password <span class="nt">--region</span> us-east-1 | docker login <span class="nt">--username</span> AWS <span class="nt">--password-stdin</span> <span class="nv">$DOCKER_REGISTRY</span>
Login Succeeded
<span class="c">#3 transferring context: 2B done</span>
<span class="c">#3 DONE 0.1s</span>
<span class="c">#4 [linux/arm64 internal] load metadata for docker.io/library/amazoncorretto:11</span>
<span class="c">#4 DONE 2.6s</span>
<span class="c">#5 [linux/amd64 internal] load metadata for docker.io/library/amazoncorretto:11</span>
<span class="c">#5 DONE 2.6s</span>
...
<span class="c">#6 [linux/amd64 1/1] FROM docker.io/library/amazoncorretto:11@sha256:6962bc64de2b612c2a760299956853762cfcee538b1b6b55706661426546936c</span>
<span class="c">#6 DONE 0.1s</span>
<span class="c">#8 exporting to image</span>
<span class="c">#8 exporting layers done</span>
<span class="c">#8 exporting manifest sha256:3dd903be615ce4c36321b161806bc061a567079a2947ec658cdcd14d1c114235 0.0s done</span>
<span class="c">#8 exporting config sha256:8b9bb2aca3d28e14fa06412d152fd4ce6c7a55f1554bec3c71ce4a4410060af3</span>
<span class="c">#8 exporting config sha256:8b9bb2aca3d28e14fa06412d152fd4ce6c7a55f1554bec3c71ce4a4410060af3 0.0s done</span>
<span class="c">#8 exporting manifest sha256:4218135aa38e8522e988b60392190cd7bfc1715cedb3f301f82cec43fee383e2 0.0s done</span>
<span class="c">#8 exporting config sha256:de3379d966e1b03cf4c7f3c6db803f459cf1c3e887fbe2c10af9ce0c72a6f406 0.0s done</span>
<span class="c">#8 exporting manifest list sha256:dc0282c4166a58f7b8298e5061a00c02c6bce6e358000b479e49e6d73cf57b34 0.0s done</span>
<span class="c">#8 pushing layers</span>
<span class="c">#8 ...</span>
<span class="c">#9 [auth] sharing credentials for [MASKED].dkr.ecr.us-east-1.amazonaws.com</span>
<span class="c">#9 DONE 0.0s</span>
<span class="c">#8 exporting to image</span>
<span class="c">#8 ...</span>
<span class="c">#7 [linux/amd64 1/1] FROM docker.io/library/amazoncorretto:11@sha256:6962bc64de2b612c2a760299956853762cfcee538b1b6b55706661426546936c</span>
<span class="c">#7 sha256:74c4a50287c9345fabef12ad41b61e3450e3400fbe99f5d48281ceb781041ae3 147.75MB / 147.75MB 2.6s done</span>
<span class="c">#7 sha256:5b4a36b5b78f93a5f470cf722b313bb32cddb0f8e0fa0db348059b5c0881b04f 62.33MB / 62.33MB 1.0s done</span>
<span class="c">#7 DONE 2.9s</span>
<span class="c">#6 [linux/arm64 1/1] FROM docker.io/library/amazoncorretto:11@sha256:6962bc64de2b612c2a760299956853762cfcee538b1b6b55706661426546936c</span>
<span class="c">#6 sha256:c0aade9a94f7c23d8fc79b4c11ce14d37b8569a6fec3017a295169ff500ec8d8 144.91MB / 144.91MB 2.9s</span>
<span class="c">#6 sha256:6cbfee25f0741b3d3f4d2474d904a200cd8404a01aa17813bf3fc3d4ebb551a4 63.96MB / 63.96MB 1.8s done</span>
<span class="c">#6 sha256:c0aade9a94f7c23d8fc79b4c11ce14d37b8569a6fec3017a295169ff500ec8d8 144.91MB / 144.91MB 3.0s done</span>
<span class="c">#6 DONE 3.1s</span>
<span class="c">#8 exporting to image</span>
<span class="c">#8 pushing layers 17.6s done</span>
<span class="c">#8 pushing manifest for [MASKED].dkr.ecr.us-east-1.amazonaws.com/pure-ci:1ac460d1@sha256:dc0282c4166a58f7b8298e5061a00c02c6bce6e358000b479e49e6d73cf57b34</span>
<span class="c">#8 pushing manifest for [MASKED].dkr.ecr.us-east-1.amazonaws.com/pure-ci:1ac460d1@sha256:dc0282c4166a58f7b8298e5061a00c02c6bce6e358000b479e49e6d73cf57b34 2.2s done</span>
<span class="c">#8 DONE 19.8s</span>
Job succeeded
</code></pre></div></div>

<p>è¯·å¿½ç•¥ ECR Web æ§åˆ¶å°çš„æ˜¾ç¤ºæ–¹å¼ã€‚</p>

<h2 id="ä¸æ˜¯æœ¬æ–‡çš„æ€»ç»“">ä¸æ˜¯æœ¬æ–‡çš„æ€»ç»“</h2>

<ul>
  <li>ä½¿ç”¨ docker-buildx ä¼šç›´æ¥ä½¿ç”¨ç›¸åº”æ¶æ„çš„åº•å±‚ä¾èµ–é•œåƒï¼Œå¦‚æœä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæ‚¨ä¸èƒ½å°†ä¸€ä¸ªæœ‰æ¶æ„ä¾èµ–çš„å¯æ‰§è¡Œæ–‡ä»¶ç›´æ¥æ‹·è´æ„å»ºé•œåƒï¼Œå¦åˆ™ä¼šå‡ºç°åº•å±‚åŒ…å’Œä¸šåŠ¡åŒ…å¯¹ä¸ä¸Šçš„é—®é¢˜ã€‚</li>
  <li>å¯ä»¥å°†æ„å»ºè¿‡ç¨‹æ”¾åˆ° Dockerfile é‡Œé¢å»ï¼ŒDocker æœ‰å®Œæ•´çš„å¤šé˜¶æ®µæ„å»ºçš„æ¨¡å¼æ¥ç”Ÿäº§æ‚¨çš„é•œåƒï¼ˆå¦‚ go è¯­è¨€ï¼‰ã€‚</li>
  <li>å¯¹äºè„šæœ¬ç±»å‹çš„è¯­è¨€ï¼Œå®Œå…¨å¯ä»¥ç”¨è¿™ç§æ–¹å¼æ„å»ºï¼Œä¾èµ–åŒ…å®‰è£…ä¹Ÿåº”è¯¥åœ¨ Dockerfile ä¸­è¿›è¡Œã€‚</li>
  <li>Java çš„æ™®é€šè¿è¡ŒåŒ…å¯ä»¥ä½¿ç”¨ç›´æ¥æ‹·è´çš„æ–¹å¼ï¼ŒX86 ç¯å¢ƒä¸‹æ„å»ºçš„ jar åŒ…å¯ä»¥ç›´æ¥è¿è¡Œåœ¨ ARM çš„ jdk ä¸­ã€‚</li>
  <li>Dockerfile çš„åº•åŒ…ä¹Ÿåº”è¯¥æ˜¯å¤šæ¶æ„çš„ï¼Œè¯·ä¸è¦å¼ºåˆ¶æŒ‡å®šå…·ä½“çš„ digest å€¼ã€‚</li>
</ul>]]></content><author><name>å•¤é…’äº‘</name></author><category term="devops," /><category term="container," /><category term="tucao," /><category term="gitlab" /><summary type="html"><![CDATA[ç°åœ¨å¾ˆå¤šè½¯ä»¶å‘è¡Œçš„ Docker é•œåƒéƒ½ä¼šæ”¯æŒå¤šæ¶æ„ï¼ŒDocker å®˜æ–¹ä¹Ÿæœ‰æ•™ç¨‹æ•™å¤§å®¶å¦‚ä½•å®ç°ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ª buildx æ’ä»¶æ–¹ä¾¿å¤§å®¶å®ç°ã€‚æœ¬æ–‡ä½¿ç”¨ Gitlab CI è¯•äº†ä¸€ä¸‹æ­¤æ’ä»¶ï¼Œä¸»è¦å‘½ä»¤æ˜¯ docker buildx build --platform...ã€‚]]></summary></entry></feed>